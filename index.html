<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KOC 3D Facility – X-tree</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
      background: #050814;
    }

    #canvas-container {
      position: fixed;
      inset: 0;
    }

    #info-panel {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 320px;
      max-width: 90vw;
      background: rgba(10, 13, 30, 0.95);
      border-radius: 12px;
      padding: 12px 14px;
      color: #f5f5f5;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 18px 45px rgba(0,0,0,0.5);
      font-size: 12px;
      z-index: 10;
    }

    #info-panel h1 {
      font-size: 15px;
      margin-bottom: 6px;
    }

    #info-panel .facility-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
      background: rgba(120, 180, 255, 0.12);
    }

    #info-panel p {
      margin-bottom: 4px;
      line-height: 1.4;
    }

    #info-panel .label {
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.7;
    }

    #info-panel small {
      display: block;
      margin-top: 6px;
      opacity: 0.6;
      font-size: 10px;
    }

    #hud {
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(8, 12, 30, 0.85);
      color: #e5e5e5;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    #hud .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #34d399;
      box-shadow: 0 0 6px #34d399;
    }

    #hud span {
      opacity: 0.8;
    }

    #hint {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.55);
      color: #f9fafb;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="canvas-container"></div>

  <div id="hud">
    <div class="dot"></div>
    <span id="hud-facility">Facility: Overview</span>
  </div>

  <div id="info-panel">
    <h1>Tap any unit in the facility</h1>
    <div class="facility-tag">No equipment selected</div>
    <p>Use one finger to rotate, two fingers to zoom / move.</p>
    <p>اضغط على أي بلوك في المنشأة لعرض تفاصيله.</p>
    <small>Training Mode – Draft layout for KOC Gathering Center facility.</small>
  </div>

  <div id="hint">
    Rotate: drag | Zoom: pinch / scroll | Move: two-finger drag | Select: tap
  </div>

  <!-- كود اللعبة مع استيراد محلي -->
  <script type="module">
    import * as THREE from './three.module.js';
    import { OrbitControls } from './OrbitControls.js';

    const container   = document.getElementById('canvas-container');
    const infoPanel   = document.getElementById('info-panel');
    const facilityTag = infoPanel.querySelector('.facility-tag');
    const hudFacility = document.getElementById('hud-facility');

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020617);

    const camera = new THREE.PerspectiveCamera(
      60,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 60, 90);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.target.set(0, 5, 0);
    controls.update();

    const ambient = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambient);

    const dir = new THREE.DirectionalLight(0xffffff, 1.6);
    dir.position.set(40, 80, 40);
    scene.add(dir);

    const groundGeo = new THREE.PlaneGeometry(220, 220);
    const groundMat = new THREE.MeshStandardMaterial({
      color: 0x020617,
      roughness: 1,
      metalness: 0
    });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    const grid = new THREE.GridHelper(220, 22, 0x4b5563, 0x1f2937);
    scene.add(grid);

    const equipmentData = {
      "tv_cru_block": {
        name: "TV Compression Facility (CRU + TV Comp)",
        type: "Process Area",
        facility: "TV Compression",
        description: "منطقة ضغط الغاز الثقيل (Tank Vapor) عن طريق CRU والـ TV Compressor.",
        keyPoints: [
          "Reciprocating Compressor داخل الـ CRU.",
          "تحويل الغاز الساخن إلى Condensate بعد التبريد.",
          "تخفيض الفلير في الـ GC."
        ]
      },
      "tv_recip_comp": {
        name: "Reciprocating Compressor – CRU",
        type: "Positive Displacement Compressor",
        facility: "TV Compression",
        description: "يسحب TV Gas من الخزانات ويضغطه إلى ضغط أعلى.",
        keyPoints: [
          "Suction من خط TV Gas بضغط منخفض.",
          "Piston + Cylinder.",
          "لا يُشغَّل ضد Discharge مغلق."
        ]
      },
      "ddp_block": {
        name: "Wet Oil Treatment Facility (DDP)",
        type: "Process Area",
        facility: "DDP / Desalter",
        description: "منطقة نزع الماء والأملاح من النفط الرطب قبل التصدير.",
        keyPoints: [
          "تعالج Emulsion (نفط + ماء + أملاح).",
          "Electric Field + Wash Water.",
          "تقليل الـ Corrosion."
        ]
      },
      "ddp_feed_pump": {
        name: "Desalter Feed Pump",
        type: "Centrifugal Pump",
        facility: "DDP / Desalter",
        description: "مضخة طاردة مركزية تغذي الـ Desalter بالنفط الرطب.",
        keyPoints: [
          "High-flow Impeller.",
          "ضغط متوسط داخل DDP.",
          "تجنّب Cavitation."
        ]
      },
      "main_plant_block": {
        name: "Main Plant",
        type: "Process Area",
        facility: "Main Plant",
        description: "القلب الرئيسي للـ GC لفصل Oil/Gas/Water وتنظيم الضغط.",
        keyPoints: [
          "Valves ميكانيكية وPneumatic وMOV.",
          "Oil & Gas manifolds.",
          "ربط Wells وDDP وTV Comp وTransit."
        ]
      },
      "main_gate_valve": {
        name: "Main Oil Line Gate Valve",
        type: "Mechanical Valve – Gate",
        facility: "Main Plant",
        description: "Gate Valve على خط نفط رئيسي للإيقاف أو الفتح الكامل.",
        keyPoints: [
          "غير مناسب لنصف فتح.",
          "حركة خطية.",
          "يستخدم في خطوط high-pressure."
        ]
      },
      "transit_block": {
        name: "Crude Oil Transit Facility",
        type: "Process Area",
        facility: "Transit",
        description: "ضخ النفط الجاف من الخزانات إلى خطوط الترانزيت.",
        keyPoints: [
          "Booster + Main Transit Pumps.",
          "جزء من شبكة نقل النفط.",
          "يعتمد على مستوى Dry Tank."
        ]
      },
      "transit_dry_tank": {
        name: "Dry Tank",
        type: "Storage Tank",
        facility: "Transit",
        description: "خزان نفط جاف يغذي Suction Header لمضخات الترانزيت.",
        keyPoints: [
          "Equalizing line.",
          "LSLL لحماية المضخات.",
          "Outlet 12\" إلى 30\" Header."
        ]
      },
      "transit_pump": {
        name: "Turbine Driven Transit Pump",
        type: "Centrifugal Pump + Gas Turbine",
        facility: "Transit",
        description: "مضخة تصدير رئيسية تضخ النفط إلى خطوط الترانزيت.",
        keyPoints: [
          "Booster Pump على السحب.",
          "Discharge عالي.",
          "Recycle line + NRV."
        ]
      }
    };

    const selectableMeshes = [];

    function createFacilityZone(label, color, position) {
      const geo = new THREE.BoxGeometry(26, 3, 26);
      const mat = new THREE.MeshStandardMaterial({
        color,
        roughness: 0.4,
        metalness: 0.3
      });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.position.copy(position);
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      scene.add(mesh);
      return mesh;
    }

    function createEquipmentBox(id, color, position, size = {x:4, y:2, z:4}) {
      const geo = new THREE.BoxGeometry(size.x, size.y, size.z);
      const mat = new THREE.MeshStandardMaterial({
        color,
        roughness: 0.3,
        metalness: 0.5
      });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.position.copy(position);
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      mesh.userData.equipmentId = id;
      scene.add(mesh);
      selectableMeshes.push(mesh);
      return mesh;
    }

    createFacilityZone("TV Compression", 0x22d3ee, new THREE.Vector3(-40, 1.5, -40));
    createFacilityZone("DDP / Desalter", 0x4ade80, new THREE.Vector3( 40, 1.5, -40));
    createFacilityZone("Main Plant",      0xf97316, new THREE.Vector3(-40, 1.5,  40));
    createFacilityZone("Transit",         0x818cf8, new THREE.Vector3( 40, 1.5,  40));

    createEquipmentBox("tv_cru_block",    0x06b6d4, new THREE.Vector3(-40, 3, -40));
    createEquipmentBox("tv_recip_comp",   0x0ea5e9, new THREE.Vector3(-46, 3, -36), {x:5,y:2,z:3});

    createEquipmentBox("ddp_block",       0x16a34a, new THREE.Vector3(40, 3, -40));
    createEquipmentBox("ddp_feed_pump",   0x22c55e, new THREE.Vector3(46, 2.5, -36), {x:5,y:1.5,z:3});

    createEquipmentBox("main_plant_block",0xf97316, new THREE.Vector3(-40, 3, 40));
    createEquipmentBox("main_gate_valve", 0xfacc15, new THREE.Vector3(-46, 2.3, 36), {x:3,y:1.3,z:3});

    createEquipmentBox("transit_block",   0x4f46e5, new THREE.Vector3(40, 3, 40));
    createEquipmentBox("transit_dry_tank",0x38bdf8, new THREE.Vector3(46, 3.5, 36), {x:5,y:3,z:5});
    createEquipmentBox("transit_pump",    0x6366f1, new THREE.Vector3(34, 2.5, 36), {x:5,y:1.8,z:3});

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    function setEquipmentInfo(equipId) {
      const data = equipmentData[equipId];
      if (!data) return;

      infoPanel.querySelector('h1').textContent = data.name;
      facilityTag.textContent = data.facility + " · " + data.type;

      const ps = infoPanel.querySelectorAll('p');
      ps[0].innerHTML = "<span class='label'>Description</span><br>" + data.description;
      ps[1].innerHTML = "<span class='label'>Key Points</span><br>• " + data.keyPoints.join("<br>• ");

      hudFacility.textContent = "Facility: " + data.facility;
    }

    function onClick(event) {
      const rect = renderer.domElement.getBoundingClientRect();
      const x = (event.clientX - rect.left) / rect.width;
      const y = (event.clientY - rect.top)  / rect.height;

      mouse.x =  x * 2 - 1;
      mouse.y = -y * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(selectableMeshes, false);

      if (intersects.length > 0) {
        const picked = intersects[0].object;
        const id = picked.userData.equipmentId;
        if (id) setEquipmentInfo(id);
      }
    }

    renderer.domElement.addEventListener('click', onClick);

    window.addEventListener('resize', () => {
      const w = window.innerWidth;
      const h = window.innerHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    });

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
