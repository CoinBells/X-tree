<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Oilfield Explorer Training</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #020617;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #f9fafb;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      direction: rtl;
      overflow: hidden;
    }

    #game-container {
      width: 100%;
      max-width: 1180px;
      height: 90vh;
      max-height: 700px;
      border-radius: 18px;
      border: 3px solid #1d4ed8;
      overflow: hidden;
      position: relative;
      box-shadow: 0 20px 40px rgba(0,0,0,0.8);
      background: #020617;
    }

    #canvas {
      width: 100%;
      height: 100%;
      display: block;
      background: linear-gradient(#7cc3ff 0%, #cde9ff 40%, #f7d9a0 40%, #f0c27b 100%);
      cursor: crosshair;
    }

    #hud-bar {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.92);
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
      white-space: nowrap;
    }

    #hud-bar span {
      opacity: 0.9;
    }

    #hint {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(15,23,42,0.92);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 10px;
      border: 1px solid rgba(148,163,184,0.4);
      max-width: 220px;
    }

    #inspection-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      width: 310px;
      background: radial-gradient(circle at top, #020617, #020617 60%, #040b1a 100%);
      border-radius: 18px;
      border: 2px solid #1d4ed8;
      padding: 12px 14px;
      box-shadow: 0 22px 40px rgba(0,0,0,0.9);
      display: none;
      font-size: 12px;
      z-index: 5;
    }

    #inspection-panel.show {
      display: block;
      animation: pop 0.16s ease-out forwards;
    }

    @keyframes pop {
      from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    #inspection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    #inspection-header h3 {
      font-size: 14px;
    }

    #close-panel {
      border: none;
      background: #ef4444;
      color: #fff;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      cursor: pointer;
    }

    #inspection-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }

    .gbox {
      background: #020617;
      border-radius: 12px;
      padding: 6px;
      border: 1px solid #1f2937;
    }

    .gbox-label {
      font-size: 11px;
      opacity: 0.85;
    }

    .gbox-value {
      font-size: 15px;
      font-weight: 700;
      margin-top: 2px;
      text-shadow: 0 0 6px rgba(59,130,246,0.9);
    }

    .tag {
      display: inline-block;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      margin-top: 3px;
    }
    .tag-ok { background: rgba(22,163,74,0.2); color: #bbf7d0; border: 1px solid #22c55e; }
    .tag-bad { background: rgba(248,113,113,0.16); color: #fecaca; border: 1px solid #f87171; }

    #inspection-footer {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #inspection-footer button {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
    }

    #btn-open {
      background: linear-gradient(90deg, #38bdf8, #6366f1);
      color: white;
    }

    #btn-clean {
      background: linear-gradient(90deg, #22c55e, #a3e635);
      color: #052e16;
    }

    #btn-clean.disabled {
      filter: grayscale(0.8);
      opacity: 0.6;
      cursor: default;
    }

    #log-box {
      position: absolute;
      left: 10px;
      bottom: 10px;
      width: 260px;
      max-height: 110px;
      overflow-y: auto;
      background: rgba(15,23,42,0.9);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 10px;
      border: 1px solid rgba(148,163,184,0.4);
    }

    #log-box h4 {
      font-size: 11px;
      margin-bottom: 4px;
    }

    #log {
      max-height: 86px;
      overflow-y: auto;
    }

    #log p {
      margin-bottom: 2px;
    }

    @media (max-width: 900px) {
      #game-container {
        width: 100%;
        height: 100vh;
        max-height: none;
        border-radius: 0;
      }

      #log-box {
        width: 230px;
      }

      #hud-bar {
        font-size: 9px;
      }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="canvas"></canvas>

    <div id="hud-bar">
      <span>التحكم: الأسهم أو A/D للمشي – Space قفز – E فحص البئر – C تنظيف الـ blockage بعد الفتح</span>
    </div>

    <div id="hint">
      أنت عامل في حقل نفطي مفتوح. امشِ في الحقل وابحث عن الآبار، اقترب من أي بئر حتى يظهر لك
      <strong>اضغط E لفحص البئر</strong> ثم ابدأ التدريب.
    </div>

    <div id="log-box">
      <h4>Log</h4>
      <div id="log"></div>
    </div>

    <div id="inspection-panel">
      <div id="inspection-header">
        <h3 id="well-name">بئر AH-XXXX</h3>
        <button id="close-panel">X</button>
      </div>

      <div id="inspection-body">
        <div class="gbox">
          <div class="gbox-label">WHP (psi)</div>
          <div id="whp-value" class="gbox-value">---</div>
        </div>
        <div class="gbox">
          <div class="gbox-label">FLP (psi)</div>
          <div id="flp-value" class="gbox-value">---</div>
        </div>
        <div class="gbox">
          <div class="gbox-label">CASING</div>
          <div id="casing-value" class="gbox-value">Closed</div>
        </div>
        <div class="gbox">
          <div class="gbox-label">حالة البئر</div>
          <div id="state-value" class="gbox-value">غير مفحوص</div>
          <div id="state-tag" class="tag tag-ok">Normal</div>
        </div>
      </div>

      <div id="inspection-footer">
        <button id="btn-open">فتح ADJ BEAN و تقييم الحالة</button>
        <button id="btn-clean" class="disabled">تنظيف الـ blockage من ADJ BEAN</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Canvas & world setup =====
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    const worldWidth = 3600; // طول الحقل
    const worldGroundY = () => canvas.height - 80;

    // ===== Player (العامل) =====
    const player = {
      x: 200,
      y: 0,
      width: 26,
      height: 54,
      vy: 0,
      speed: 3.0,
      onGround: false
    };

    // ===== Wells (آبار متعددة مثل الحقل الحقيقي) =====
    const wells = [
      { id: "AH-0117", x: 350, blockage: true, cleaned: false },
      { id: "AH-0216", x: 950, blockage: false, cleaned: false },
      { id: "AH-0274", x: 1550, blockage: true, cleaned: false },
      { id: "AH-0287", x: 2200, blockage: true, cleaned: false },
      { id: "MG-0345", x: 2900, blockage: false, cleaned: false },
    ];

    let cameraX = 0;
    const keys = { left:false, right:false, jump:false };
    let currentWell = null; // البئر الذي نفحصه الآن
    let panelOpen = false;

    // ===== DOM elements =====
    const panel = document.getElementById("inspection-panel");
    const wellNameEl = document.getElementById("well-name");
    const whpEl = document.getElementById("whp-value");
    const flpEl = document.getElementById("flp-value");
    const casingEl = document.getElementById("casing-value");
    const stateEl = document.getElementById("state-value");
    const stateTag = document.getElementById("state-tag");
    const btnOpen = document.getElementById("btn-open");
    const btnClean = document.getElementById("btn-clean");
    const btnClose = document.getElementById("close-panel");
    const logEl = document.getElementById("log");

    function log(msg) {
      const p = document.createElement("p");
      p.textContent = msg;
      logEl.prepend(p);
    }

    // ===== Input =====
    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") keys.left = true;
      if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") keys.right = true;
      if (e.key === " " || e.key === "Spacebar") keys.jump = true;
      if (e.key === "e" || e.key === "E") tryInspect();
      if (e.key === "c" || e.key === "C") tryClean();
    });

    window.addEventListener("keyup", (e) => {
      if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") keys.left = false;
      if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") keys.right = false;
      if (e.key === " " || e.key === "Spacebar") keys.jump = false;
    });

    // ===== Physics =====
    const gravity = 0.6;
    const jumpPower = -9;

    function updatePlayer() {
      if (keys.left) player.x -= player.speed;
      if (keys.right) player.x += player.speed;

      if (player.x < 0) player.x = 0;
      if (player.x + player.width > worldWidth) player.x = worldWidth - player.width;

      if (player.onGround && keys.jump) {
        player.vy = jumpPower;
        player.onGround = false;
      }

      player.vy += gravity;
      player.y += player.vy;

      const ground = worldGroundY() - player.height;
      if (player.y >= ground) {
        player.y = ground;
        player.vy = 0;
        player.onGround = true;
      }
    }

    function updateCamera() {
      const screenCenter = canvas.width / 2;
      cameraX = player.x - screenCenter;
      if (cameraX < 0) cameraX = 0;
      if (cameraX > worldWidth - canvas.width) cameraX = worldWidth - canvas.width;
    }

    // ===== Inspection logic =====
    function getNearbyWell() {
      const range = 80;
      for (const w of wells) {
        const dx = (player.x + player.width/2) - w.x;
        if (Math.abs(dx) < range) return w;
      }
      return null;
    }

    function calcPressures(well) {
      // ترجع WHP و FLP وفقاً لحالة هذا البئر
      if (well.blockage && !well.cleaned) {
        return {
          whp: 420 + Math.floor(Math.random()*20),
          flp: 120 + Math.floor(Math.random()*15),
          state: "Blockage محتمل / مؤكد",
          bad: true
        };
      } else {
        return {
          whp: 260 + Math.floor(Math.random()*15),
          flp: 240 + Math.floor(Math.random()*15),
          state: "تدفق طبيعي",
          bad: false
        };
      }
    }

    function openPanelForWell(well) {
      currentWell = well;
      const p = calcPressures(well);

      wellNameEl.textContent = "بئر " + well.id;
      whpEl.textContent = p.whp + " psi";
      flpEl.textContent = p.flp + " psi";
      casingEl.textContent = "Closed";
      stateEl.textContent = p.state;

      if (p.bad) {
        stateTag.textContent = "Blockage";
        stateTag.className = "tag tag-bad";
        btnClean.classList.remove("disabled");
      } else {
        stateTag.textContent = "Normal";
        stateTag.className = "tag tag-ok";
        btnClean.classList.add("disabled");
      }

      panel.classList.add("show");
      panelOpen = true;
    }

    function closePanel() {
      panel.classList.remove("show");
      panelOpen = false;
    }

    function tryInspect() {
      const well = getNearbyWell();
      if (!well) {
        log("لا يوجد بئر قريب للفحص. اقترب أكثر من أحد الآبار.");
        return;
      }
      log("فحص البئر " + well.id + " ...");
      openPanelForWell(well);
    }

    function tryClean() {
      if (!currentWell || !panelOpen) return;
      if (!currentWell.blockage || currentWell.cleaned) return;

      // تنظيف
      currentWell.cleaned = true;
      log("تم تنظيف الـ blockage من البئر " + currentWell.id + " عبر ADJ BEAN.");

      const p = calcPressures(currentWell);
      whpEl.textContent = p.whp + " psi";
      flpEl.textContent = p.flp + " psi";
      stateEl.textContent = "تدفق طبيعي بعد التنظيف";
      stateTag.textContent = "Normal";
      stateTag.className = "tag tag-ok";
      btnClean.classList.add("disabled");
    }

    btnOpen.addEventListener("click", () => {
      if (!currentWell) return;
      const p = calcPressures(currentWell);
      whpEl.textContent = p.whp + " psi";
      flpEl.textContent = p.flp + " psi";
      stateEl.textContent = p.state;
      if (p.bad) {
        stateTag.textContent = "Blockage";
        stateTag.className = "tag tag-bad";
        btnClean.classList.remove("disabled");
        log("من قراءة WHP/FLP للبئر " + currentWell.id + " يظهر احتمال blockage في ADJ BEAN.");
      } else {
        stateTag.textContent = "Normal";
        stateTag.className = "tag tag-ok";
        btnClean.classList.add("disabled");
        log("قراءات البئر " + currentWell.id + " طبيعية، لا يوجد Blockage واضح.");
      }
    });

    btnClean.addEventListener("click", tryClean);
    btnClose.addEventListener("click", closePanel);

    // ===== Drawing helpers =====
    function drawBackground() {
      // سماء (سحب بسيطة)
      ctx.fillStyle = "rgba(255,255,255,0.95)";
      const clouds = [
        {x:160,y:70}, {x:520,y:60}, {x:980,y:80},
        {x:1450,y:65}, {x:2100,y:75}, {x:2700,y:55}, {x:3200,y:70}
      ];
      clouds.forEach(c => {
        const x = c.x - cameraX;
        if (x < -120 || x > canvas.width + 120) return;
        ctx.beginPath();
        ctx.arc(x, c.y, 18, Math.PI*0.5, Math.PI*1.5);
        ctx.arc(x+22, c.y-14, 22, Math.PI*1.0, Math.PI*2.0);
        ctx.arc(x+44, c.y, 18, Math.PI*1.5, Math.PI*0.5);
        ctx.fill();
      });

      // كثبان بسيطه بعيده
      ctx.fillStyle = "#e0b97d";
      ctx.beginPath();
      ctx.moveTo(-cameraX, worldGroundY()-40);
      for (let i=0;i<=worldWidth;i+=200) {
        const h = 20 + (i%400===0 ? 30:0);
        ctx.quadraticCurveTo(i - cameraX + 100, worldGroundY()-40-h, i - cameraX + 200, worldGroundY()-40);
      }
      ctx.lineTo(worldWidth - cameraX, canvas.height);
      ctx.lineTo(-cameraX, canvas.height);
      ctx.closePath();
      ctx.fill();
    }

    function drawGroundTiles() {
      const tileW = 32;
      const startY = worldGroundY();
      for (let x = -cameraX - 40; x < canvas.width + 80; x += tileW) {
        ctx.fillStyle = "#f2c58b";
        ctx.fillRect(x, startY, tileW, 80);
        ctx.strokeStyle = "rgba(0,0,0,0.05)";
        ctx.strokeRect(x, startY, tileW, 80);
      }
    }

    function drawPlayer() {
      const x = player.x - cameraX;
      const y = player.y;

      // shadow
      ctx.fillStyle = "rgba(0,0,0,0.25)";
      ctx.beginPath();
      ctx.ellipse(x + player.width/2, worldGroundY()+10, 16, 5, 0, 0, Math.PI*2);
      ctx.fill();

      // body
      ctx.fillStyle = "#fed34f";
      ctx.fillRect(x, y+14, player.width, player.height-16);
      ctx.strokeStyle = "#f59e0b";
      ctx.lineWidth = 2;
      ctx.strokeRect(x+0.5, y+14.5, player.width-1, player.height-17);

      // helmet
      ctx.fillStyle = "#fb923c";
      ctx.fillRect(x-2, y, player.width+4, 16);
      ctx.strokeStyle = "#9a3412";
      ctx.strokeRect(x-2, y, player.width+4, 16);

      // face
      ctx.fillStyle = "#fde68a";
      ctx.fillRect(x+4, y+10, player.width-8, 10);
      ctx.fillStyle = "#1e293b";
      ctx.fillRect(x+7, y+13, 2, 2);
      ctx.fillRect(x+player.width-9, y+13, 2, 2);

      // legs
      ctx.fillStyle = "#0f172a";
      ctx.fillRect(x+4, y+player.height-12, 6, 12);
      ctx.fillRect(x+player.width-10, y+player.height-12, 6, 12);
    }

    function drawWell(well) {
      const baseX = well.x - cameraX;
      const baseY = worldGroundY() - 8;
      if (baseX < -120 || baseX > canvas.width + 120) return;

      // vertical pipe
      const topY = baseY - 135;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#3b82f6";
      ctx.lineWidth = 10;
      ctx.beginPath();
      ctx.moveTo(baseX, baseY);
      ctx.lineTo(baseX, topY);
      ctx.stroke();

      // valves
      const positions = [baseY - 40, baseY - 80, baseY - 120];
      positions.forEach(y => {
        ctx.fillStyle = "#1d4ed8";
        ctx.beginPath();
        ctx.roundRect(baseX-18, y-14, 36, 28, 10);
        ctx.fill();
        ctx.strokeStyle = "#eff6ff";
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(baseX-10, y);
        ctx.lineTo(baseX+10, y);
        ctx.moveTo(baseX, y-10);
        ctx.lineTo(baseX, y+10);
        ctx.stroke();
      });

      // side arm + adj bean
      const armY = positions[1];
      ctx.strokeStyle = "#38bdf8";
      ctx.lineWidth = 8;
      ctx.beginPath();
      ctx.moveTo(baseX, armY);
      ctx.lineTo(baseX + 70, armY);
      ctx.stroke();

      const adjX = baseX + 70;
      const adjY = armY - 14;
      ctx.fillStyle = (well.blockage && !well.cleaned) ? "#f97373" : "#4ade80";
      ctx.beginPath();
      ctx.roundRect(adjX, adjY, 40, 28, 8);
      ctx.fill();
      ctx.strokeStyle = "#111827";
      ctx.lineWidth = 2;
      ctx.stroke();

      // flowline
      ctx.strokeStyle = "#60a5fa";
      ctx.lineWidth = 8;
      ctx.beginPath();
      ctx.moveTo(adjX+40, armY);
      ctx.lineTo(adjX+150, armY+10);
      ctx.stroke();

      // label فوق البئر
      ctx.fillStyle = "rgba(15,23,42,0.92)";
      ctx.beginPath();
      ctx.roundRect(baseX-38, topY-30, 76, 18, 8);
      ctx.fill();
      ctx.fillStyle = "#e5e7eb";
      ctx.font = "10px system-ui";
      ctx.textAlign = "center";
      ctx.fillText(well.id, baseX, topY-17);
      ctx.textAlign = "start";
    }

    function drawNearbyHint() {
      const well = getNearbyWell();
      if (!well) return;
      const baseX = well.x - cameraX;
      const baseY = worldGroundY() - 150;

      ctx.fillStyle = "rgba(15,23,42,0.95)";
      ctx.beginPath();
      ctx.roundRect(baseX-70, baseY-26, 140, 20, 10);
      ctx.fill();
      ctx.fillStyle = "#e5e7eb";
      ctx.font = "10px system-ui";
      ctx.textAlign = "center";
      ctx.fillText("اضغط E لفحص البئر", baseX, baseY-10);
      ctx.textAlign = "start";
    }

    // ===== Main loop =====
    function update() {
      updatePlayer();
      updateCamera();
    }

    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      drawBackground();
      drawGroundTiles();
      wells.forEach(drawWell);
      drawPlayer();
      drawNearbyHint();
    }

    function loop() {
      update();
      render();
      requestAnimationFrame(loop);
    }

    loop();
    log("ابدأ بالمشي في الحقل، اقترب من أي بئر حتى يظهر تنبيه الفحص، ثم اضغط E.");
  </script>
</body>
</html>
