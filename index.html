<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>3D Oilfield Training</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#020617;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,"Segoe UI",sans-serif;
      overflow:hidden;
      direction:rtl;
      color:#f9fafb;
    }
    #hud {
      position:fixed;
      top:8px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(15,23,42,0.9);
      border-radius:999px;
      padding:6px 14px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.5);
      z-index:5;
      white-space:nowrap;
    }
    #hint {
      position:fixed;
      bottom:10px;
      right:10px;
      background:rgba(15,23,42,0.9);
      border-radius:10px;
      padding:6px 10px;
      font-size:10px;
      border:1px solid rgba(148,163,184,0.5);
      max-width:260px;
      z-index:5;
    }
    #inspect-panel {
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%) scale(0.9);
      width:280px;
      background:radial-gradient(circle at top,#020617,#020617 60%,#040b1a 100%);
      border-radius:18px;
      border:2px solid #1d4ed8;
      padding:10px 14px;
      box-shadow:0 20px 40px rgba(0,0,0,0.9);
      display:none;
      font-size:12px;
      z-index:6;
    }
    #inspect-panel.show{display:block;animation:pop .16s ease-out forwards;}
    @keyframes pop{
      from{transform:translate(-50%,-50%) scale(.8);opacity:0;}
      to{transform:translate(-50%,-50%) scale(1);opacity:1;}
    }
    #inspect-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    #inspect-header h3{font-size:14px;}
    #close-btn{
      border:none;
      background:#ef4444;
      color:#fff;
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      cursor:pointer;
    }
    .row{
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .label{font-size:11px;opacity:.85;}
    .value{font-size:15px;font-weight:700;text-shadow:0 0 6px rgba(59,130,246,.9);}
    .tag{
      display:inline-block;
      font-size:10px;
      padding:2px 8px;
      border-radius:999px;
      margin-top:3px;
    }
    .tag-ok{background:rgba(22,163,74,.2);color:#bbf7d0;border:1px solid #22c55e;}
    .tag-bad{background:rgba(248,113,113,.16);color:#fecaca;border:1px solid #f87171;}
    #inspect-actions{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    #inspect-actions button{
      border-radius:999px;
      border:none;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
      font-weight:600;
    }
    #btn-open{background:linear-gradient(90deg,#38bdf8,#6366f1);color:#fff;}
    #btn-clean{background:linear-gradient(90deg,#22c55e,#a3e635);color:#052e16;}
    #btn-clean.disabled{filter:grayscale(.8);opacity:.6;cursor:default;}
    #log-box{
      position:fixed;
      bottom:10px;
      left:10px;
      width:260px;
      max-height:110px;
      overflow-y:auto;
      background:rgba(15,23,42,.9);
      border-radius:10px;
      padding:6px 8px;
      font-size:10px;
      border:1px solid rgba(148,163,184,.5);
      z-index:5;
    }
    #log-box h4{font-size:11px;margin-bottom:4px;}
    #log p{margin-bottom:2px;}

    /* أزرار اللمس للموبايل */
    #touch-controls{
      position:fixed;
      bottom:18px;
      right:50%;
      transform:translateX(50%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      z-index:6;
      pointer-events:auto;
    }
    .tc-row{
      display:flex;
      gap:6px;
    }
    .tc-btn{
      width:44px;
      height:44px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      font-size:18px;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,.7);
      touch-action:none;
    }
    .tc-btn:active{
      background:rgba(37,99,235,.9);
    }
    .tc-btn-small{
      width:72px;
      font-size:11px;
    }

    @media(max-width:900px){
      #hud{font-size:9px;padding:5px 10px;}
      #hint{max-width:210px;}
      #log-box{width:220px;}
    }
  </style>
</head>
<body>
  <div id="hud">
    تحكّم الكمبيوتر: W/A/S/D للمشي – الماوس لتغيير الاتجاه – E فحص – C تنظيف. على الجوال استخدم أزرار اللمس بالأسفل.
  </div>
  <div id="hint">
    تحرك في الحقل، اقترب من الآبار، ثم استخدم زر <b>E فحص</b> لعرض WHP/FLP وفتح ADJ BEAN، وزر <b>C تنظيف</b> لإزالة الـ blockage.
  </div>
  <div id="log-box">
    <h4>Log</h4>
    <div id="log"></div>
  </div>

  <!-- أزرار لمس للحركة والفحص -->
  <div id="touch-controls">
    <div class="tc-row">
      <button id="tc-up" class="tc-btn">↑</button>
    </div>
    <div class="tc-row">
      <button id="tc-left" class="tc-btn">←</button>
      <button id="tc-down" class="tc-btn">↓</button>
      <button id="tc-right" class="tc-btn">→</button>
    </div>
    <div class="tc-row">
      <button id="tc-inspect" class="tc-btn tc-btn-small">E فحص</button>
      <button id="tc-clean" class="tc-btn tc-btn-small">C تنظيف</button>
    </div>
  </div>

  <div id="inspect-panel">
    <div id="inspect-header">
      <h3 id="well-name">بئر AH-XXXX</h3>
      <button id="close-btn">X</button>
    </div>
    <div class="row">
      <div>
        <div class="label">WHP (psi)</div>
        <div id="whp-val" class="value">---</div>
      </div>
      <div>
        <div class="label">FLP (psi)</div>
        <div id="flp-val" class="value">---</div>
      </div>
    </div>
    <div class="row">
      <div>
        <div class="label">CASING</div>
        <div id="casing-val" class="value">Closed</div>
      </div>
      <div>
        <div class="label">حالة البئر</div>
        <div id="state-val" class="value">غير مفحوص</div>
        <div id="state-tag" class="tag tag-ok">Normal</div>
      </div>
    </div>
    <div id="inspect-actions">
      <button id="btn-open">فتح ADJ BEAN وقراءة الحالة</button>
      <button id="btn-clean" class="disabled">تنظيف الـ blockage من ADJ BEAN</button>
    </div>
  </div>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

  <script>
    const logEl = document.getElementById("log");
    function log(msg){
      const p=document.createElement("p");
      p.textContent=msg;
      logEl.prepend(p);
    }

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87c8ff);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    window.addEventListener("resize",()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    const hemiLight = new THREE.HemisphereLight(0xffffff,0xe0bb7f,0.8);
    scene.add(hemiLight);
    const dirLight = new THREE.DirectionalLight(0xffffff,0.8);
    dirLight.position.set(50,80,-20);
    dirLight.castShadow = true;
    scene.add(dirLight);

    const groundGeo = new THREE.PlaneGeometry(4000,4000,1,1);
    const groundMat = new THREE.MeshStandardMaterial({color:0xf0c27b});
    const ground = new THREE.Mesh(groundGeo,groundMat);
    ground.rotation.x = -Math.PI/2;
    ground.receiveShadow = true;
    scene.add(ground);

    // worker
    const workerGroup = new THREE.Group();
    const bodyGeo = new THREE.BoxGeometry(2,4,1.3);
    const bodyMat = new THREE.MeshStandardMaterial({color:0xffd54f});
    const body = new THREE.Mesh(bodyGeo,bodyMat);
    body.position.y = 3;
    workerGroup.add(body);
    const headGeo = new THREE.BoxGeometry(2,1.4,1.3);
    const headMat = new THREE.MeshStandardMaterial({color:0xffe9a9});
    const head = new THREE.Mesh(headGeo,headMat);
    head.position.y = 4.8;
    workerGroup.add(head);
    const helmetGeo = new THREE.BoxGeometry(2.3,0.8,1.6);
    const helmetMat = new THREE.MeshStandardMaterial({color:0xff9800});
    const helmet = new THREE.Mesh(helmetGeo,helmetMat);
    helmet.position.y = 5.4;
    workerGroup.add(helmet);
    workerGroup.position.set(0,0,0);
    scene.add(workerGroup);

    // wells
    function createWell(colorBase) {
      const well = new THREE.Group();
      const baseGeo = new THREE.CylinderGeometry(2,2,1,16);
      const baseMat = new THREE.MeshStandardMaterial({color:0x4b5563});
      const base = new THREE.Mesh(baseGeo,baseMat);
      base.castShadow = true;
      base.receiveShadow = true;
      well.add(base);

      const vertGeo = new THREE.CylinderGeometry(0.8,0.8,8,16);
      const vertMat = new THREE.MeshStandardMaterial({color:colorBase});
      const vert = new THREE.Mesh(vertGeo,vertMat);
      vert.position.y = 4.5;
      vert.castShadow = true;
      well.add(vert);

      const armGeo = new THREE.CylinderGeometry(0.6,0.6,5,16);
      const armMat = new THREE.MeshStandardMaterial({color:colorBase});
      const arm = new THREE.Mesh(armGeo,armMat);
      arm.rotation.z = Math.PI/2;
      arm.position.set(2.5,4.5,0);
      arm.castShadow = true;
      well.add(arm);

      const chokeGeo = new THREE.BoxGeometry(1.4,1.4,1.4);
      const chokeMat = new THREE.MeshStandardMaterial({color:0x22c55e});
      const choke = new THREE.Mesh(chokeGeo,chokeMat);
      choke.position.set(5,4.5,0);
      choke.name = "choke";
      well.add(choke);

      const flowGeo = new THREE.CylinderGeometry(0.45,0.45,7,12);
      const flowMat = new THREE.MeshStandardMaterial({color:0x93c5fd});
      const flow = new THREE.Mesh(flowGeo,flowMat);
      flow.rotation.z = Math.PI/2;
      flow.position.set(8,4.3,0.5);
      well.add(flow);

      return well;
    }

    const wellsData = [
      {id:"AH-0117", pos:new THREE.Vector3(80,0,-40), blockage:true, cleaned:false},
      {id:"AH-0216", pos:new THREE.Vector3(-120,0,-60), blockage:false, cleaned:false},
      {id:"AH-0274", pos:new THREE.Vector3(160,0,90), blockage:true, cleaned:false},
      {id:"AH-0287", pos:new THREE.Vector3(-200,0,140), blockage:true, cleaned:false},
      {id:"MG-0345", pos:new THREE.Vector3(60,0,170), blockage:false, cleaned:false}
    ];

    wellsData.forEach(w=>{
      const wellMesh = createWell(0x1d4ed8);
      wellMesh.position.copy(w.pos);
      wellMesh.userData.id = w.id;
      wellMesh.userData.blockage = w.blockage;
      wellMesh.userData.cleaned = w.cleaned;
      scene.add(wellMesh);
      w.mesh = wellMesh;
    });

    // camera + movement
    let yaw = 0;
    let pitch = 0;
    const keys = {w:false,a:false,s:false,d:false};

    window.addEventListener("keydown",e=>{
      if(e.code==="KeyW") keys.w=true;
      if(e.code==="KeyS") keys.s=true;
      if(e.code==="KeyA") keys.a=true;
      if(e.code==="KeyD") keys.d=true;
      if(e.code==="KeyE") inspectNearest();
      if(e.code==="KeyC") cleanCurrent();
    });
    window.addEventListener("keyup",e=>{
      if(e.code==="KeyW") keys.w=false;
      if(e.code==="KeyS") keys.s=false;
      if(e.code==="KeyA") keys.a=false;
      if(e.code==="KeyD") keys.d=false;
    });

    let isPointerDown=false;
    window.addEventListener("mousedown",()=>{isPointerDown=true;});
    window.addEventListener("mouseup",()=>{isPointerDown=false;});
    window.addEventListener("mousemove",e=>{
      if(!isPointerDown) return;
      yaw -= e.movementX*0.003;
      pitch -= e.movementY*0.003;
      const lim = Math.PI/3;
      if(pitch>lim)pitch=lim;
      if(pitch<-lim)pitch=-lim;
    });

    function updatePlayer(delta){
      const dir = new THREE.Vector3();
      if(keys.w) dir.z -= 1;
      if(keys.s) dir.z += 1;
      if(keys.a) dir.x -= 1;
      if(keys.d) dir.x += 1;
      if(dir.lengthSq()>0){
        dir.normalize();
        const rot = new THREE.Matrix4().makeRotationY(yaw);
        dir.applyMatrix4(rot);
        const speed = 40 * delta;
        workerGroup.position.addScaledVector(dir,speed);
      }
      workerGroup.position.y = 0;

      const camOffset = new THREE.Vector3(0,10,20);
      const rot = new THREE.Matrix4().makeRotationY(yaw);
      camOffset.applyMatrix4(rot);
      camera.position.copy(workerGroup.position).add(camOffset);
      camera.lookAt(workerGroup.position.clone().add(new THREE.Vector3(0,4,0)));
    }

    // HUD logic
    const panel = document.getElementById("inspect-panel");
    const wellNameEl = document.getElementById("well-name");
    const whpEl = document.getElementById("whp-val");
    const flpEl = document.getElementById("flp-val");
    const casingEl = document.getElementById("casing-val");
    const stateEl = document.getElementById("state-val");
    const stateTag = document.getElementById("state-tag");
    const btnOpen = document.getElementById("btn-open");
    const btnClean = document.getElementById("btn-clean");
    const btnClose = document.getElementById("close-btn");

    let currentWell = null;

    function calcPressures(w){
      if(w.userData.blockage && !w.userData.cleaned){
        return {
          whp:420+Math.floor(Math.random()*20),
          flp:120+Math.floor(Math.random()*15),
          bad:true,
          text:"Blockage محتمل / مؤكد"
        };
      } else {
        return {
          whp:260+Math.floor(Math.random()*15),
          flp:240+Math.floor(Math.random()*15),
          bad:false,
          text:"تدفق طبيعي"
        };
      }
    }

    function showPanel(w){
      currentWell = w;
      const p = calcPressures(w);
      wellNameEl.textContent = "بئر "+ w.userData.id;
      whpEl.textContent = p.whp + " psi";
      flpEl.textContent = p.flp + " psi";
      casingEl.textContent = "Closed";
      stateEl.textContent = p.text;
      if(p.bad){
        stateTag.textContent = "Blockage";
        stateTag.className = "tag tag-bad";
        btnClean.classList.remove("disabled");
      }else{
        stateTag.textContent = "Normal";
        stateTag.className = "tag tag-ok";
        btnClean.classList.add("disabled");
      }
      panel.classList.add("show");
    }
    function hidePanel(){
      panel.classList.remove("show");
      currentWell = null;
    }

    function nearestWell(){
      let best = null;
      let bestDist = 9999;
      const pPos = workerGroup.position;
      wellsData.forEach(w=>{
        const d = pPos.distanceTo(w.mesh.position);
        if(d<bestDist){
          bestDist = d;
          best = w.mesh;
        }
      });
      if(bestDist<25) return best;
      return null;
    }

    function inspectNearest(){
      const w = nearestWell();
      if(!w){
        log("لا يوجد بئر قريب للفحص، اقترب أكثر من أحد الآبار.");
        return;
      }
      log("فحص البئر "+w.userData.id+" ...");
      showPanel(w);
    }

    function cleanCurrent(){
      if(!currentWell) return;
      if(!currentWell.userData.blockage || currentWell.userData.cleaned) return;
      currentWell.userData.cleaned = true;
      log("تم تنظيف الـ blockage من ADJ BEAN للبئر "+currentWell.userData.id);
      const choke = currentWell.getObjectByName("choke");
      if(choke) choke.material.color.set(0x22c55e);
      const p = calcPressures(currentWell);
      whpEl.textContent = p.whp + " psi";
      flpEl.textContent = p.flp + " psi";
      stateEl.textContent = "تدفق طبيعي بعد التنظيف";
      stateTag.textContent = "Normal";
      stateTag.className = "tag tag-ok";
      btnClean.classList.add("disabled");
    }

    btnOpen.addEventListener("click",()=>{
      if(!currentWell) return;
      const p = calcPressures(currentWell);
      whpEl.textContent = p.whp + " psi";
      flpEl.textContent = p.flp + " psi";
      stateEl.textContent = p.text;
      if(p.bad){
        stateTag.textContent = "Blockage";
        stateTag.className = "tag tag-bad";
        btnClean.classList.remove("disabled");
        log("قراءة WHP/FLP للبئر "+currentWell.userData.id+" تشير إلى Blockage محتمل.");
      }else{
        stateTag.textContent = "Normal";
        stateTag.className = "tag tag-ok";
        btnClean.classList.add("disabled");
        log("قراءة WHP/FLP للبئر "+currentWell.userData.id+" طبيعية.");
      }
    });
    btnClean.addEventListener("click",cleanCurrent);
    btnClose.addEventListener("click",hidePanel);

    log("كمبيوتر: W/A/S/D + ماوس. موبايل: استخدم الأسهم أسفل الشاشة للحركة وأزرار E/C للفحص والتنظيف.");

    // touch controls → تعدّل نفس مفاتيح الحركة keys.w/a/s/d
    function bindTouch(btnId, keyProp){
      const btn = document.getElementById(btnId);
      if(!btn) return;
      const start = (e)=>{ e.preventDefault(); keys[keyProp] = true; };
      const end   = (e)=>{ e.preventDefault(); keys[keyProp] = false; };
      btn.addEventListener("touchstart", start, {passive:false});
      btn.addEventListener("touchend", end, {passive:false});
      btn.addEventListener("touchcancel", end, {passive:false});
      // دعم الضغط بالموس للكمبيوتر أيضاً
      btn.addEventListener("mousedown", start);
      window.addEventListener("mouseup", end);
    }
    bindTouch("tc-up","w");
    bindTouch("tc-down","s");
    bindTouch("tc-left","a");
    bindTouch("tc-right","d");

    document.getElementById("tc-inspect").addEventListener("touchstart", e=>{e.preventDefault();inspectNearest();});
    document.getElementById("tc-clean").addEventListener("touchstart", e=>{e.preventDefault();cleanCurrent();});
    // للكمبيوتر بالماوس
    document.getElementById("tc-inspect").addEventListener("click", inspectNearest);
    document.getElementById("tc-clean").addEventListener("click", cleanCurrent);

    // animation
    let last = performance.now();
    function animate(now){
      const delta = (now - last)/1000;
      last = now;
      updatePlayer(delta);
      renderer.render(scene,camera);
      requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
  </script>
</body>
</html>
