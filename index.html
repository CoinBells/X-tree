<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Oilfield Training – Switch Style</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:#0f172a;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:#0f172a;
      overflow:hidden;
      direction:rtl;
    }
    #layout{
      display:flex;
      width:100vw;
      height:100vh;
    }
    #game-wrapper{
      flex:1 1 auto;
      position:relative;
      background:radial-gradient(circle at top,#60a5fa,#0f172a 55%);
    }
    #three-container{
      position:absolute;
      inset:0;
    }
    /* HUD أعلى الشاشة */
    #hud{
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(15,23,42,0.92);
      color:#e5e7eb;
      border-radius:999px;
      padding:6px 14px;
      font-size:11px;
      border:1px solid rgba(148,163,184,.45);
      white-space:nowrap;
      z-index:5;
      box-shadow:0 8px 18px rgba(0,0,0,.35);
    }
    #hint{
      position:absolute;
      bottom:10px;
      right:10px;
      background:rgba(15,23,42,0.92);
      color:#e5e7eb;
      border-radius:14px;
      padding:8px 12px;
      font-size:11px;
      border:1px solid rgba(148,163,184,.45);
      max-width:260px;
      z-index:5;
      box-shadow:0 8px 18px rgba(0,0,0,.35);
    }
    /* أزرار لمس – ستايل نينتندو ناعم */
    #touch-controls{
      position:absolute;
      bottom:16px;
      left:50%;
      transform:translateX(-50%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      z-index:6;
    }
    .tc-row{display:flex;gap:8px}
    .tc-btn{
      width:54px;
      height:54px;
      border-radius:18px;
      border:none;
      background:linear-gradient(145deg,#0f172a,#1d293b);
      color:#e5e7eb;
      font-size:22px;
      box-shadow:0 8px 16px rgba(15,23,42,.7);
      touch-action:none;
      cursor:pointer;
    }
    .tc-btn:active{
      transform:translateY(1px) scale(.97);
      background:linear-gradient(145deg,#2563eb,#0f172a);
    }
    .tc-btn-small{
      width:96px;
      font-size:13px;
    }

    /* لوحة جانبية – ألوان ناعمة */
    #ui-panel{
      width:340px;
      max-width:40vw;
      background:linear-gradient(180deg,#e0f2fe,#eff6ff);
      border-left:3px solid #60a5fa;
      display:flex;
      flex-direction:column;
      padding:14px 12px;
      gap:10px;
      box-shadow:-10px 0 25px rgba(15,23,42,.45);
    }
    .card{
      background:#f9fafb;
      border-radius:18px;
      border:1px solid #cbd5f5;
      padding:10px 12px;
      font-size:12px;
      box-shadow:0 6px 16px rgba(148,163,184,.25);
    }
    .card h3{font-size:13px;margin-bottom:6px;color:#0f172a}
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .stat-box{
      background:#eef2ff;
      border-radius:12px;
      border:1px solid #c7d2fe;
      padding:6px 8px;
    }
    .stat-label{font-size:11px;opacity:.85;color:#1e293b}
    .stat-value{
      font-size:16px;
      font-weight:700;
      margin-top:2px;
      color:#111827;
      text-shadow:0 0 6px rgba(129,140,248,.9);
    }
    .tag{
      display:inline-block;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      margin-top:4px;
    }
    .tag-ok{
      background:#dcfce7;
      color:#166534;
      border:1px solid #22c55e;
    }
    .tag-bad{
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #f97373;
    }
    #well-name{
      font-weight:700;
      font-size:14px;
      margin-bottom:4px;
      color:#111827;
    }
    .btn{
      border-radius:999px;
      border:none;
      padding:8px 10px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      margin-top:6px;
      width:100%;
      box-shadow:0 6px 14px rgba(148,163,184,.5);
    }
    #btn-open{
      background:linear-gradient(90deg,#38bdf8,#6366f1);
      color:#f9fafb;
    }
    #btn-clean{
      background:linear-gradient(90deg,#22c55e,#a3e635);
      color:#052e16;
    }
    #btn-clean.disabled{
      filter:grayscale(.9);
      opacity:.55;
      cursor:default;
      box-shadow:none;
    }

    /* bean الواقعي */
    #bean-card{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
    }
    #bean-title{
      font-size:13px;
      font-weight:600;
      margin-bottom:2px;
      color:#111827;
    }
    #bean-visual{
      width:150px;
      height:150px;
      border-radius:50%;
      border:6px solid #94a3b8;
      box-shadow:0 0 18px rgba(15,23,42,.35) inset;
      background-color:#020617;
      background-position:center;
      background-size:cover;
      margin:4px auto 2px;
    }
    .bean-dirty{background-image:url("bean_blockage.jpg")}
    .bean-clean{background-image:url("bean_clean.jpg")}
    #bean-note{
      font-size:10px;
      opacity:.95;
      text-align:center;
      line-height:1.5;
      color:#1f2937;
    }

    #log{
      font-size:11px;
      max-height:160px;
      overflow-y:auto;
      color:#111827;
    }
    #log p{margin-bottom:3px}

    @media(max-width:900px){
      #ui-panel{width:280px;padding:10px 8px}
      #hud{font-size:9px;padding:5px 10px}
    }
  </style>
</head>
<body>
  <div id="layout">
    <div id="game-wrapper">
      <div id="three-container"></div>

      <div id="hud">
        كمبيوتر: W/S للأمام والخلف، A/D للّف – E فحص، C تنظيف. موبايل: الأسهم + أزرار الفحص والتنظيف.
      </div>
      <div id="hint">
        عالم 3D ناعم بأسلوب Pokémon على السويتش. تحرك في الصحراء، اقترب من بئر،
        ثم اضغط <b>E</b> أو زر <b>فحص</b> لقراءة WHP/FLP وفتح ADJ BEAN ورؤية الـ bean الحقيقي
        (blockage / clean) في اللوحة الجانبية.
      </div>

      <div id="touch-controls">
        <div class="tc-row">
          <button id="tc-up" class="tc-btn">↑</button>
        </div>
        <div class="tc-row">
          <button id="tc-left" class="tc-btn">←</button>
          <button id="tc-down" class="tc-btn">↓</button>
          <button id="tc-right" class="tc-btn">→</button>
        </div>
        <div class="tc-row">
          <button id="tc-inspect" class="tc-btn tc-btn-small">E فحص</button>
          <button id="tc-clean" class="tc-btn tc-btn-small">C تنظيف</button>
        </div>
      </div>
    </div>

    <aside id="ui-panel">
      <div class="card">
        <div id="well-name">لم يتم اختيار بئر</div>
        <div class="grid2">
          <div class="stat-box">
            <div class="stat-label">WHP (psi)</div>
            <div id="whp-val" class="stat-value">---</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">FLP (psi)</div>
            <div id="flp-val" class="stat-value">---</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">CASING</div>
            <div id="casing-val" class="stat-value">Closed</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">حالة البئر</div>
            <div id="state-val" class="stat-value">غير مفحوص</div>
            <div id="state-tag" class="tag tag-ok">Normal</div>
          </div>
        </div>
        <button id="btn-open" class="btn">فتح ADJ BEAN وقراءة الحالة</button>
        <button id="btn-clean" class="btn disabled">تنظيف الـ blockage من ADJ BEAN</button>
      </div>

      <div class="card" id="bean-card">
        <div id="bean-title">منظر البين من الداخل</div>
        <div id="bean-visual"></div>
        <div id="bean-note">
          عند فتح ADJ BEAN يتم عرض صورة من داخل الـ bean.<br>
          إذا كان فيه ترسبات → Blockage مثل الصورة الحقيقية، وبعد التنظيف يظهر نظيف.
        </div>
      </div>

      <div class="card">
        <h3>Training Objectives</h3>
        <ul style="padding-right:18px;line-height:1.5;">
          <li>استكشاف حقل 3D بأسلوب Pokémon والوصول لعدة آبار.</li>
          <li>قراءة WHP / FLP وتحديد وجود Blockage.</li>
          <li>رؤية البين الواقعي (مسدود / نظيف) عند فتح ADJ BEAN.</li>
          <li>تنظيف الـ blockage وملاحظة تغيّر القراءات وشكل البين.</li>
        </ul>
      </div>

      <div class="card">
        <h3>Log</h3>
        <div id="log"></div>
      </div>
    </aside>
  </div>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
    // ===== إعداد Three.js بأسلوب Pokémon (ألوان ناعمة وكاميرا مائلة) =====
    const container = document.getElementById("three-container");
    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x90c9ff, 200, 900);

    const camera = new THREE.PerspectiveCamera(
      55,
      container.clientWidth / container.clientHeight,
      0.1,
      2000
    );

    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);

    function onResize(){
      const w = container.clientWidth;
      const h = container.clientHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    }
    window.addEventListener("resize", onResize);

    // إضاءة ناعمة
    const hemi = new THREE.HemisphereLight(0xffffff, 0xf0c27b, 0.9);
    scene.add(hemi);
    const sun = new THREE.DirectionalLight(0xfff4e5, 0.9);
    sun.position.set(120, 180, -80);
    sun.castShadow = true;
    sun.shadow.mapSize.set(2048, 2048);
    scene.add(sun);

    // أرضية رملية ناعمة
    const groundGeo = new THREE.PlaneGeometry(4000, 4000, 60, 60);
    const groundMat = new THREE.MeshLambertMaterial({ color:0xf6d6a9 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI/2;
    ground.receiveShadow = true;

    // تموّجات بسيطة للرمل
    for(let i=0;i<ground.geometry.attributes.position.count;i++){
      const y = (Math.sin(i*0.13)+Math.cos(i*0.07))*0.6;
      ground.geometry.attributes.position.setY(i, y);
    }
    ground.geometry.computeVertexNormals();
    scene.add(ground);

    // بعض الأعشاب/الشجيرات
    function addBush(x,z){
      const geo = new THREE.SphereGeometry(4,12,12);
      const mat = new THREE.MeshLambertMaterial({ color:0x4ade80 });
      const m = new THREE.Mesh(geo, mat);
      m.castShadow = true;
      m.position.set(x,2.5,z);
      scene.add(m);
    }
    for(let i=0;i<18;i++){
      const x = (Math.random()-0.5)*600;
      const z = (Math.random()-0.5)*600;
      addBush(x,z);
    }

    // شخصية العامل – تشيبي (رأس كبير, جسم قصير)
    const worker = new THREE.Group();

    const bodyGeo = new THREE.CapsuleGeometry(4,6,12,18);
    const bodyMat = new THREE.MeshLambertMaterial({ color:0xffd54f });
    const body = new THREE.Mesh(bodyGeo, bodyMat);
    body.castShadow = true;
    body.position.y = 6;
    worker.add(body);

    const headGeo = new THREE.SphereGeometry(4.3,24,24);
    const headMat = new THREE.MeshLambertMaterial({ color:0xffe0b2 });
    const head = new THREE.Mesh(headGeo, headMat);
    head.castShadow = true;
    head.position.y = 11.8;
    worker.add(head);

    const helmetGeo = new THREE.SphereGeometry(4.8,24,24,0,Math.PI*2,0,Math.PI/1.6);
    const helmetMat = new THREE.MeshLambertMaterial({ color:0xfb923c });
    const helmet = new THREE.Mesh(helmetGeo, helmetMat);
    helmet.castShadow = true;
    helmet.position.y = 12.1;
    worker.add(helmet);

    const legGeo = new THREE.CylinderGeometry(1.2,1.5,4,14);
    const legMat = new THREE.MeshLambertMaterial({ color:0x1d4ed8 });
    const legL = new THREE.Mesh(legGeo, legMat);
    const legR = legL.clone();
    legL.position.set(-1.3,3.3,0);
    legR.position.set( 1.3,3.3,0);
    legL.castShadow = legR.castShadow = true;
    worker.add(legL, legR);

    worker.position.set(70,0,-40);
    scene.add(worker);

    // آبار بشكل ناعم (X-tree مبسط + ذراع choke)
    function createWell(){
      const g = new THREE.Group();

      const baseGeo = new THREE.CylinderGeometry(4,4,2,20);
      const baseMat = new THREE.MeshLambertMaterial({ color:0x4b5563 });
      const base = new THREE.Mesh(baseGeo, baseMat);
      base.position.y = 1;
      base.castShadow = true;
      base.receiveShadow = true;
      g.add(base);

      const stemGeo = new THREE.CylinderGeometry(1.6,1.6,10,20);
      const stemMat = new THREE.MeshLambertMaterial({ color:0x1d4ed8 });
      const stem = new THREE.Mesh(stemGeo, stemMat);
      stem.position.y = 7;
      stem.castShadow = true;
      g.add(stem);

      const armGeo = new THREE.CylinderGeometry(0.8,0.8,7,18);
      const arm = new THREE.Mesh(armGeo, stemMat);
      arm.rotation.z = Math.PI/2;
      arm.position.set(4,8.6,0);
      arm.castShadow = true;
      g.add(arm);

      const chokeGeo = new THREE.CapsuleGeometry(1,1.5,8,16);
      const chokeMat = new THREE.MeshLambertMaterial({ color:0x22c55e });
      const choke = new THREE.Mesh(chokeGeo, chokeMat);
      choke.position.set(8,8.6,0);
      choke.rotation.z = Math.PI/2;
      choke.castShadow = true;
      choke.name = "choke";
      g.add(choke);

      return g;
    }

    const wellsData = [
      { id:"AH-0117", pos:new THREE.Vector3(90,0,-40), blockage:true,  cleaned:false },
      { id:"AH-0216", pos:new THREE.Vector3(-70,0,-60), blockage:false, cleaned:false },
      { id:"AH-0274", pos:new THREE.Vector3(150,0,70), blockage:true,  cleaned:false },
      { id:"AH-0287", pos:new THREE.Vector3(-140,0,130), blockage:true, cleaned:false },
      { id:"MG-0345", pos:new THREE.Vector3(40,0,160),  blockage:false, cleaned:false }
    ];

    wellsData.forEach(w=>{
      const mesh = createWell();
      mesh.position.copy(w.pos);
      mesh.userData.id = w.id;
      mesh.userData.blockage = w.blockage;
      mesh.userData.cleaned  = w.cleaned;
      scene.add(mesh);
      w.mesh = mesh;
    });

    // حركة اللاعب (مشابه لألعاب بوكيمون – كاميرا مائلة خلفه)
    let yaw = 0;
    const keys = { forward:false, backward:false, left:false, right:false };

    window.addEventListener("keydown",e=>{
      if(e.code==="KeyW"||e.code==="ArrowUp")    keys.forward = true;
      if(e.code==="KeyS"||e.code==="ArrowDown")  keys.backward = true;
      if(e.code==="KeyA"||e.code==="ArrowLeft")  keys.left = true;
      if(e.code==="KeyD"||e.code==="ArrowRight") keys.right = true;
      if(e.code==="KeyE") inspectNearest();
      if(e.code==="KeyC") cleanCurrent();
    });
    window.addEventListener("keyup",e=>{
      if(e.code==="KeyW"||e.code==="ArrowUp")    keys.forward = false;
      if(e.code==="KeyS"||e.code==="ArrowDown")  keys.backward = false;
      if(e.code==="KeyA"||e.code==="ArrowLeft")  keys.left = false;
      if(e.code==="KeyD"||e.code==="ArrowRight") keys.right = false;
    });

    function bindTouch(btnId,keyName){
      const btn=document.getElementById(btnId);
      if(!btn) return;
      const start=e=>{e.preventDefault();keys[keyName]=true;};
      const end  =e=>{e.preventDefault();keys[keyName]=false;};
      btn.addEventListener("touchstart",start,{passive:false});
      btn.addEventListener("touchend",end,{passive:false});
      btn.addEventListener("touchcancel",end,{passive:false});
      btn.addEventListener("mousedown",start);
      window.addEventListener("mouseup",end);
    }
    bindTouch("tc-up","forward");
    bindTouch("tc-down","backward");
    bindTouch("tc-left","left");
    bindTouch("tc-right","right");

    document.getElementById("tc-inspect")
      .addEventListener("click",()=>inspectNearest());
    document.getElementById("tc-inspect")
      .addEventListener("touchstart",e=>{e.preventDefault();inspectNearest();});
    document.getElementById("tc-clean")
      .addEventListener("click",()=>cleanCurrent());
    document.getElementById("tc-clean")
      .addEventListener("touchstart",e=>{e.preventDefault();cleanCurrent();});

    function updatePlayer(delta){
      const turnSpeed = 2.0 * delta;
      const moveSpeed = 32  * delta;

      if(keys.left)  yaw += turnSpeed;
      if(keys.right) yaw -= turnSpeed;

      const dir = new THREE.Vector3(Math.sin(yaw),0,-Math.cos(yaw));

      if(keys.forward)  worker.position.addScaledVector(dir, moveSpeed);
      if(keys.backward) worker.position.addScaledVector(dir,-moveSpeed);

      // كاميرا مائلة مثل بوكيمون
      const camOffset = new THREE.Vector3(0,35,60);
      camOffset.applyAxisAngle(new THREE.Vector3(0,1,0),yaw);
      camera.position.copy(worker.position).add(camOffset);
      camera.lookAt(worker.position.clone().add(new THREE.Vector3(0,10,0)));
    }

    // ===== منطق التدريب وواجهة البئر =====
    const wellNameEl = document.getElementById("well-name");
    const whpEl      = document.getElementById("whp-val");
    const flpEl      = document.getElementById("flp-val");
    const casingEl   = document.getElementById("casing-val");
    const stateEl    = document.getElementById("state-val");
    const stateTag   = document.getElementById("state-tag");
    const btnOpen    = document.getElementById("btn-open");
    const btnClean   = document.getElementById("btn-clean");
    const logEl      = document.getElementById("log");
    const beanVisual = document.getElementById("bean-visual");

    let currentWell = null;

    function log(msg){
      const p=document.createElement("p");
      p.textContent=msg;
      logEl.prepend(p);
    }

    function calcPressures(w){
      if(w.userData.blockage && !w.userData.cleaned){
        return {
          whp:420+Math.floor(Math.random()*20),
          flp:120+Math.floor(Math.random()*15),
          bad:true,
          text:"Blockage محتمل / مؤكد"
        };
      }else{
        return {
          whp:260+Math.floor(Math.random()*15),
          flp:240+Math.floor(Math.random()*15),
          bad:false,
          text:"تدفق طبيعي"
        };
      }
    }

    function updateBeanVisual(w){
      beanVisual.classList.remove("bean-dirty","bean-clean");
      if(!w) return;
      if(w.userData.blockage && !w.userData.cleaned){
        beanVisual.classList.add("bean-dirty");
      }else{
        beanVisual.classList.add("bean-clean");
      }
    }

    function updateUIForWell(w){
      if(!w){
        wellNameEl.textContent="لم يتم اختيار بئر";
        whpEl.textContent="---";
        flpEl.textContent="---";
        casingEl.textContent="Closed";
        stateEl.textContent="غير مفحوص";
        stateTag.textContent="Normal";
        stateTag.className="tag tag-ok";
        btnClean.classList.add("disabled");
        updateBeanVisual(null);
        return;
      }
      const p = calcPressures(w);
      wellNameEl.textContent="بئر "+w.userData.id;
      whpEl.textContent=p.whp+" psi";
      flpEl.textContent=p.flp+" psi";
      casingEl.textContent="Closed";
      stateEl.textContent=p.text;
      if(p.bad){
        stateTag.textContent="Blockage";
        stateTag.className="tag tag-bad";
        btnClean.classList.remove("disabled");
      }else{
        stateTag.textContent="Normal";
        stateTag.className="tag tag-ok";
        btnClean.classList.add("disabled");
      }
      updateBeanVisual(w);
    }

    function nearestWell(){
      let best=null;
      let bestDist=30;
      const pos=worker.position;
      wellsData.forEach(w=>{
        const d = pos.distanceTo(w.mesh.position);
        if(d<bestDist){
          bestDist=d;
          best=w.mesh;
        }
      });
      return best;
    }

    function inspectNearest(){
      const w = nearestWell();
      if(!w){
        log("لا يوجد بئر قريب للفحص، اقترب أكثر.");
        return;
      }
      currentWell = w;
      log("فحص البئر "+w.userData.id+" وفتح ADJ BEAN (عرض البين).");
      updateUIForWell(w);
    }

    function cleanCurrent(){
      if(!currentWell) return;
      if(!currentWell.userData.blockage || currentWell.userData.cleaned) return;
      currentWell.userData.cleaned = true;
      log("تم تنظيف الـ blockage من ADJ BEAN للبئر "+currentWell.userData.id+" – البين أصبح نظيف.");
      updateUIForWell(currentWell);
      const choke = currentWell.getObjectByName("choke");
      if(choke) choke.material.color.set(0x22c55e);
    }

    btnOpen.addEventListener("click",()=>{
      if(!currentWell){inspectNearest();return;}
      const p = calcPressures(currentWell);
      whpEl.textContent=p.whp+" psi";
      flpEl.textContent=p.flp+" psi";
      stateEl.textContent=p.text;
      if(p.bad){
        stateTag.textContent="Blockage";
        stateTag.className="tag tag-bad";
        btnClean.classList.remove("disabled");
        log("قراءة WHP/FLP للبئر "+currentWell.userData.id+" تشير إلى Blockage – شاهد البين.");
      }else{
        stateTag.textContent="Normal";
        stateTag.className="tag tag-ok";
        btnClean.classList.add("disabled");
        log("قراءة WHP/FLP للبئر "+currentWell.userData.id+" طبيعية – البين نظيف.");
      }
      updateBeanVisual(currentWell);
    });

    btnClean.addEventListener("click",cleanCurrent);

    log("تحرك في العالم، اقترب من الآبار، افحص ونظّف الـ blockage، ولاحظ شكل البين والضغوط.");

    let last = performance.now();
    function animate(now){
      const delta = (now-last)/1000;
      last = now;
      updatePlayer(delta);
      renderer.render(scene,camera);
      requestAnimationFrame(animate);
    }
    onResize();
    requestAnimationFrame(animate);
  </script>
</body>
</html>
