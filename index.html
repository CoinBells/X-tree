<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KOC Wellhead Game – X-Tree Training</title>
<style>
  body{
    margin:0;
    background:#101010;
    color:#eee;
    font-family:Arial,sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  #gameContainer{
    margin-top:10px;
  }
  canvas{
    background:#151515;
    border:1px solid #444;
    touch-action:none;
  }
  .hud{
    margin-top:8px;
    max-width:900px;
    width:100%;
    font-size:12px;
    display:flex;
    flex-wrap:wrap;
    justify-content:space-between;
    gap:6px;
  }
  .hud-block{
    flex:1 1 220px;
    border:1px solid #444;
    background:#1b1b1b;
    padding:6px 8px;
    box-sizing:border-box;
  }
  .hud-title{
    font-weight:bold;
    text-align:center;
    margin-bottom:4px;
    font-size:13px;
  }
  .lang-switch{
    text-align:center;
    margin-bottom:4px;
  }
  .lang-switch button{
    margin:0 3px;
    padding:2px 8px;
    font-size:11px;
    border:1px solid #555;
    background:#222;
    color:#eee;
    cursor:pointer;
  }
  .lang-switch .active{
    background:#eee;
    color:#111;
    font-weight:bold;
  }
  .rtl{
    direction:rtl;
    text-align:right;
  }
</style>
</head>
<body>

<div id="gameContainer">
  <canvas id="game" width="900" height="500"></canvas>
</div>

<div class="hud">
  <div class="hud-block" id="hud-info">
    <div class="hud-title" id="hudTitle">Well Pressures</div>
    <div id="pressureText">WHP: 380 psi<br>FLP: 80 psi</div>
    <div style="margin-top:4px;" id="statusText">Suspected choke blockage.</div>
  </div>

  <div class="hud-block" id="hud-obj">
    <div class="lang-switch">
      <button id="btnEn" class="active">EN</button>
      <button id="btnAr">ع</button>
    </div>
    <div class="hud-title" id="objTitle">Objectives</div>
    <div id="objText"></div>
  </div>

  <div class="hud-block" id="hud-msg">
    <div class="hud-title" id="msgTitle">Field Operator</div>
    <div id="msgText"></div>
    <div style="margin-top:4px;font-size:11px;" id="controlHint">
      Move: Arrows / WASD – Action: E – Restart: R
    </div>
  </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

const hudTitle    = document.getElementById('hudTitle');
const pressureText= document.getElementById('pressureText');
const statusText  = document.getElementById('statusText');
const objTitle    = document.getElementById('objTitle');
const objText     = document.getElementById('objText');
const msgTitle    = document.getElementById('msgTitle');
const msgText     = document.getElementById('msgText');
const btnEn       = document.getElementById('btnEn');
const btnAr       = document.getElementById('btnAr');
const hudObj      = document.getElementById('hud-obj');
const hudMsg      = document.getElementById('hud-msg');

const texts={
  en:{
    hudTitle:"Well Pressures",
    objTitle:"Objectives",
    msgTitle:"Field Operator",
    pressure:(W,F)=>`WHP: ${W} psi<br>FLP: ${F} psi`,
    status:{
      blocked:"Suspected choke blockage.",
      flowing:"Flowing – normal operation.",
      removed:"Choke removed – line isolated.",
      shutin:"Well shut-in.",
      sampling:"Drain sampling in progress."
    },
    objectives:{
      1:`• WHP high, FLP low → suspect choke blockage.<br>
• Walk to UPSTREAM valve and press E to close it.<br>
• Walk to ADJ BEAN and press E to pull the choke.<br>
• Press E again at ADJ BEAN to install a clean choke.<br>
• Open UPSTREAM again and confirm pressures are normal.`,
      2:`• Keep the well flowing with a clean choke.<br>
• Walk to DRAIN SAMPLE valve on the hook-up and press E (flush line).<br>
• Walk to the bottle and press E to place it.<br>
• Press E again at DRAIN SAMPLE to fill the bottle.<br>
• Close the drain by pressing E once more.`,
      3:`Training complete. You diagnosed blockage, cleaned the choke,
and took a drain sample safely.`
    },
    operator:{
      intro:"I am the field operator. Move to the X-Tree and follow the objectives.",
      s1_start:"Stage 1: WHP is high and FLP is low – I suspect choke blockage. Close UPSTREAM then pull the choke.",
      s1_wrong:"Never pull the choke with UPSTREAM open. Close the valve first.",
      s1_removed:"Choke is out. After cleaning, install a clean choke and reopen UPSTREAM.",
      s1_done:"Good, pressures look normal again. Now we will take a drain sample from the hook-up.",
      s2_start:"Stage 2: First flush the drain line, then place the bottle and collect the sample.",
      s2_flush:"Line is flushing… short controlled flow.",
      s2_bottle:"Bottle in place. Open the drain again to fill it – just enough for the lab.",
      s2_needclose:"Close the drain valve. We never leave a drain open.",
      s2_done:"Sample collected and drain closed. Job done clean and safe.",
      finished:"Training complete – nice work.",
    },
    controlHint:"Move: Arrows / WASD – Action: E – Restart: R"
  },
  ar:{
    hudTitle:"الضغوط وحالة البئر",
    objTitle:"أهداف التدريب",
    msgTitle:"الفيلد أوبريتر",
    pressure:(W,F)=>`ضغط رأس البئر WHP: ${W} psi<br>ضغط خط الجريان FLP: ${F} psi`,
    status:{
      blocked:"يُشتبه بوجود انسداد في الجوك.",
      flowing:"البئر ينتج بشكل طبيعي.",
      removed:"تم نزع الجوك – الخط معزول.",
      shutin:"البئر مغلق (Shut-in).",
      sampling:"جاري أخذ Drain Sample."
    },
    objectives:{
      1:`• WHP عالي و FLP منخفض → اشتباه انسداد.<br>
• تحرّك إلى فالف UPSTREAM واضغط E لإغلاقه.<br>
• تحرّك إلى ADJ BEAN واضغط E لنزع الجوك.<br>
• اضغط E مرة أخرى عند ADJ BEAN لتركيب جوك نظيف.<br>
• افتح UPSTREAM مرة ثانية وتأكد أن الضغوط طبيعية.`,
      2:`• خلّ البئر في وضع إنتاج مع جوك نظيف.<br>
• تحرّك إلى فالف DRAIN SAMPLE على الـ hook-up واضغط E (تفريغ الخط).<br>
• تحرّك إلى القنينة واضغط E لوضعها تحت المخرج.<br>
• اضغط E مرة ثانية عند DRAIN SAMPLE لملء القنينة.<br>
• اغلق فالف الـ Drain بالضغط على E مرة ثالثة.`,
      3:`تم إنهاء التدريب. شخّصت الانسداد، نظّفت الجوك، وأخذت Drain Sample بطريقة آمنة.`
    },
    operator:{
      intro:"أنا الفيلد أوبريتر. تحرّك إلى شجرة البئر واتبع الأهداف على اليمين.",
      s1_start:"المرحلة 1: WHP عالي و FLP منخفض – نشتبه في انسداد الجوك. نسكّر UPSTREAM وبعدين نطلع الجوك.",
      s1_wrong:"ما نطلع الجوك والـ UPSTREAM مفتوح أبدًا. أول شي نسكّر الفالف.",
      s1_removed:"الجوك طالع. بعد ما تنظّفه ركب جوك نظيف وافتح الـ UPSTREAM.",
      s1_done:"ممتاز، الضغوط رجعت طبيعية. الحين ناخذ Drain Sample من الـ hook-up.",
      s2_start:"المرحلة 2: أولاً نفرغ خط الـ Drain، بعدين نحط القنينة ونجمع العينة.",
      s2_flush:"جاري تفريغ الخط… فلو بسيط ومتحكَّم فيه.",
      s2_bottle:"القنينة في مكانها. افتح الـ Drain مرة ثانية لتمتلئ – كمية كافية للمختبر.",
      s2_needclose:"سكّر فالف الـ Drain. ما نتركه مفتوح.",
      s2_done:"العينة جاهزة والـ Drain مقفول. شغل نظيف.",
      finished:"التدريب انتهى – شغلك ممتاز.",
    },
    controlHint:"الحركة: الأسهم / WASD – تنفيذ: E – إعادة: R"
  }
};

let lang='ar';   // نبدأ بالعربي
let stage=1;     // 1: choke, 2: drain, 3: done
let upstreamOpen=true;
let chokeInstalled=true;
let chokeBlocked=true;
let drainOpen=false;
let drainFlushed=false;
let bottlePlaced=false;
let sampleCollected=false;

// اللاعب
const player={x:120,y:360,speed:2.2};

// مناطق التفاعل (ثابتة تقريباً في الرسم)
const zones={
  upstream:{x:600,y:220,r:40},
  adj:{x:640,y:320,r:40},
  drain:{x:760,y:260,r:40},
  bottle:{x:790,y:330,r:35}
};

const keys={};
window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.key==='r' || e.key==='R') resetGame();
});
window.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false;});

// ضغط/FLP حسب الحالة
function getPressures(){
  if(!chokeInstalled) return {whp:0,flp:0,status:'removed'};
  if(!upstreamOpen)  return {whp:350,flp:0,status:'shutin'};
  if(chokeBlocked)   return {whp:380,flp:80,status:'blocked'};
  // choke نظيف
  if(stage===2 && (drainOpen || sampleCollected)) return {whp:300,flp:140,status:'sampling'};
  return {whp:300,flp:150,status:'flowing'};
}

// تحديث HUD
function updateHUD(customMsg){
  const t=texts[lang];
  const p=getPressures();
  hudTitle.textContent=t.hudTitle;
  objTitle.textContent=t.objTitle;
  msgTitle.textContent=t.msgTitle;
  pressureText.innerHTML=t.pressure(p.whp,p.flp);
  statusText.textContent=t.status[p.status]||'';

  objText.innerHTML=t.objectives[stage];
  document.getElementById('controlHint').textContent=t.controlHint;

  let msg=t.operator.intro;
  if(customMsg) msg=customMsg;
  else{
    if(stage===1){
      if(!chokeInstalled) msg=t.operator.s1_removed;
      else if(!chokeBlocked && upstreamOpen) msg=t.operator.s1_done;
      else msg=t.operator.s1_start;
    }else if(stage===2){
      if(!drainFlushed) msg=t.operator.s2_start;
      else if(drainFlushed && !bottlePlaced) msg=t.operator.s2_flush;
      else if(bottlePlaced && !sampleCollected) msg=t.operator.s2_bottle;
      else if(sampleCollected && drainOpen) msg=t.operator.s2_needclose;
      else if(sampleCollected && !drainOpen) msg=t.operator.s2_done;
    }else if(stage===3){
      msg=t.operator.finished;
    }
  }
  msgText.textContent=msg;

  // RTL
  if(lang==='ar'){
    hudObj.classList.add('rtl');
    hudMsg.classList.add('rtl');
  }else{
    hudObj.classList.remove('rtl');
    hudMsg.classList.remove('rtl');
  }
}

// حركة اللاعب
function updatePlayer(){
  let dx=0,dy=0;
  if(keys['arrowup']||keys['w']) dy-=1;
  if(keys['arrowdown']||keys['s']) dy+=1;
  if(keys['arrowleft']||keys['a']) dx-=1;
  if(keys['arrowright']||keys['d']) dx+=1;
  if(dx||dy){
    const len=Math.hypot(dx,dy)||1;
    dx/=len; dy/=len;
    player.x+=dx*player.speed;
    player.y+=dy*player.speed;
  }
  // حدود الكانفس
  player.x=Math.max(40,Math.min(canvas.width-40,player.x));
  player.y=Math.max(60,Math.min(canvas.height-30,player.y));
}

// المسافة
function dist(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}

// تنفيذ زر E
window.addEventListener('keydown',e=>{
  if(e.key.toLowerCase()!=='e') return;
  handleAction();
});

function handleAction(){
  const t=texts[lang];
  // أقرب زون
  const pos={x:player.x,y:player.y};
  const dUp=dist(pos,zones.upstream);
  const dAdj=dist(pos,zones.adj);
  const dDr=dist(pos,zones.drain);
  const dBo=dist(pos,zones.bottle);

  let msgOverride=null;

  // UPSTREAM
  if(dUp<zones.upstream.r){
    upstreamOpen=!upstreamOpen;
    updateHUD();
    return;
  }

  // ADJ BEAN (الجوك)
  if(dAdj<zones.adj.r){
    if(stage===1 || stage===2){
      if(chokeInstalled){
        if(upstreamOpen){
          msgOverride=t.operator.s1_wrong;
        }else{
          chokeInstalled=false;
        }
      }else{
        chokeInstalled=true;
        chokeBlocked=false; // نعتبره نظيف بعد التركيب
      }
      updateHUD(msgOverride);
      checkStages();
      return;
    }
  }

  // DRAIN SAMPLE
  if(dDr<zones.drain.r && stage===2){
    // أول مرة → flush
    if(!drainFlushed){
      drainFlushed=true;
      drainOpen=true;
      msgOverride=t.operator.s2_flush;
    }else if(drainFlushed && bottlePlaced && !sampleCollected){
      sampleCollected=true;
      drainOpen=true;
      msgOverride=t.operator.s2_bottle;
    }else{
      drainOpen=false;
      msgOverride=t.operator.s2_needclose;
    }
    updateHUD(msgOverride);
    checkStages();
    return;
  }

  // قنينة العينة
  if(dBo<zones.bottle.r && stage===2){
    bottlePlaced=true;
    updateHUD(t.operator.s2_bottle);
    return;
  }
}

// انتقال المراحل
function checkStages(){
  if(stage===1 && upstreamOpen && chokeInstalled && !chokeBlocked){
    stage=2;
  }
  if(stage===2 && sampleCollected && !drainOpen){
    stage=3;
  }
}

// رسم بسيط
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // أرض
  ctx.fillStyle="#202020";
  ctx.fillRect(0,380,canvas.width,120);

  // X-tree (عمودي)
  ctx.strokeStyle="#888";
  ctx.lineWidth=8;
  ctx.beginPath();
  ctx.moveTo(640,120);
  ctx.lineTo(640,340);
  ctx.stroke();

  // cross arms
  ctx.beginPath();
  ctx.moveTo(580,220);
  ctx.lineTo(700,220);
  ctx.stroke();

  // hook-up line
  ctx.beginPath();
  ctx.moveTo(700,250);
  ctx.lineTo(820,250);
  ctx.stroke();

  // drain drop line
  ctx.beginPath();
  ctx.moveTo(820,250);
  ctx.lineTo(820,310);
  ctx.stroke();

  // draw zones helper (اختياري تخفيفاً، نرسم دوائر خفيفة)
  function drawValveCircle(x,y,color,label){
    ctx.fillStyle=color;
    ctx.beginPath();
    ctx.arc(x,y,22,0,Math.PI*2);
    ctx.fill();
    ctx.strokeStyle="#000";
    ctx.lineWidth=2;
    ctx.stroke();
    ctx.fillStyle="#fff";
    ctx.font="10px Arial";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    const line1=label.split("\n")[0];
    const line2=label.split("\n")[1]||"";
    ctx.fillText(line1,x,y-4);
    if(line2) ctx.fillText(line2,x,y+7);
  }

  // colors حسب الحالة
  const colUp=upstreamOpen?"#00b845":"#b80000";
  const colAdj=!chokeInstalled?"#ffaa00":(chokeBlocked?"#b80000":"#00b845");
  const p=getPressures();
  const colDrain=stage===2?(drainOpen?"#00c8ff":"#888"):"#555";

  drawValveCircle(zones.upstream.x,zones.upstream.y,colUp,"UP-\nSTREAM");
  drawValveCircle(zones.adj.x,zones.adj.y,colAdj,"ADJ\nBEAN");
  drawValveCircle(zones.drain.x,zones.drain.y,colDrain,"DRAIN\nSAMPLE");

  // bottle
  ctx.fillStyle="#999";
  ctx.fillRect(zones.bottle.x-10,zones.bottle.y-20,20,28);
  ctx.strokeStyle="#000";
  ctx.strokeRect(zones.bottle.x-10,zones.bottle.y-20,20,28);
  if(sampleCollected){
    ctx.fillStyle="#90501f";
    ctx.fillRect(zones.bottle.x-8,zones.bottle.y-6,16,12);
  }

  // player (العامل)
  // الجسم
  ctx.fillStyle="#1f3f70";
  ctx.fillRect(player.x-10,player.y-28,20,28);
  // الرأس
  ctx.fillStyle="#f0d2a4";
  ctx.beginPath();
  ctx.arc(player.x,player.y-38,10,0,Math.PI*2);
  ctx.fill();
  // الخوذة
  ctx.fillStyle="#e4c200";
  ctx.beginPath();
  ctx.arc(player.x,player.y-42,12,Math.PI,0);
  ctx.fill();
  // رجلين
  ctx.fillStyle="#1f3f70";
  ctx.fillRect(player.x-10,player.y-0,6,10);
  ctx.fillRect(player.x+4,player.y-0,6,10);

  requestAnimationFrame(loop);
}

function loop(){
  updatePlayer();
  draw();
}

// إعادة تعيين
function resetGame(){
  stage=1;
  upstreamOpen=true;
  chokeInstalled=true;
  chokeBlocked=true;
  drainOpen=false;
  drainFlushed=false;
  bottlePlaced=false;
  sampleCollected=false;
  player.x=120; player.y=360;
  updateHUD(texts[lang].operator.intro);
}

// تغيير اللغة
btnEn.onclick=()=>{
  lang='en';
  btnEn.classList.add('active');
  btnAr.classList.remove('active');
  updateHUD();
};
btnAr.onclick=()=>{
  lang='ar';
  btnAr.classList.add('active');
  btnEn.classList.remove('active');
  updateHUD();
};

// تشغيل
resetGame();
requestAnimationFrame(loop);
</script>
</body>
</html>
