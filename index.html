<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KOC Training 3D Facility</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; background: #050814; }

    #canvas-container {
      position: fixed;
      inset: 0;
    }

    /* Info panel */
    #info-panel {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 320px;
      max-width: 90vw;
      background: rgba(10, 13, 30, 0.95);
      border-radius: 12px;
      padding: 12px 14px;
      color: #f5f5f5;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 18px 45px rgba(0,0,0,0.5);
      font-size: 12px;
    }

    #info-panel h1 {
      font-size: 15px;
      margin-bottom: 6px;
    }

    #info-panel .facility-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
      background: rgba(120, 180, 255, 0.12);
    }

    #info-panel p {
      margin-bottom: 4px;
      line-height: 1.4;
    }

    #info-panel .label {
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.7;
    }

    #info-panel small {
      display: block;
      margin-top: 6px;
      opacity: 0.6;
      font-size: 10px;
    }

    /* HUD (top-left) */
    #hud {
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(8, 12, 30, 0.85);
      color: #e5e5e5;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
    }

    #hud .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #34d399;
      box-shadow: 0 0 6px #34d399;
    }

    #hud span {
      opacity: 0.8;
    }

    /* Bottom hint */
    #hint {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.55);
      color: #f9fafb;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
    }
  </style>
</head>
<body>
  <div id="canvas-container"></div>

  <div id="hud">
    <div class="dot"></div>
    <span id="hud-facility">Facility: Overview</span>
  </div>

  <div id="info-panel">
    <h1>Tap any unit in the facility</h1>
    <div class="facility-tag">No equipment selected</div>
    <p>Use one finger to rotate, two fingers to zoom / move.</p>
    <p>اضغط على أي بلوك في المنشأة لعرض تفاصيله.</p>
    <small>Training Mode – Draft layout for KOC Gathering Center facility.</small>
  </div>

  <div id="hint">
    Rotate: drag | Zoom: pinch / scroll | Move: right-click drag | Select: click / tap
  </div>

  <!-- Three.js + controls from CDN -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    // ========= BASIC THREE.JS SETUP =========
    const container = document.getElementById('canvas-container');

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050814);

    const camera = new THREE.PerspectiveCamera(
      60,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 35, 55);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.target.set(0, 0, 0);

    // ========= LIGHTS =========
    const ambient = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambient);

    const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
    dirLight.position.set(40, 60, 25);
    scene.add(dirLight);

    const hemi = new THREE.HemisphereLight(0x4f46e5, 0x0f172a, 0.6);
    scene.add(hemi);

    // ========= GROUND =========
    const groundGeo = new THREE.PlaneGeometry(220, 220);
    const groundMat = new THREE.MeshStandardMaterial({
      color: 0x111827,
      roughness: 1,
      metalness: 0
    });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // ========= FACILITY + EQUIPMENT DATA =========
    // كل شيء هنا ممكن تضيف عليه بيانات من الهاند أوت مباشرة
    const equipmentData = {
      // TV Compression Facility
      "tv_cru_block": {
        name: "TV Compression Facility (CRU + TV Comp)",
        type: "Process Area",
        facility: "TV Compression",
        description: "منطقة ضغط الغاز الثقيل (Tank Vapor) عن طريق CRU والـ TV Compressor، لرفع الضغط وإرجاعه لمسار الغاز أو LPG.",
        keyPoints: [
          "تستخدم Reciprocating Compressor داخل الـ CRU.",
          "يتم تحويل الغاز الساخن المضغوط إلى Condensate بعد التبريد.",
          "جزء من نظام تقليل الفلير في الـ GC."
        ]
      },
      "tv_recip_comp": {
        name: "Reciprocating Compressor – CRU",
        type: "Positive Displacement Compressor",
        facility: "TV Compression",
        description: "كمبريسر Reciprocating يسحب TV Gas من الخزانات ويضغطه إلى ضغط أعلى للمعالجة أو الإرسال.",
        keyPoints: [
          "مسار Suction من خط TV Gas بضغط منخفض.",
          "اسطوانة + Piston بحركة ترددية داخل الـ CRU frame.",
          "يجب عدم تشغيله ضد خط Discharge مغلق لتفادي Damage للمعدة."
        ]
      },

      // Wet Oil Treatment / DDP
      "ddp_block": {
        name: "Wet Oil Treatment Facility (DDP)",
        type: "Process Area",
        facility: "DDP / Desalter",
        description: "منطقة نزع الماء والأملاح من النفط الرطب قبل التصدير، عبر Desalting & Dehydration Plant.",
        keyPoints: [
          "تعالج Emulsion (نفط + ماء + أملاح).",
          "تستخدم Electric Field + Wash Water لفصل الملح.",
          "تقلل الـ Corrosion وتزيد جودة النفط."
        ]
      },
      "ddp_feed_pump": {
        name: "Desalter Feed Pump",
        type: "Centrifugal Pump",
        facility: "DDP / Desalter",
        description: "مضخة طاردة مركزية تغذي الـ Desalter بالنفط الرطب من الـ Main Plant.",
        keyPoints: [
          "مضخة high-flow، تستخدم Impeller داخل Volute casing.",
          "مناسبة للتدفق العالي والضغط المتوسط داخل الـ DDP.",
          "لازم خط السحب يكون مملوء Oil (no gas) لتفادي Cavitation."
        ]
      },

      // Main Plant
      "main_plant_block": {
        name: "Main Plant",
        type: "Process Area",
        facility: "Main Plant",
        description: "القلب الرئيسي للـ GC: استقبال النفط من الآبار، فصل Oil/Gas/Water، تجهيز النفط الجاف، وتنظيم الضغط.",
        keyPoints: [
          "يحتوي على Valves ميكانيكية وPneumatic وMOV.",
          "فيه Oil & Gas manifolds، HP/LP flare systems.",
          "يربط بين الـ Wells, DDP, TV Comp, Transit facility."
        ]
      },
      "main_gate_valve": {
        name: "Main Oil Line Gate Valve",
        type: "Mechanical Valve – Gate",
        facility: "Main Plant",
        description: "Gate Valve على خط نفط رئيسي، تستخدم كـ Isolating Valve للإيقاف الكامل أو الفتح الكامل.",
        keyPoints: [
          "Not recommended للتشغيل في وضع نص فتح بسبب الاهتزاز والتآكل.",
          "جسم المعدة من Steel، حركة خطية (Up/Down).",
          "تُستخدم في خطوط high-pressure داخل الـ GC."
        ]
      },

      // Crude Transit Facility
      "transit_block": {
        name: "Crude Oil Transit Facility",
        type: "Process Area",
        facility: "Transit",
        description: "منطقة ضخ النفط الجاف من خزانات الـ GC (Dry / Dual Tanks) إلى Central Mixing Manifold ثم Tank Farms.",
        keyPoints: [
          "تحتوي Booster Pumps + Main Transit Pumps.",
          "جزء من شبكة نقل النفط على مستوى الكويت.",
          "تعتمد على Dry Tank level للتحكم في الـ Flow."
        ]
      },
      "transit_dry_tank": {
        name: "Dry Tank",
        type: "Storage Tank",
        facility: "Transit",
        description: "خزان نفط جاف، مستوى التشغيل المعتاد حوالي 12–14 ft، يغذي Suction Header لمضخات الترانزيت.",
        keyPoints: [
          "مزود بخط 2\" Equalizing line لتفادي تراكم الضغط على خط السحب.",
          "يحتوي على LSLL لحماية مضخات الترانزيت عند انخفاض المستوى.",
          "Outlet عادة 12\" متصل بـ 30\" Main Suction Header."
        ]
      },
      "transit_pump": {
        name: "Turbine Driven Transit Pump (Main Pump)",
        type: "Centrifugal Pump + Gas Turbine Driver",
        facility: "Transit",
        description: "مضخة تصدير رئيسية بقدرة عالية، تقودها Gas Turbine لضخ النفط إلى خطوط الترانزيت.",
        keyPoints: [
          "لها Booster Pump على السحب لرفع ضغط الدخول.",
          "Discharge pressure يصل تقريباً إلى 400+ psig حسب الـ GC.",
          "مجهزة بخط Recycle + NRV وStrainers على السحب."
        ]
      }
    };

    // ========= UTIL: CREATE FACILITY BLOCKS =========
    const selectableMeshes = [];
    const facilityZones = [];

    function createFacilityZone(label, color, position) {
      const geo = new THREE.BoxGeometry(26, 3, 26);
      const mat = new THREE.MeshStandardMaterial({
        color,
        roughness: 0.6,
        metalness: 0.15
      });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.position.copy(position);
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      scene.add(mesh);

      // glowing frame
      const frameGeo = new THREE.BoxGeometry(27, 0.3, 27);
      const frameMat = new THREE.MeshBasicMaterial({
        color: 0xffffff,
        wireframe: true,
        transparent: true,
        opacity: 0.15
      });
      const frame = new THREE.Mesh(frameGeo, frameMat);
      frame.position.set(position.x, 1.7, position.z);
      scene.add(frame);

      facilityZones.push({ label, mesh });
      return mesh;
    }

    function createEquipmentBox(id, color, position, size = {x:4, y:2, z:4}) {
      const geo = new THREE.BoxGeometry(size.x, size.y, size.z);
      const mat = new THREE.MeshStandardMaterial({
        color,
        roughness: 0.5,
        metalness: 0.25
      });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.position.copy(position);
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      mesh.userData.equipmentId = id;
      scene.add(mesh);
      selectableMeshes.push(mesh);
      return mesh;
    }

    // ========= BUILD LAYOUT =========
    // ترتيب المناطق كأنها خريطة مبسطة للمنشأة
    const tvZone      = createFacilityZone("TV Compression", 0x0ea5e9, new THREE.Vector3(-40, 1.5, -40));
    const ddpZone     = createFacilityZone("DDP / Desalter", 0x22c55e, new THREE.Vector3( 40, 1.5, -40));
    const mainZone    = createFacilityZone("Main Plant",      0xf97316, new THREE.Vector3(-40, 1.5,  40));
    const transitZone = createFacilityZone("Transit",         0x6366f1, new THREE.Vector3( 40, 1.5,  40));

    // TV Compression equipment
    createEquipmentBox("tv_cru_block",  0x0f766e, new THREE.Vector3(-40, 3, -40));
    createEquipmentBox("tv_recip_comp", 0x14b8a6, new THREE.Vector3(-46, 3, -36), {x:5,y:2,z:3});

    // DDP equipment
    createEquipmentBox("ddp_block",     0x14532d, new THREE.Vector3(40, 3, -40));
    createEquipmentBox("ddp_feed_pump", 0x22c55e, new THREE.Vector3(46, 2.5, -36), {x:5,y:1.5,z:3});

    // Main Plant equipment
    createEquipmentBox("main_plant_block", 0x9a3412, new THREE.Vector3(-40, 3, 40));
    createEquipmentBox("main_gate_valve",  0xfacc15, new THREE.Vector3(-46, 2.3, 36), {x:3,y:1.3,z:3});

    // Transit Facility equipment
    createEquipmentBox("transit_block",   0x312e81, new THREE.Vector3(40, 3, 40));
    createEquipmentBox("transit_dry_tank",0x1d4ed8, new THREE.Vector3(46, 3.5, 36), {x:5,y:3,z:5});
    createEquipmentBox("transit_pump",    0x4f46e5, new THREE.Vector3(34, 2.5, 36), {x:5,y:1.8,z:3});

    // ========= RAYCASTING =========
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    const infoPanel   = document.getElementById('info-panel');
    const facilityTag = infoPanel.querySelector('.facility-tag');
    const hudFacility = document.getElementById('hud-facility');

    function setEquipmentInfo(equipId) {
      const data = equipmentData[equipId];
      if (!data) {
        infoPanel.querySelector('h1').textContent = "Unknown equipment";
        facilityTag.textContent = "Not mapped";
        infoPanel.querySelectorAll('p')[0].textContent = "هذا الجسم ما له تعريف في الـ data لسه.";
        infoPanel.querySelectorAll('p')[1].textContent = "";
        return;
      }

      infoPanel.querySelector('h1').textContent = data.name;
      facilityTag.textContent = data.facility + " · " + data.type;

      const ps = infoPanel.querySelectorAll('p');
      ps[0].innerHTML = "<span class='label'>Description</span><br>" + data.description;
      if (data.keyPoints && data.keyPoints.length) {
        ps[1].innerHTML = "<span class='label'>Key Points</span><br>• " + data.keyPoints.join("<br>• ");
      } else {
        ps[1].textContent = "";
      }

      hudFacility.textContent = "Facility: " + data.facility;
    }

    function onClick(event) {
      const rect = renderer.domElement.getBoundingClientRect();
      const x = ( (event.clientX - rect.left) / rect.width ) * 1 - 0.5;
      const y = ( (event.clientY - rect.top)  / rect.height) * 1 - 0.5;

      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(selectableMeshes, false);

      if (intersects.length > 0) {
        const picked = intersects[0].object;
        const id = picked.userData.equipmentId;
        if (id) setEquipmentInfo(id);
      }
    }

    renderer.domElement.addEventListener('click', onClick);

    // ========= RESPONSIVE =========
    window.addEventListener('resize', () => {
      const w = window.innerWidth;
      const h = window.innerHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    });

    // ========= ANIMATION LOOP =========
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
