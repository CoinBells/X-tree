<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KOC Facility Training 3D – Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <style>
    /* ========== RESET ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 0 0, #0f172a 0, #020617 45%, #000 100%);
      color: #e5e7eb;
    }

    body {
      -webkit-font-smoothing: antialiased;
    }

    /* ========== LAYOUT ========== */
    #canvas-container {
      position: fixed;
      inset: 0;
      z-index: 0;
    }

    #ui-root {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
    }

    .panel {
      pointer-events: auto;
      background: rgba(15, 23, 42, 0.94);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow:
        0 20px 60px rgba(0, 0, 0, 0.55),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(18px);
    }

    /* ========== INFO PANEL (RIGHT) ========== */
    #info-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 340px;
      max-width: 92vw;
      padding: 14px 16px 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #info-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    #info-facility-tag {
      display: inline-flex;
      align-items: center;
      align-self: flex-start;
      padding: 2px 9px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.35), rgba(15, 23, 42, 0.9));
      border: 1px solid rgba(56, 189, 248, 0.5);
      color: #e0f2fe;
    }

    #info-type-chip {
      display: inline-flex;
      align-items: center;
      align-self: flex-start;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(148, 163, 184, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: #cbd5f5;
      margin-left: 4px;
    }

    #info-description {
      font-size: 12px;
      line-height: 1.45;
      color: #e5e7eb;
      margin-top: 4px;
    }

    .info-section-label {
      margin-top: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #9ca3af;
    }

    #info-keypoints {
      margin-top: 2px;
      font-size: 11px;
      line-height: 1.45;
      color: #d1d5db;
    }

    #info-flow {
      margin-top: 2px;
      font-size: 11px;
      line-height: 1.45;
      color: #d1d5db;
    }

    #info-footer {
      margin-top: 6px;
      font-size: 10px;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #info-footer span {
      opacity: 0.8;
    }

    #lang-toggle {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 10px;
      padding: 3px 7px;
      cursor: pointer;
    }

    /* ========== HUD (LEFT TOP) ========== */
    #hud-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 8px 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
      pointer-events: auto;
      font-size: 11px;
    }

    #hud-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow:
        0 0 0 3px rgba(34, 197, 94, 0.28),
        0 0 14px rgba(34, 197, 94, 0.9);
    }

    #hud-facility {
      color: #e5e7eb;
    }

    #hud-mode {
      font-size: 10px;
      color: #cbd5f5;
      opacity: 0.85;
    }

    /* ========== MISSIONS PANEL (LEFT BOTTOM) ========== */
    #missions-panel {
      position: absolute;
      left: 10px;
      bottom: 12px;
      width: 260px;
      max-width: 88vw;
      padding: 10px 12px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #missions-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #bfdbfe;
    }

    #missions-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 130px;
      overflow-y: auto;
      padding-right: 3px;
    }

    .mission-item {
      border-radius: 10px;
      padding: 5px 7px;
      background: radial-gradient(circle at 0 0, rgba(37, 99, 235, 0.25), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(59, 130, 246, 0.5);
      font-size: 11px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .mission-item.inactive {
      background: rgba(15, 23, 42, 0.85);
      border-color: rgba(148, 163, 184, 0.5);
      opacity: 0.95;
    }

    .mission-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .mission-tag {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #93c5fd;
    }

    .mission-progress {
      font-size: 10px;
      color: #e5e7eb;
    }

    .mission-desc {
      font-size: 11px;
      color: #d1d5db;
    }

    /* ========== MINIMAP (TOP CENTER) ========== */
    #minimap-panel {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 8px;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      pointer-events: auto;
    }

    #minimap-canvas {
      width: 180px;
      height: 120px;
      border-radius: 10px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: radial-gradient(circle at 0 0, #020617, #020617 40%, #020617);
    }

    #minimap-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #9ca3af;
    }

    /* ========== BOTTOM HINT ========== */
    #hint-bar {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.60);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
      font-size: 11px;
      pointer-events: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }

    #hint-bar span {
      opacity: 0.9;
    }

    /* ========== SCROLLBAR TWEAKS ========== */
    #missions-list::-webkit-scrollbar {
      width: 4px;
    }

    #missions-list::-webkit-scrollbar-track {
      background: transparent;
    }

    #missions-list::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 640px) {
      #info-panel {
        width: 94vw;
        right: 3vw;
        top: auto;
        bottom: 10px;
      }

      #missions-panel {
        left: 8px;
        bottom: 150px;
      }

      #minimap-panel {
        top: auto;
        bottom: 150px;
        left: auto;
        right: 10px;
        transform: none;
      }

      #minimap-canvas {
        width: 150px;
        height: 100px;
      }
    }
  </style>
</head>
<body>
  <div id="canvas-container"></div>

  <div id="ui-root">
    <!-- HUD -->
    <div id="hud-panel" class="panel">
      <div id="hud-dot"></div>
      <div>
        <div id="hud-facility">Facility: Overview</div>
        <div id="hud-mode">Training Mode · Tap equipment blocks to learn</div>
      </div>
    </div>

    <!-- INFO PANEL -->
    <div id="info-panel" class="panel">
      <div style="display:flex;align-items:center;gap:4px;">
        <div id="info-title">Tap any unit in the facility</div>
      </div>
      <div style="display:flex;flex-wrap:wrap;align-items:center;margin-top:2px;gap:4px;">
        <div id="info-facility-tag">NO EQUIPMENT SELECTED</div>
        <div id="info-type-chip">Overview</div>
      </div>
      <div id="info-description">
        Use one finger to rotate, two fingers to zoom / move.<br/>
        اضغط على أي بلوك في المنشأة لعرض وظيفة المعدة ومسار الفلو.
      </div>

      <div class="info-section-label">Key Points</div>
      <div id="info-keypoints">
        • TV Compression, Wet Oil Treatment, Main Plant, and Transit blocks are shown on the 3D pad.<br/>
        • Each colored block represents a real equipment group in KOC facilities.<br/>
        • Use the missions panel to follow full flow paths (TV gas, wet oil, dry oil).
      </div>

      <div class="info-section-label">Flow Path / Notes</div>
      <div id="info-flow">
        Select any block to highlight where its feed comes from and where its outlet goes in the facility.
      </div>

      <div id="info-footer">
        <span id="info-footer-text">No unit selected.</span>
        <button id="lang-toggle">AR / EN</button>
      </div>
    </div>

    <!-- MISSIONS -->
    <div id="missions-panel" class="panel">
      <div id="missions-title">Training Missions</div>
      <div id="missions-list"></div>
    </div>

    <!-- MINIMAP -->
    <div id="minimap-panel" class="panel">
      <canvas id="minimap-canvas" width="180" height="120"></canvas>
      <div id="minimap-label">FACILITY LAYOUT (TOP VIEW)</div>
    </div>

    <!-- HINT BAR -->
    <div id="hint-bar">
      <span>Rotate: drag</span>
      <span>Zoom: pinch / scroll</span>
      <span>Move: two-finger drag</span>
      <span>Select: tap equipment block</span>
    </div>
  </div>

  <!-- GAME LOGIC -->
  <script type="module">
    /*
      ============================
      IMPORTS
      ============================
    */
    import * as THREE from './three.module.js';
    import { OrbitControls } from './OrbitControls.js';

    /*
      ============================
      DOM REFERENCES
      ============================
    */
    const canvasContainer = document.getElementById('canvas-container');

    const infoTitle        = document.getElementById('info-title');
    const infoFacilityTag  = document.getElementById('info-facility-tag');
    const infoTypeChip     = document.getElementById('info-type-chip');
    const infoDescription  = document.getElementById('info-description');
    const infoKeypoints    = document.getElementById('info-keypoints');
    const infoFlow         = document.getElementById('info-flow');
    const infoFooterText   = document.getElementById('info-footer-text');
    const langToggleBtn    = document.getElementById('lang-toggle');

    const hudFacilitySpan  = document.getElementById('hud-facility');

    const missionsListEl   = document.getElementById('missions-list');

    const minimapCanvas    = document.getElementById('minimap-canvas');
    const minimapCtx       = minimapCanvas.getContext('2d');

    /*
      ============================
      LANGUAGE HANDLING
      ============================
      mode = 'en' | 'ar'
    */
    let langMode = 'en';

    function toggleLang() {
      langMode = (langMode === 'en') ? 'ar' : 'en';
      langToggleBtn.textContent = (langMode === 'en') ? 'AR / EN' : 'EN / AR';
      // إعادة عرض آخر معدّة مختارة بنفس اللغة
      if (lastSelectedEquipmentId) {
        const eq = equipmentMap[lastSelectedEquipmentId];
        if (eq) {
          applyEquipmentToPanel(eq);
        }
      } else {
        if (langMode === 'en') {
          infoTitle.textContent = 'Tap any unit in the facility';
          infoDescription.innerHTML =
            'Use one finger to rotate, two fingers to zoom / move.<br/>' +
            'Tap a colored block to see its function and flow path.';
          infoKeypoints.innerHTML =
            '• TV Compression, Wet Oil Treatment (DDP), Main Plant, and Transit are placed on the pad.<br/>' +
            '• Each block summarizes real KOC equipment groups.<br/>' +
            '• Use training missions on the left to follow complete process routes.';
          infoFlow.textContent =
            'Select any unit to see where its feed comes from and where its outlet goes in the gathering center.';
          infoFooterText.textContent = 'No unit selected.';
        } else {
          infoTitle.textContent = 'اضغط على أي معدّة في المنشأة';
          infoDescription.innerHTML =
            'استخدم إصبع واحد للدوران واصبعين للتقريب والتحريك.<br/>' +
            'اضغط على أي بلوك ملوّن لعرض وظيفته ومسار الفلو.';
          infoKeypoints.innerHTML =
            '• تم توزيع مناطق: ضغط الغاز، معالجة النفط الرطب، المحطة الرئيسية، الترانزيت على المنصة.<br/>' +
            '• كل بلوك يختصر مجموعة معدات حقيقية في منشآت KOC.<br/>' +
            '• استخدم مهام التدريب في اليسار لتتبع مسار الفلو الكامل.';
          infoFlow.textContent =
            'اختر أي معدّة لترى من أين يأتي التغذية وإلى أين يذهب المخرج داخل مركز التجميع.';
          infoFooterText.textContent = 'لا توجد معدّة مختارة.';
        }
      }
    }

    langToggleBtn.addEventListener('click', toggleLang);

    /*
      ============================
      THREE.JS – BASIC SCENE
      ============================
    */

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020617);

    const camera = new THREE.PerspectiveCamera(
      60,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 70, 130);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    canvasContainer.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.target.set(0, 8, 0);
    controls.update();

    // Lights
    const hemiLight = new THREE.HemisphereLight(0x93c5fd, 0x020617, 0.8);
    scene.add(hemiLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
    dirLight.position.set(50, 100, 40);
    dirLight.castShadow = true;
    scene.add(dirLight);

    // Ground + grid
    const groundGeo = new THREE.PlaneGeometry(260, 260);
    const groundMat = new THREE.MeshStandardMaterial({
      color: 0x020617,
      roughness: 1,
      metalness: 0
    });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    const grid = new THREE.GridHelper(260, 26, 0x4b5563, 0x1f2937);
    scene.add(grid);

    /*
      ============================
      FACILITY ZONES
      ============================
      Layout in world coordinates:

          (-x, +z)   [Main Plant]
          (+x, +z)   [Transit]
          (-x, -z)   [TV Compression]
          (+x, -z)   [Wet Oil Treatment / DDP]
    */

    const FACILITY_SIZE = 80;
    const FACILITY_Y = 1.5;

    const facilities = {
      tvComp: {
        id: 'tvComp',
        labelEn: 'TV Compression & CRU',
        labelAr: 'منشأة ضغط غاز الخزانات (TV Comp / CRU)',
        color: 0x22d3ee,
        position: new THREE.Vector3(-60, FACILITY_Y, -60)
      },
      wetOil: {
        id: 'wetOil',
        labelEn: 'Wet Oil Treatment (DDP / Desalter)',
        labelAr: 'معالجة النفط الرطب (DDP / Desalter)',
        color: 0x22c55e,
        position: new THREE.Vector3(60, FACILITY_Y, -60)
      },
      mainPlant: {
        id: 'mainPlant',
        labelEn: 'Main Plant (Separators / LP & HP Gas / Tanks)',
        labelAr: 'المحطة الرئيسية (فواصل / ضغط عالي ومنخفض / خزانات)',
        color: 0xf97316,
        position: new THREE.Vector3(-60, FACILITY_Y, 60)
      },
      transit: {
        id: 'transit',
        labelEn: 'Crude Transit Pumps & Export Header',
        labelAr: 'مضخات الترانزيت وخط التصدير',
        color: 0x6366f1,
        position: new THREE.Vector3(60, FACILITY_Y, 60)
      }
    };

    function createFacilityPad(facility, label) {
      const padGeo = new THREE.BoxGeometry(70, 2.6, 70);
      const padMat = new THREE.MeshStandardMaterial({
        color: facility.color,
        metalness: 0.35,
        roughness: 0.55,
        emissive: new THREE.Color(facility.color).multiplyScalar(0.18)
      });
      const pad = new THREE.Mesh(padGeo, padMat);
      pad.position.copy(facility.position);
      pad.castShadow = true;
      pad.receiveShadow = true;
      scene.add(pad);

      const borderGeo = new THREE.BoxGeometry(72, 0.3, 72);
      const borderMat = new THREE.MeshBasicMaterial({
        color: 0x0f172a,
        wireframe: true
      });
      const border = new THREE.Mesh(borderGeo, borderMat);
      border.position.set(facility.position.x, facility.position.y + 2.8, facility.position.z);
      scene.add(border);

      // label
      const spriteCanvas = document.createElement('canvas');
      spriteCanvas.width = 512;
      spriteCanvas.height = 128;
      const ctx = spriteCanvas.getContext('2d');
      ctx.clearRect(0,0,spriteCanvas.width,spriteCanvas.height);
      ctx.fillStyle = 'rgba(15,23,42,0.95)';
      ctx.fillRect(0,0,512,128);
      ctx.fillStyle = '#e5e7eb';
      ctx.font = '28px system-ui';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(label, 256, 64);

      const tex = new THREE.CanvasTexture(spriteCanvas);
      tex.minFilter = THREE.LinearFilter;
      const spriteMat = new THREE.SpriteMaterial({ map: tex, depthWrite: false });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(40, 8, 1);
      sprite.position.set(facility.position.x, facility.position.y + 10, facility.position.z);
      scene.add(sprite);
    }

    createFacilityPad(
      facilities.tvComp,
      'TV Compression / CRU'
    );
    createFacilityPad(
      facilities.wetOil,
      'Wet Oil Treatment (DDP)'
    );
    createFacilityPad(
      facilities.mainPlant,
      'Main Plant'
    );
    createFacilityPad(
      facilities.transit,
      'Transit Pumps'
    );

    /*
      ============================
      EQUIPMENT DEFINITIONS
      ============================
      Each equipment has:
        id, nameEn, nameAr, typeEn, typeAr, facilityId,
        position (x,y,z), size (x,y,z), color,
        descriptionEn, descriptionAr,
        keyPointsEn[], keyPointsAr[],
        flowEn, flowAr
    */

    const equipmentData = [
      // ==== TV COMPRESSION / CRU ====
      {
        id: 'tv_tanks',
        facilityId: 'tvComp',
        nameEn: 'Wet / Dual / Dry Tanks (TV Source)',
        nameAr: 'خزانات Wet / Dual / Dry – مصدر TV Gas',
        typeEn: 'Storage Tanks',
        typeAr: 'خزانات تخزين',
        position: { x: -85, y: 4, z: -80 },
        size:     { x: 14, y: 8, z: 18 },
        color: 0x38bdf8,
        descriptionEn:
          'Tank vapor (C3–C5) is evaporated and separated from crude oil in wet, dual and dry tanks. ' +
          'TV gas collects at the tank dome and flows to the TV gas main header under very low pressure.\n',
        descriptionAr:
          'غاز الخزانات TV (C3–C5) يتبخر وينفصل عن النفط الخام في خزانات الـ Wet و Dual و Dry. ' +
          'يتجمع الغاز في قبة الخزان ثم يذهب إلى هيدر TV الرئيسي بضغط منخفض جداً.',
        keyPointsEn: [
          'Typical operating pressure: around 2.5–3" WG in tanks.',
          'Blanketing gas from LP system keeps tank pressure positive and stable.',
          'All tanks connect to a 42–48" TV gas main header feeding CRU and new TV compressors.'
        ],
        keyPointsAr: [
          'ضغط التشغيل في الخزانات حوالي 3–2.5 إنش W.G.',
          'يتم تعويض الضغط بواسطة غاز LP كـ Blanketing للحفاظ على ضغط موجب وثابت.',
          'كل الخزانات متصلة بهيدر TV رئيسي قطره 42"–48" يغذي الـ CRU والـ TV Comp الجديد.'
        ],
        flowEn:
          'Flow: TV gas from wet/dual/dry tanks → TV gas main header → CRU suction line and/or new TV compressor.',
        flowAr:
          'مسار الفلو: غاز TV من خزانات Wet/Dual/Dry → هيدر TV الرئيسي → خط السحب للـ CRU و/أو الـ TV Comp الجديد.'
      },
      {
        id: 'tv_cru_suction',
        facilityId: 'tvComp',
        nameEn: 'CRU Suction Scrubber (C-101)',
        nameAr: 'فلتر سحب CRU – C-101',
        typeEn: 'Suction Scrubber',
        typeAr: 'فاصل غاز عند السحب',
        position: { x: -60, y: 4, z: -80 },
        size:     { x: 10, y: 6, z: 10 },
        color: 0x0ea5e9,
        descriptionEn:
          'First-stage suction scrubber removes any liquid droplets from TV gas before entering reciprocating compressors. ' +
          'Operates near tank pressure and ambient temperature.\n',
        descriptionAr:
          'فاصل السحب C-101 يزيل قطرات السائل من غاز TV قبل دخوله ضواغط الـ CRU الترددية. ' +
          'يعمل تقريباً على نفس ضغط الخزانات ودرجة حرارة الجو.',
        keyPointsEn: [
          'Protects CRU cylinders from liquid carry-over.',
          'TV gas from main header enters 36" suction line then C-101.',
          'Level / pressure are monitored before starting compressors.'
        ],
        keyPointsAr: [
          'يحمي اسطوانات الضاغط من دخول السوائل (Carry-over).',
          'غاز TV من الهيدر الرئيسي يدخل إلى خط سحب 36" ثم إلى C-101.',
          'يتم مراقبة المستوى والضغط قبل تشغيل الضواغط.'
        ],
        flowEn:
          'Flow: 42–48" TV main header → 36" CRU suction line → C-101 → 1st stage compressors A/B.',
        flowAr:
          'مسار الفلو: هيدر TV 42–48" → خط سحب CRU 36" → C-101 → ضواغط المرحلة الأولى A/B.'
      },
      {
        id: 'tv_cru_compressors',
        facilityId: 'tvComp',
        nameEn: 'CRU Reciprocating Compressors (1st / 2nd / 3rd Stages)',
        nameAr: 'ضواغط CRU الترددية (المرحلة 1 و2 و3)',
        typeEn: 'Reciprocating Compressors',
        typeAr: 'ضواغط ترددية',
        position: { x: -40, y: 4, z: -60 },
        size:     { x: 18, y: 7, z: 14 },
        color: 0x0284c7,
        descriptionEn:
          'CRU boosts TV gas pressure across three stages until it condenses to liquids (condensate) and lean gas can be sent to HP system.\n',
        descriptionAr:
          'وحدة CRU ترفع ضغط غاز TV عبر ثلاث مراحل حتى يتحول إلى مكثفات، ويتم إرسال الغاز الخفيف (Lean Gas) إلى نظام الضغط العالي.',
        keyPointsEn: [
          'Driven by engine; typical capacity around 9.2 MMSCFD and ~4200 BPD condensate in S&EK GCs.',
          'Includes suction bottles, discharge bottles, inter-stage coolers and scrubbers.',
          'Recycle and control valves maintain safe operation and discharge pressure.'
        ],
        keyPointsAr: [
          'محرك ديزل/غاز يقود الضواغط، السعة تقارب 9.2 MMSCFD و ~4200 برميل/يوم مكثفات في مراكز S&EK.',
          'تحتوي على Suction/Discharge Bottles ومبردات وفواصل بين المراحل.',
          'خط Recycle وصمامات تحكم للمحافظة على ضغط التشغيل والأمان.'
        ],
        flowEn:
          'Flow: C-101 → 1st stage compressors → coolers / scrubbers → 2nd stage → 3rd stage → discharge vessel C-104 → lean gas to HP system and condensate to CRU condensate route.',
        flowAr:
          'مسار الفلو: C-101 → ضواغط المرحلة الأولى → مبردات/فواصل → المرحلة الثانية → المرحلة الثالثة → وعاء C-104 → غاز خفيف إلى نظام HP ومكثفات إلى مسار المكثفات.'
      },
      {
        id: 'tv_new_comp',
        facilityId: 'tvComp',
        nameEn: 'New TV Compressor (MAN Turbo)',
        nameAr: 'ضاغط TV الجديد (MAN Turbo)',
        typeEn: 'Centrifugal Compressor',
        typeAr: 'ضاغط طارد مركزي',
        position: { x: -80, y: 4, z: -40 },
        size:     { x: 14, y: 7, z: 12 },
        color: 0x22d3ee,
        descriptionEn:
          'New TV compressor handles most of tank vapor gas in modern GCs. CRU is usually kept on available standby as backup.\n',
        descriptionAr:
          'الضاغط الجديد للـ TV يتولى معظم حمل غاز الخزانات في المراكز الحديثة، بينما تبقى وحدة CRU في وضع جاهز Standby كاحتياط.',
        keyPointsEn: [
          'Receives TV gas from main header via dedicated ESDV.',
          'Reduces flaring by converting TV gas to condensate and lean gas.',
          'Integrated with LP flare and HP gas systems for safe operation.'
        ],
        keyPointsAr: [
          'يستقبل غاز TV من الهيدر عبر صمام ESDV مخصص.',
          'يقلل الفلير عن طريق تحويل غاز TV إلى مكثفات وغاز خفيف قابل للاستخدام.',
          'مربوط مع نظام HP Gas والفلير المنخفض LP Flare لأمان التشغيل.'
        ],
        flowEn:
          'Flow: TV gas main header → TV compressor suction → multi-stage compression → condenser / scrubber → LP/HP gas systems and condensate recovery.',
        flowAr:
          'مسار الفلو: هيدر TV الرئيسي → سحب ضاغط TV → مراحل الضغط → مبرد/فاصل → أنظمة الغاز LP/HP واسترجاع المكثفات.'
      },

      // ==== WET OIL / DDP ====
      {
        id: 'wet_inlet_emulsion',
        facilityId: 'wetOil',
        nameEn: 'Wet Oil Inlet & Emulsion Header',
        nameAr: 'خط دخول النفط الرطب (Emulsion Header)',
        typeEn: 'Production Emulsion',
        typeAr: 'إيمولشن إنتاج',
        position: { x: 40, y: 4, z: -90 },
        size:     { x: 16, y: 6, z: 12 },
        color: 0x22c55e,
        descriptionEn:
          'Most KOC crude is wet oil with varying water cut. Emulsified water is mixed with oil and requires special desalting treatment.\n',
        descriptionAr:
          'معظم إنتاج KOC حالياً نفط رطب، بنِسَب مختلفة من الماء (Water Cut). الماء المستحلب داخل الزيت يحتاج إلى معالجة خاصة في وحدة Desalter.',
        keyPointsEn: [
          'Free water is separated earlier in separators / wet tanks.',
          'Emulsified water is tiny droplets protected by a film (emulsion).',
          'Header collects wet oil before chemical injection and heating.'
        ],
        keyPointsAr: [
          'الماء الحر يُفصل مبكراً في الفواصل والخزانات الرطبة.',
          'الماء المستحلب عبارة عن قطرات صغيرة جداً محاطة بطبقة (Emulsion).',
          'الهيدر يجمع النفط الرطب قبل حقن الكيميكل والتسخين.'
        ],
        flowEn:
          'Flow: Wet oil from separators / tanks → production header / emulsion line → chemical injection, mixing valve and heaters → 1st stage desalter.',
        flowAr:
          'مسار الفلو: نفط رطب من الفواصل/الخزانات → هيدر الإنتاج / خط الإيمولشن → حقن Chemical وم Mixing Valve وتسخين → Desalter المرحلة الأولى.'
      },
      {
        id: 'wet_chem_injection',
        facilityId: 'wetOil',
        nameEn: 'Demulsifier Chemical Injection Skid',
        nameAr: 'سkid حقن مادة Demulsifier',
        typeEn: 'Chemical Dosing',
        typeAr: 'حقن كيميائي',
        position: { x: 65, y: 3, z: -80 },
        size:     { x: 10, y: 5, z: 10 },
        color: 0x16a34a,
        descriptionEn:
          'Demulsifier is injected upstream of wet/dual tanks and desalter vessels so it can contact the emulsion and weaken the film around water droplets.\n',
        descriptionAr:
          'يتم حقن مادة Demulsifier قبل خزانات Wet/Dual وقبل أوعية الـ Desalter حتى تلامس طبقة الإيمولشن وتكسر الغشاء حول قطرات الماء.',
        keyPointsEn: [
          'Chemical must contact film around each water droplet to be effective.',
          'Over-dosing can form an impermeable layer that worsens separation.',
          'Injection rate and location are critical for good treatment.'
        ],
        keyPointsAr: [
          'يجب أن تلامس المادة الغشاء حول كل قطرة ماء لتعمل بكفاءة.',
          'زيادة الجرعة فوق الحد قد تكوّن طبقة عازلة تؤثر سلباً على الفصل.',
          'معدل الحقن وموقعه مهمان جداً لنجاح المعالجة.'
        ],
        flowEn:
          'Flow: Chemical tank → dosing pumps → injection points on emulsion and desalter feed lines.',
        flowAr:
          'مسار الفلو: خزان الكيماوي → مضخات الحقن → نقاط الحقن على خط الإيمولشن وخط تغذية الـ Desalter.'
      },
      {
        id: 'wet_heaters',
        facilityId: 'wetOil',
        nameEn: 'Crude Pre-heaters & Bath Heaters',
        nameAr: 'سخانات النفط (Heat Exchangers & Bath Heaters)',
        typeEn: 'Heating Section',
        typeAr: 'قسم التسخين',
        position: { x: 80, y: 4, z: -60 },
        size:     { x: 16, y: 6, z: 14 },
        color: 0x4ade80,
        descriptionEn:
          'Heating reduces crude viscosity and helps demulsifier and wash water to break the emulsion. Typical DDP inlet temperature is 140–160°F in S&EK GCs.\n',
        descriptionAr:
          'التسخين يقلل لزوجة النفط ويساعد الكيماوي وماء الغسل على كسر الإيمولشن. درجة حرارة الدخول إلى DDP عادة 160–140°F في مراكز S&EK.',
        keyPointsEn: [
          'Pre-heaters (heat exchangers) use hot streams to warm wet crude.',
          'Bath heaters (water or glycol) add further heat when needed.',
          'Too high temperature increases scaling, cost, and safety risks.'
        ],
        keyPointsAr: [
          'مبادلات حرارية ترفع حرارة النفط الرطب باستخدام تيارات ساخنة.',
          'Bath Heaters (ماء/جلايكول) توفر تسخين إضافي عند الحاجة.',
          'رفع الحرارة بشكل مفرط يزيد الترسبات والتكلفة ومخاطر السلامة.'
        ],
        flowEn:
          'Flow: Wet oil from emulsion header → pre-heaters → bath heaters → DDP feed pumps / mixing valve → 1st stage desalter.',
        flowAr:
          'مسار الفلو: نفط رطب من هيدر الإيمولشن → مبادلات حرارية → Bath Heaters → مضخات تغذية DDP / Mixing Valve → Desalter المرحلة الأولى.'
      },
      {
        id: 'wet_desalters',
        facilityId: 'wetOil',
        nameEn: '1st & 2nd Stage Desalter Vessels',
        nameAr: 'أوعية الـ Desalter (المرحلة الأولى والثانية)',
        typeEn: 'Desalting & Dehydration',
        typeAr: 'نزع الأملاح والماء',
        position: { x: 60, y: 6, z: -40 },
        size:     { x: 18, y: 8, z: 16 },
        color: 0x22c55e,
        descriptionEn:
          'Electrostatic desalter vessels apply mixing, dilution water and electric field to coalesce and settle salty formation water out of crude oil.\n',
        descriptionAr:
          'أوعية الـ Desalter تستخدم خلطاً جيداً وماء غسيل وحقل كهربائي لتجميع قطرات الماء المالحة وفصلها عن النفط.',
        keyPointsEn: [
          'Wash water (3–8% of feed) with low salinity is added for dilution.',
          'Mixing valve creates 10–15 psig differential to distribute water and chemical.',
          'High-voltage grids coalesce water droplets and allow settling.'
        ],
        keyPointsAr: [
          'يُضاف ماء غسيل بنسبة 3–8% من معدل التغذية وبملوحة منخفضة.',
          'صمام الخلط يخلق فرق ضغط 10–15 psi لتوزيع الماء والكيماوي.',
          'شبكات عالية الجهد تساعد على تجميع قطرات الماء وترسيبها.'
        ],
        flowEn:
          'Flow: Heated wet oil + chemical + wash water → 1st stage desalter → 2nd stage desalter → treated (dry) crude to main plant & dry tanks.',
        flowAr:
          'مسار الفلو: نفط رطب مسخن + كيماوي + ماء غسيل → Desalter المرحلة الأولى → المرحلة الثانية → نفط معالج (جاف) إلى المحطة الرئيسية وخزانات Dry.'
      },

      // ==== MAIN PLANT ====
      {
        id: 'mp_separators',
        facilityId: 'mainPlant',
        nameEn: 'HP / LP Gas & Oil Separators',
        nameAr: 'فواصل النفط والغاز HP / LP',
        typeEn: 'Three-Phase Separators',
        typeAr: 'فواصل ثلاثية الطور',
        position: { x: -80, y: 4, z: 40 },
        size:     { x: 18, y: 7, z: 16 },
        color: 0xf97316,
        descriptionEn:
          'High- and low-pressure separators split the production into gas, oil and water phases and control operating pressures for the gathering center.\n',
        descriptionAr:
          'فواصل الضغط العالي والمنخفض تفصل الإنتاج إلى غاز ونفط وماء، وتتحكم في ضغوط التشغيل داخل مركز التجميع.',
        keyPointsEn: [
          'LP gas system typically operates around 50 psig and sends gas to LP scrubber.',
          'HP and LP gas lines include flow meters, check valves and control valves.',
          'Oil outlet from separators goes to wet tanks / DDP and then to dry tanks and transit.'
        ],
        keyPointsAr: [
          'نظام LP Gas يعمل عادة بالقرب من 50 psi ويرسل الغاز إلى LP Scrubber.',
          'خطوط الغاز مزودة بمقاييس تدفق، وصمامات عدم رجوع، وصمامات تحكم.',
          'مخرج النفط من الفواصل يتجه إلى خزانات Wet / DDP ثم إلى خزانات Dry والترانزيت.'
        ],
        flowEn:
          'Flow: Well production → HP/LP separators → gas to HP/LP gas headers → booster stations / flare; oil to wet oil treatment / tanks.',
        flowAr:
          'مسار الفلو: إنتاج الآبار → فواصل HP/LP → غاز إلى هيدرات الغاز ونظام البوستر/الفلير؛ نفط إلى معالجة النفط الرطب والخزانات.'
      },
      {
        id: 'mp_tanks',
        facilityId: 'mainPlant',
        nameEn: 'Wet / Dual / Dry Tanks (Main Plant Side)',
        nameAr: 'خزانات Wet / Dual / Dry في المحطة الرئيسية',
        typeEn: 'Storage & Surge Tanks',
        typeAr: 'خزانات تخزين وموازنة',
        position: { x: -60, y: 5, z: 80 },
        size:     { x: 20, y: 8, z: 16 },
        color: 0xfbbf24,
        descriptionEn:
          'Wet and dual tanks receive partially treated crude; dry tanks store treated crude ready for transit. Tank levels are critical for pump suction and shutdown logic.\n',
        descriptionAr:
          'خزانات Wet و Dual تستقبل النفط شبه المعالج، وخزانات Dry تخزن النفط الجاف الجاهز للضخ في الترانزيت. مستويات الخزانات مهمة لسحب المضخات ولمنطق الإيقاف الآمن.',
        keyPointsEn: [
          'Tank vapor (TV gas) is routed to TV compression facility.',
          'Dry tank level must be above minimum before starting transit pumps.',
          'Equalizing lines between tanks balance levels and pressure.'
        ],
        keyPointsAr: [
          'غاز الخزانات TV يذهب إلى منشأة ضغط الغاز (TV Comp / CRU).',
          'مستوى Dry Tank يجب أن يكون فوق حد معين قبل تشغيل مضخات الترانزيت.',
          'خطوط Equalizing بين الخزانات لموازنة المستوى والضغط.'
        ],
        flowEn:
          'Flow: Oil from separators / DDP → wet & dual tanks → DDP / desalter → dry tank → transit booster pumps.',
        flowAr:
          'مسار الفلو: نفط من الفواصل/معالجة النفط الرطب → خزانات Wet/Dual → وحدة DDP → خزان Dry → مضخات البوستر للترانزيت.'
      },
      {
        id: 'mp_press_gas',
        facilityId: 'mainPlant',
        nameEn: 'Pressurizing Gas System',
        nameAr: 'نظام غاز الضغط (Pressurizing Gas)',
        typeEn: 'Lean Gas Pressurizing',
        typeAr: 'غاز خفيف للضغط',
        position: { x: -40, y: 4, z: 40 },
        size:     { x: 16, y: 6, z: 12 },
        color: 0xf97316,
        descriptionEn:
          'Pressurizing gas from HP gas system is reduced and routed to tanks and fuel systems to keep them at positive pressure and support operations.\n',
        descriptionAr:
          'غاز الضغط يؤخذ من نظام HP Gas ثم يُخفّض ويوزع إلى الخزانات وأنظمة الوقود للحفاظ على ضغط موجب ودعم التشغيل.',
        keyPointsEn: [
          'Manual pressurizing valves to wet, dual and dry tanks must remain open 24/7.',
          'Pressure control valves keep outlet pressure around set value (e.g., 250 psig to pressurizing header).',
          'Helps maintain positive pressure and minimize air ingress and flaring.'
        ],
        keyPointsAr: [
          'صمامات تزويد الغاز للتخزين يجب أن تبقى مفتوحة على مدار الساعة.',
          'صمامات تحكم بالضغط تضبط الضغط الخارج (مثلاً 250 psi) للهيدر.',
          'يساعد على الحفاظ على ضغط موجب ويقلل دخول الهواء والفلير.'
        ],
        flowEn:
          'Flow: HP gas scrubber / transit line → pressurizing gas PCV → pressurizing header → tanks, fuel systems and other consumers.',
        flowAr:
          'مسار الفلو: غاز HP من Scrubber / Transit → صمام تحكم ضغط → هيدر Pressurizing → الخزانات، نظام الوقود، وغيرها.'
      },

      // ==== TRANSIT FACILITY ====
      {
        id: 'tr_dry_tank',
        facilityId: 'transit',
        nameEn: 'Dry Tank to Transit Suction Header',
        nameAr: 'خزان Dry وخط السحب لمضخات الترانزيت',
        typeEn: 'Storage & Suction Header',
        typeAr: 'خزان تخزين وخط سحب',
        position: { x: 40, y: 5, z: 80 },
        size:     { x: 16, y: 8, z: 16 },
        color: 0x38bdf8,
        descriptionEn:
          'Dry or dual (dry service) tanks feed the suction header of transit booster and main oil line pumps. Level interlocks protect pumps from running dry.\n',
        descriptionAr:
          'خزانات Dry أو Dual (خدمة جافة) تغذي خط السحب الخاص بمضخات البوستر ومضخات Main Oil Line للترانزيت. أنظمة الحماية تمنع تشغيل المضخات بدون مستوى كافٍ في الخزان.',
        keyPointsEn: [
          'Dry tank minimum operating level typically 12–14 ft before starting pumps.',
          'Equalizing lines keep oil level balanced between tanks.',
          'Suction MOVs and manual valves must be open before start-up.'
        ],
        keyPointsAr: [
          'مستوى التشغيل الأدنى للدراي تانك عادة بين 12–14 قدم قبل التشغيل.',
          'خطوط Equalizing تحافظ على توازن المستوى بين الخزانات.',
          'صمامات السحب (يدوي/موف) يجب أن تكون مفتوحة قبل التشغيل.'
        ],
        flowEn:
          'Flow: Dry tank outlet → suction MOV / manual valve → common suction header → booster pump.',
        flowAr:
          'مسار الفلو: مخرج خزان Dry → صمام موف/يدوي للسحب → هيدر السحب المشترك → مضخة البوستر.'
      },
      {
        id: 'tr_booster',
        facilityId: 'transit',
        nameEn: 'Booster Pump (Transit)',
        nameAr: 'مضخة بوستر للترانزيت',
        typeEn: 'Vertical Booster Pump',
        typeAr: 'مضخة رأسية مساعدة',
        position: { x: 60, y: 4, z: 70 },
        size:     { x: 12, y: 6, z: 10 },
        color: 0x4f46e5,
        descriptionEn:
          'Vertical booster pump increases crude pressure from tank level (~10 psig) to around 55 psig to ensure good suction to the main oil line (MOL) pump.\n',
        descriptionAr:
          'مضخة بوستر رأسية ترفع ضغط النفط من حوالي 10 psi عند السحب إلى حوالي 55 psi لتوفير سحب جيد لمضخة الـ Main Oil Line.',
        keyPointsEn: [
          'Equipped with suction strainer, priming valve and MOV isolation.',
          'Discharge connected directly to MOL main pump suction.',
          'Minimum flow recycle line protects pump at low flow conditions.'
        ],
        keyPointsAr: [
          'مزودة بفلتر سحب (Strainer) وصمام Priming وصمام MOV للعزل.',
          'مخرج المضخة متصل مباشرة بسحب مضخة MOL الرئيسية.',
          'خط Recycle بحد أدنى للتدفق يحمي المضخة عند انخفاض الفلو.'
        ],
        flowEn:
          'Flow: Dry tank suction header → booster pump → MOL main pump suction.',
        flowAr:
          'مسار الفلو: هيدر سحب خزان Dry → مضخة بوستر → سحب مضخة MOL الرئيسية.'
      },
      {
        id: 'tr_mol_pump',
        facilityId: 'transit',
        nameEn: 'Main Oil Line Pump (VSD / Turbine)',
        nameAr: 'مضخة Main Oil Line (VSD / Turbine)',
        typeEn: 'Transit Main Pump',
        typeAr: 'مضخة الترانزيت الرئيسية',
        position: { x: 80, y: 4, z: 55 },
        size:     { x: 14, y: 6, z: 12 },
        color: 0x818cf8,
        descriptionEn:
          'Main oil line (MOL) pump is a high-capacity centrifugal pump driven by VSD motor or gas turbine, boosting crude to transit line pressure and sending it towards CMM.\n',
        descriptionAr:
          'مضخة الـ Main Oil Line هي مضخة طاردة مركزية عالية السعة يقودها محرك VSD أو توربين غازي، ترفع ضغط النفط إلى ضغط خط الترانزيت وترسله باتجاه CMM.',
        keyPointsEn: [
          'Typical speed around 3000 RPM for VSD-driven pumps.',
          'Equipped with all standard centrifugal pump components and protection.',
          'Discharge controlled by PCV and MOV towards transit manifold.'
        ],
        keyPointsAr: [
          'سرعة التشغيل في مضخات VSD تقارب 3000 RPM.',
          'تحتوي على جميع مكونات المضخة الطاردة (Impeller, Seals, Bearings, Drains...).',
          'خروج المضخة يتم التحكم به عبر PCV وصمام MOV إلى Manifold الترانزيت.'
        ],
        flowEn:
          'Flow: Booster discharge → MOL pump suction → transit manifold → crude export network to CMM / tank farms.',
        flowAr:
          'مسار الفلو: مخرج البوستر → سحب مضخة MOL → Manifold خط الترانزيت → شبكة التصدير باتجاه CMM وخزانات الشمال/الجنوب.'
      }
    ];

    // Map for fast lookup
    const equipmentMap = {};
    for (const eq of equipmentData) {
      equipmentMap[eq.id] = eq;
    }

    /*
      ============================
      CREATE 3D BOXES FOR EQUIPMENT
      ============================
    */

    const selectableMeshes = [];
    const equipmentMeshMap = {};

    function createEquipmentMesh(eq) {
      const geo = new THREE.BoxGeometry(eq.size.x, eq.size.y, eq.size.z);
      const mat = new THREE.MeshStandardMaterial({
        color: eq.color,
        metalness: 0.4,
        roughness: 0.35,
        emissive: new THREE.Color(eq.color).multiplyScalar(0.25)
      });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.position.set(eq.position.x, eq.position.y, eq.position.z);
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      mesh.userData.equipmentId = eq.id;
      mesh.userData.baseColor = new THREE.Color(eq.color);
      scene.add(mesh);

      // Small glowing ring on top
      const ringGeo = new THREE.RingGeometry(eq.size.x * 0.35, eq.size.x * 0.5, 32);
      const ringMat = new THREE.MeshBasicMaterial({
        color: 0xffffff,
        opacity: 0.3,
        transparent: true,
        side: THREE.DoubleSide
      });
      const ring = new THREE.Mesh(ringGeo, ringMat);
      ring.rotation.x = -Math.PI / 2;
      ring.position.set(eq.position.x, eq.position.y + eq.size.y * 0.52, eq.position.z);
      ring.userData.parentEquipmentId = eq.id;
      scene.add(ring);

      selectableMeshes.push(mesh);
      equipmentMeshMap[eq.id] = { mesh, ring };
    }

    equipmentData.forEach(createEquipmentMesh);

    /*
      ============================
      RAYCAST SELECTION
      ============================
    */

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    let lastSelectedEquipmentId = null;
    let selectionPulseTime = 0;

    function updateSelectionVisuals(delta) {
      selectionPulseTime += delta;
      const speed = 2.5;
      const pulse = 0.55 + 0.35 * Math.sin(selectionPulseTime * speed);

      for (const id of Object.keys(equipmentMeshMap)) {
        const entry = equipmentMeshMap[id];
        const isSelected = (id === lastSelectedEquipmentId);

        if (isSelected) {
          entry.mesh.material.emissiveIntensity = 0.8;
          entry.mesh.material.emissive = entry.mesh.userData.baseColor.clone().multiplyScalar(0.7);
          entry.ring.material.opacity = 0.45 + 0.35 * Math.sin(selectionPulseTime * speed);
          entry.ring.scale.setScalar(1.0 + 0.1 * Math.sin(selectionPulseTime * speed));
        } else {
          entry.mesh.material.emissiveIntensity = 0.3;
          entry.mesh.material.emissive = entry.mesh.userData.baseColor.clone().multiplyScalar(0.2);
          entry.ring.material.opacity = 0.2;
          entry.ring.scale.setScalar(1.0);
        }
      }
    }

    function onPointerTap(event) {
      const bounds = renderer.domElement.getBoundingClientRect();
      const x = (event.clientX - bounds.left) / bounds.width;
      const y = (event.clientY - bounds.top)  / bounds.height;
      mouse.x = x * 2 - 1;
      mouse.y = -y * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const hits = raycaster.intersectObjects(selectableMeshes, false);

      if (hits.length > 0) {
        const eqId = hits[0].object.userData.equipmentId;
        const eq = equipmentMap[eqId];
        if (eq) {
          selectEquipment(eqId);
          focusCameraOnEquipment(eq);
          handleMissionClick(eqId);
        }
      }
    }

    renderer.domElement.addEventListener('click', onPointerTap);

    function focusCameraOnEquipment(eq) {
      const target = new THREE.Vector3(eq.position.x, eq.position.y + 4, eq.position.z);
      controls.target.copy(target);
      const offset = new THREE.Vector3(0, 30, 50);
      camera.position.copy(target.clone().add(offset));
    }

    function selectEquipment(eqId) {
      lastSelectedEquipmentId = eqId;
      const eq = equipmentMap[eqId];
      applyEquipmentToPanel(eq);
    }

    function applyEquipmentToPanel(eq) {
      const fac = facilities[eq.facilityId];

      hudFacilitySpan.textContent = 'Facility: ' + (langMode === 'en' ? fac.labelEn || fac.labelAr : fac.labelAr || fac.labelEn);

      const isEn = (langMode === 'en');

      infoTitle.textContent = isEn ? eq.nameEn : eq.nameAr;
      infoFacilityTag.textContent = isEn ? (fac.labelEn || fac.labelAr) : (fac.labelAr || fac.labelEn);
      infoTypeChip.textContent = isEn ? eq.typeEn : eq.typeAr;

      infoDescription.textContent = isEn ? eq.descriptionEn : eq.descriptionAr;

      const kp = isEn ? eq.keyPointsEn : eq.keyPointsAr;
      infoKeypoints.innerHTML = kp.map(point => '• ' + point).join('<br/>');

      infoFlow.textContent = isEn ? eq.flowEn : eq.flowAr;

      infoFooterText.textContent =
        (isEn
          ? 'Selected unit: ' + eq.nameEn + ' · Tap another block to change.'
          : 'المعدة المختارة: ' + eq.nameAr + ' · اضغط على بلوك آخر للتغيير.');
    }

    /*
      ============================
      MISSIONS SYSTEM
      ============================
      Each mission has:
        id, titleEn/Ar, descriptionEn/Ar,
        steps: [{ equipmentId, labelEn, labelAr }]
    */

    const missions = [
      {
        id: 'mission_tvGasPath',
        titleEn: 'TV Gas Path: Tanks → CRU / TV Comp → HP Gas',
        titleAr: 'مسار غاز الخزانات TV: من الخزانات إلى CRU / TV Comp ثم HP Gas',
        descriptionEn:
          'Follow the heavy tank vapor gas from wet/dual/dry tanks all the way to CRU discharge and HP gas system.',
        descriptionAr:
          'تتبّع مسار غاز الخزانات TV من خزانات Wet/Dual/Dry حتى مخرج CRU ووصوله لنظام HP Gas.',
        steps: [
          {
            equipmentId: 'tv_tanks',
            labelEn: 'Start at wet/dual/dry tanks where TV gas is generated.',
            labelAr: 'ابدأ من خزانات Wet/Dual/Dry حيث يتكون غاز TV.'
          },
          {
            equipmentId: 'tv_cru_suction',
            labelEn: 'Go to CRU suction scrubber (C-101) to knock out liquids.',
            labelAr: 'اذهب إلى فاصل السحب C-101 لإزالة السوائل.'
          },
          {
            equipmentId: 'tv_cru_compressors',
            labelEn: 'Move to CRU compressors (all stages) where pressure is raised.',
            labelAr: 'انتقل إلى ضواغط CRU بجميع المراحل حيث يتم رفع الضغط.'
          },
          {
            equipmentId: 'tv_new_comp',
            labelEn: 'Compare with the new TV compressor that now handles most of the load.',
            labelAr: 'قارن مع ضاغط TV الجديد الذي يتحمل معظم الحمل حالياً.'
          }
        ]
      },
      {
        id: 'mission_wetOilToDry',
        titleEn: 'Wet Oil Treatment: Emulsion → Desalter → Dry Crude',
        titleAr: 'معالجة النفط الرطب: إيمولشن → Desalter → نفط جاف',
        descriptionEn:
          'Trace how wet crude with water and salts becomes dry, treated crude ready for dry tanks.',
        descriptionAr:
          'تتبّع كيف يتحول النفط الرطب المحتوي على ماء وأملاح إلى نفط جاف جاهز لدخول خزانات Dry.',
        steps: [
          {
            equipmentId: 'wet_inlet_emulsion',
            labelEn: 'Start at wet oil inlet / emulsion header.',
            labelAr: 'ابدأ من خط دخول النفط الرطب / هيدر الإيمولشن.'
          },
          {
            equipmentId: 'wet_chem_injection',
            labelEn: 'Check chemical injection skid (demulsifier).',
            labelAr: 'شاهد سkid حقن مادة Demulsifier.'
          },
          {
            equipmentId: 'wet_heaters',
            labelEn: 'Move to heaters where crude is warmed to ~140–160°F.',
            labelAr: 'انتقل إلى السخانات حيث ترتفع حرارة النفط إلى 160–140°F تقريباً.'
          },
          {
            equipmentId: 'wet_desalters',
            labelEn: 'Finish at desalter vessels where water and salts are removed.',
            labelAr: 'اختم عند أوعية الـ Desalter حيث يتم نزع الماء والأملاح.'
          },
          {
            equipmentId: 'mp_tanks',
            labelEn: 'Dry treated oil goes to dry tank in main plant.',
            labelAr: 'النفط المعالج (الجاف) يذهب إلى خزان Dry في المحطة الرئيسية.'
          }
        ]
      },
      {
        id: 'mission_transitExport',
        titleEn: 'Transit Export: Dry Tank → Booster → MOL → Transit Line',
        titleAr: 'تصدير النفط: خزان Dry → مضخة بوستر → MOL → خط الترانزيت',
        descriptionEn:
          'Learn how treated crude is pumped from dry tanks to the main transit line towards CMM.',
        descriptionAr:
          'تعرّف كيف يُضخ النفط المعالج من خزان Dry إلى خط الترانزيت الرئيسي باتجاه CMM.',
        steps: [
          {
            equipmentId: 'tr_dry_tank',
            labelEn: 'Check dry tank level and suction header.',
            labelAr: 'تحقق من مستوى خزان Dry وهيدر السحب.'
          },
          {
            equipmentId: 'tr_booster',
            labelEn: 'Go to booster pump that raises pressure to ~55 psig.',
            labelAr: 'اذهب إلى مضخة البوستر التي ترفع الضغط إلى ~55 psi.'
          },
          {
            equipmentId: 'tr_mol_pump',
            labelEn: 'Finish at main oil line (MOL) pump sending crude to transit manifold.',
            labelAr: 'اختم عند مضخة MOL الرئيسية التي تضخ النفط إلى Manifold الترانزيت.'
          }
        ]
      }
    ];

    let activeMissionId = null;
    const missionProgress = {}; // missionId -> current step index

    function renderMissionsList() {
      missionsListEl.innerHTML = '';
      missions.forEach((mission) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'mission-item inactive';
        wrapper.dataset.missionId = mission.id;

        const header = document.createElement('div');
        header.className = 'mission-header-row';

        const tag = document.createElement('div');
        tag.className = 'mission-tag';
        tag.textContent = (langMode === 'en') ? 'PROCESS PATH' : 'مسار الفلو';
        header.appendChild(tag);

        const progressLabel = document.createElement('div');
        progressLabel.className = 'mission-progress';
        const completed = missionProgress[mission.id] || 0;
        progressLabel.textContent = `${completed} / ${mission.steps.length}`;
        header.appendChild(progressLabel);

        const title = document.createElement('div');
        title.style.fontSize = '11px';
        title.style.fontWeight = '600';
        title.style.color = '#e5e7eb';
        title.style.marginTop = '2px';
        title.textContent = (langMode === 'en') ? mission.titleEn : mission.titleAr;

        const desc = document.createElement('div');
        desc.className = 'mission-desc';
        desc.textContent = (langMode === 'en') ? mission.descriptionEn : mission.descriptionAr;

        wrapper.appendChild(header);
        wrapper.appendChild(title);
        wrapper.appendChild(desc);

        wrapper.addEventListener('click', () => {
          setActiveMission(mission.id);
        });

        missionsListEl.appendChild(wrapper);
      });

      updateMissionStyles();
    }

    function updateMissionStyles() {
      const items = missionsListEl.querySelectorAll('.mission-item');
      items.forEach(item => {
        const missionId = item.dataset.missionId;
        const isActive = (missionId === activeMissionId);
        item.classList.toggle('inactive', !isActive);

        const mission = missions.find(m => m.id === missionId);
        const progressEl = item.querySelector('.mission-progress');
        const completed = missionProgress[missionId] || 0;
        progressEl.textContent = `${completed} / ${mission.steps.length}`;
      });
    }

    function setActiveMission(missionId) {
      activeMissionId = missionId;
      if (!missionProgress[missionId]) missionProgress[missionId] = 0;
      updateMissionStyles();

      const mission = missions.find(m => m.id === missionId);
      if (!mission) return;

      const stepIndex = missionProgress[missionId];
      const step = mission.steps[Math.min(stepIndex, mission.steps.length - 1)];
      const eq = equipmentMap[step.equipmentId];

      const isEn = (langMode === 'en');

      infoTitle.textContent = isEn ? mission.titleEn : mission.titleAr;
      infoFacilityTag.textContent = isEn ? 'Mission Active' : 'مهمة نشطة';
      infoTypeChip.textContent = isEn ? 'Step ' + (stepIndex + 1) : 'الخطوة ' + (stepIndex + 1);
      infoDescription.textContent = isEn ? step.labelEn : step.labelAr;

      infoKeypoints.innerHTML =
        (isEn
          ? '• Tap the highlighted unit for this step.<br/>• When correct, the mission will move to the next equipment.'
          : '• اضغط على المعدّة المحددة في هذه الخطوة.<br/>• عند الاختيار الصحيح تنتقل المهمة إلى المعدّة التالية.');

      infoFlow.textContent =
        isEn
          ? 'Mission Target: ' + eq.nameEn
          : 'المعدة المطلوب اختيارها: ' + eq.nameAr;

      infoFooterText.textContent =
        isEn
          ? 'Follow the mission steps in order. Tap blocks inside the highlighted facility.'
          : 'اتبع خطوات المهمة بالتسلسل. اضغط على البلوكات داخل المنشأة المحددة.';
    }

    function handleMissionClick(eqId) {
      if (!activeMissionId) return;
      const mission = missions.find(m => m.id === activeMissionId);
      if (!mission) return;

      let stepIndex = missionProgress[activeMissionId] || 0;
      if (stepIndex >= mission.steps.length) return;

      const currentStep = mission.steps[stepIndex];
      if (currentStep.equipmentId === eqId) {
        // Correct equipment
        stepIndex += 1;
        missionProgress[activeMissionId] = stepIndex;
        updateMissionStyles();

        if (stepIndex >= mission.steps.length) {
          const isEn = (langMode === 'en');
          infoTitle.textContent = isEn ? 'Mission Completed' : 'اكتملت المهمة';
          infoFacilityTag.textContent = isEn ? 'All steps done' : 'تم تنفيذ جميع الخطوات';
          infoTypeChip.textContent = isEn ? 'Complete' : 'مكتملة';

          infoDescription.textContent =
            isEn
              ? 'You followed the full process path successfully. You can replay this mission or select another one.'
              : 'تم تتبّع مسار الفلو بالكامل بنجاح. يمكنك إعادة نفس المهمة أو اختيار مهمة أخرى.';

          infoKeypoints.innerHTML =
            isEn
              ? '• Review each equipment again by tapping its block.<br/>• Try another mission to cover a different part of the facility.'
              : '• راجع كل معدّة مرة أخرى بالضغط على بلوك المعدة.<br/>• جرّب مهمة أخرى لتغطي جزءاً مختلفاً من المنشأة.';

          infoFlow.textContent =
            isEn
              ? 'All mission steps are complete.'
              : 'تم إنهاء جميع خطوات المهمة.';

          infoFooterText.textContent =
            isEn
              ? 'Mission finished. Good job.'
              : 'انتهت المهمة. أحسنت.';

          activeMissionId = null;
          updateMissionStyles();
        } else {
          setActiveMission(activeMissionId); // refresh to next step
        }
      }
    }

    // initial render
    renderMissionsList();

    /*
      ============================
      MINIMAP RENDERING
      ============================
      2D top view rectangles representing facility pads and equipment.
    */

    function worldToMinimap(x, z) {
      const scale = 0.4; // world units → pixels
      const centerX = minimapCanvas.width / 2;
      const centerY = minimapCanvas.height / 2;
      return {
        x: centerX + x * scale,
        y: centerY - z * scale
      };
    }

    function drawMinimap() {
      minimapCtx.clearRect(0, 0, minimapCanvas.width, minimapCanvas.height);

      minimapCtx.fillStyle = '#020617';
      minimapCtx.fillRect(0, 0, minimapCanvas.width, minimapCanvas.height);

      // facility pads
      Object.values(facilities).forEach((fac) => {
        const pos = worldToMinimap(fac.position.x, fac.position.z);
        const w = FACILITY_SIZE * 0.4;
        const h = FACILITY_SIZE * 0.4;

        minimapCtx.save();
        const grad = minimapCtx.createLinearGradient(
          pos.x - w / 2,
          pos.y - h / 2,
          pos.x + w / 2,
          pos.y + h / 2
        );
        grad.addColorStop(0, 'rgba(15,23,42,0.9)');
        grad.addColorStop(1, 'rgba(30,64,175,0.9)');
        minimapCtx.fillStyle = 'rgba(15,23,42,0.9)';
        minimapCtx.strokeStyle = '#64748b';
        minimapCtx.lineWidth = 1;

        minimapCtx.beginPath();
        minimapCtx.rect(pos.x - w / 2, pos.y - h / 2, w, h);
        minimapCtx.fill();
        minimapCtx.stroke();

        minimapCtx.fillStyle = '#9ca3af';
        minimapCtx.font = '8px system-ui';
        minimapCtx.textAlign = 'center';
        minimapCtx.textBaseline = 'middle';
        const label =
          fac.id === 'tvComp'
            ? 'TV / CRU'
            : fac.id === 'wetOil'
            ? 'DDP'
            : fac.id === 'mainPlant'
            ? 'MAIN'
            : 'TRANSIT';
        minimapCtx.fillText(label, pos.x, pos.y);
        minimapCtx.restore();
      });

      // equipment dots
      equipmentData.forEach((eq) => {
        const pos = worldToMinimap(eq.position.x, eq.position.z);
        const isSelected = (eq.id === lastSelectedEquipmentId);

        minimapCtx.beginPath();
        minimapCtx.arc(pos.x, pos.y, isSelected ? 4 : 3, 0, Math.PI * 2);
        minimapCtx.fillStyle = isSelected ? '#f97316' : '#38bdf8';
        minimapCtx.fill();
      });

      // camera symbol
      const camPos2D = worldToMinimap(camera.position.x, camera.position.z);
      minimapCtx.save();
      minimapCtx.translate(camPos2D.x, camPos2D.y);
      minimapCtx.rotate(Math.atan2(-camera.position.z, camera.position.x));
      minimapCtx.beginPath();
      minimapCtx.moveTo(0, 0);
      minimapCtx.lineTo(6, 3);
      minimapCtx.lineTo(6, -3);
      minimapCtx.closePath();
      minimapCtx.fillStyle = '#22c55e';
      minimapCtx.fill();
      minimapCtx.restore();
    }

    /*
      ============================
      RESIZE HANDLER
      ============================
    */
    window.addEventListener('resize', () => {
      const w = window.innerWidth;
      const h = window.innerHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    });

    /*
      ============================
      MAIN LOOP
      ============================
    */

    let lastTime = performance.now();

    function animate() {
      const now = performance.now();
      const delta = (now - lastTime) / 1000;
      lastTime = now;

      controls.update();
      updateSelectionVisuals(delta);
      drawMinimap();

      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }

    animate();

    // initial text language synced
    toggleLang(); // will switch to AR
    toggleLang(); // and back to EN (so both strings seeded)
  </script>
</body>
</html>
