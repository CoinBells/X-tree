<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Oil Facility Training Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }

    header {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      padding: 14px 16px;
      border-bottom: 1px solid #1f2933;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    header h1 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
    }

    header .subtitle {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    #progressBarOuter {
      width: 220px;
      max-width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid #1f2937;
    }

    #progressBarInner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      transition: width 0.25s ease-out;
    }

    #layout {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.6fr);
      min-height: calc(100vh - 60px);
      gap: 0;
    }

    @media (max-width: 800px) {
      #layout {
        grid-template-columns: minmax(0, 1fr);
        grid-template-rows: auto auto;
      }
    }

    /* Left side: facility cards */
    #facilityList {
      padding: 14px;
      border-left: 1px solid #111827;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
    }

    .listTitle {
      font-size: 0.85rem;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    .cardsGrid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }

    @media (max-width: 620px) {
      .cardsGrid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .facilityCard {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 10px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: transform 0.16s ease-out, box-shadow 0.16s ease-out,
                  border-color 0.16s ease-out, background 0.16s ease-out;
    }

    .facilityCard:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.45);
      border-color: #38bdf8;
      background: radial-gradient(circle at top, #0f172a 0, #020617 70%);
    }

    .facilityCard.active {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }

    .facilityCard.completed::after {
      content: "✓ تم الإنجاز";
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 0.65rem;
      color: #22c55e;
      background: rgba(22, 163, 74, 0.1);
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(22, 163, 74, 0.5);
    }

    .facilityName {
      font-size: 0.9rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .facilityTag {
      font-size: 0.7rem;
      opacity: 0.8;
      margin-bottom: 6px;
    }

    .facilityMeta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 0.65rem;
      opacity: 0.75;
    }

    .chip {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.7);
    }

    /* Right side: details / quiz */
    #detailPanel {
      padding: 16px;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #030712 100%);
    }

    #detailTitle {
      font-size: 1rem;
      margin: 0 0 4px;
      font-weight: 700;
    }

    #detailType {
      font-size: 0.75rem;
      opacity: 0.75;
      margin-bottom: 8px;
    }

    #detailDescription {
      font-size: 0.8rem;
      line-height: 1.6;
      margin-bottom: 10px;
      color: #e5e7eb;
    }

    #topicList {
      list-style: none;
      padding: 0;
      margin: 0 0 12px;
      font-size: 0.78rem;
    }

    #topicList li {
      margin-bottom: 4px;
      padding-left: 0.8rem;
      position: relative;
    }

    #topicList li::before {
      content: "•";
      position: absolute;
      right: 0;
      color: #38bdf8;
      font-size: 0.9rem;
    }

    .sectionTitle {
      font-size: 0.8rem;
      margin: 10px 0 4px;
      font-weight: 600;
      opacity: 0.9;
    }

    #quizArea {
      margin-top: 4px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.8);
    }

    #quizQuestion {
      font-size: 0.8rem;
      margin-bottom: 8px;
    }

    .quizOption {
      margin-bottom: 4px;
      font-size: 0.78rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .quizOption input {
      cursor: pointer;
    }

    .quizOption label {
      flex: 1;
      cursor: pointer;
    }

    #quizActions {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-start;
    }

    button {
      border: none;
      outline: none;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.78rem;
      cursor: pointer;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      color: #020617;
      font-weight: 600;
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, opacity 0.12s;
      white-space: nowrap;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.6);
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    #quizStatus {
      font-size: 0.75rem;
      min-height: 1.1em;
    }

    #globalStatus {
      font-size: 0.8rem;
      margin-top: 8px;
      opacity: 0.9;
    }

    #hintBox {
      margin-top: 8px;
      font-size: 0.75rem;
      padding: 8px;
      border-radius: 8px;
      border: 1px dashed #1f2937;
      background: rgba(15, 23, 42, 0.7);
      color: #cbd5f5;
    }

    a {
      color: #38bdf8;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<header>
  <div>
    <h1>Oil Facility Training Game</h1>
    <div class="subtitle">منشأة تدريب تفاعلية لمشغلي KOC (نسخة HTML جاهزة لـ GitHub)</div>
  </div>
  <div>
    <div style="font-size:0.7rem; margin-bottom:4px; text-align:left;">Progress</div>
    <div id="progressBarOuter">
      <div id="progressBarInner"></div>
    </div>
  </div>
</header>

<main id="layout">
  <!-- Left: facility cards -->
  <section id="facilityList">
    <div class="listTitle">اختر المنشأة وابدأ المهمات التدريبية:</div>
    <div class="cardsGrid" id="cardsGrid"></div>

    <div id="globalStatus"></div>
  </section>

  <!-- Right: details / quiz -->
  <section id="detailPanel">
    <h2 id="detailTitle">اضغط على أي منشأة من اليسار للبدء</h2>
    <div id="detailType"></div>
    <p id="detailDescription"></p>

    <div id="topicsBlock" style="display:none;">
      <div class="sectionTitle">عناصر رئيسية في هذه المنشأة:</div>
      <ul id="topicList"></ul>
    </div>

    <div id="quizArea" style="display:none;">
      <div class="sectionTitle">سؤال تدريب على المنشأة:</div>
      <div id="quizQuestion"></div>
      <div id="quizOptions"></div>
      <div id="quizActions">
        <button id="checkBtn">تحقق من الإجابة</button>
        <button id="resetBtn" type="button">إعادة المحاولة</button>
        <span id="quizStatus"></span>
      </div>
    </div>

    <div id="hintBox" style="display:none;"></div>
  </section>
</main>

<script>
  // تعريف بيانات المنشآت (مبنية على ملفات KOC التدريبية بشكل مبسط)
  const facilities = [
    {
      id: "mainPlant",
      name: "Main Plant – Gathering Center",
      type: "منشأة رئيسية لمعالجة النفط والغاز والأنظمة المساندة",
      description:
        "هنا تبدأ الرحلة: تجميع النفط والغاز من الآبار، فصل الغاز، التحكم في الضغط، وأنظمة الصمامات و الـ ESD قبل ما يروح أي شيء للمنشآت الأخرى.",
      topics: [
        "أنواع الصمامات: Gate, Ball, Plug, Butterfly, Check, Relief.",
        "خطوط الجذر الرئيسية للنفط والغاز من الـ Inlet Manifold حتى الخزانات والمشاعل.",
        "أنظمة التحكم و الـ ESD و Fire & Gas."
      ],
      quiz: {
        question:
          "لماذا نستخدم Relief Valve (PSV) على الأوعية والخطوط عالية الضغط في الـ Main Plant؟",
        options: [
          "لزيادة الضغط داخل الوعاء بشكل أسرع",
          "لحماية المعدة من الضغط الزائد بتفريغ جزء من المحتوى بأمان",
          "لإغلاق الخط تماماً أثناء الصيانة فقط",
          "لتغيير اتجاه تدفق النفط إلى خزان آخر"
        ],
        correctIndex: 1,
        explanation:
          "الـ Relief Valve صمام أمان يفتح تلقائياً إذا تعدى الضغط الحد المصمم للمعدة، فيفرّغ جزء من السائل/الغاز إلى مكان آمن ويمنع الانفجار."
      },
      hint:
        "تذكر أن Design Pressure هو أعلى ضغط تتحمله المعدة، والـ PSV مضبوط على هذا الحد لحمايتها.  [oai_citation:0‡Main Plant.pdf](sediment://file_00000000691071fda71c3aa39cd5a72a)"
    },
    {
      id: "wetOil",
      name: "Wet Oil Treatment Facility (DDP)",
      type: "منشأة نزع الماء والملح من النفط (Dehydration & Desalting)",
      description:
        "هنا يتم معالجة النفط الرطب اللي يجي من الآبار: إزالة الماء والملح لحماية المعدات وتقليل التآكل وتحسين جودة الخام قبل التصدير.",
      topics: [
        "Desalter / Dehydrator يعالج المستحلب بين النفط والماء.",
        "استخدام Wash Water + Chemicals لكسر الـ Emulsion.",
        "Effluent Water System للتخلص من المياه المنتجة بعد المعالجة."
      ],
      quiz: {
        question:
          "ليش وجود ماء وملح عالي في النفط خطير على المنشأة؟",
        options: [
          "يزيد من رقم الـ API ويخلي النفط أخف",
          "يسبب تآكل في المعدات، فقدان طاقة إنتاجية، وزيادة التكلفة",
          "فقط يخفض درجة حرارة النفط بدون أي مشاكل أخرى",
          "يؤثر على لون النفط فقط"
        ],
        correctIndex: 1,
        explanation:
          "الماء المالح داخل النفط يسبب تآكل، مشاكل سلامة، خسارة سعة إنتاجية، وتكاليف صيانة وتشغيل أعلى، عشان كذا نركب DDP داخل الـ GC."
      },
      hint:
        "شوف مقدمة Wet Oil Treatment، موضح فيها تأثير المياه المالحة على التآكل والسلامة والتكلفة وجودة المنتج.  [oai_citation:1‡Wet Oil Treatment Facility.pdf](sediment://file_00000000157471fd9a1911ee8cbdb1ec)"
    },
    {
      id: "tvCompression",
      name: "TV Compression Facility (CRU + TV Comp.)",
      type: "منشأة ضغط واسترجاع غاز الـ Tank Vapor (TV)",
      description:
        "هنا يتم ضغط غاز الخزانات (TV Gas) وتحويله لمكثفات واسترجاعه بدل ما يروح فلير، عن طريق CRU والـ TV Compressors.",
      topics: [
        "CRU: ضغط الغاز الثقيل، تبريد، تكثيف، وإرجاع المكثفات إلى المنظومة.",
        "TV Compressor جديد (Centrifugal / Screw) لرفع ضغط الغاز وإرساله للـ BS أو LPG.",
        "تقليل الفلير وتحسين السلامة وحماية البيئة."
      ],
      quiz: {
        question:
          "إيش الفائدة الأساسية من TV Compression Facility؟",
        options: [
          "زيادة مستوى النفط في الخزانات",
          "ضغط غاز الخزانات (TV Gas) واسترجاعه كمكثفات وتقليل الفلير",
          "تسخين الغاز قبل ما يدخل الفلير",
          "فصل الماء عن النفط فقط"
        ],
        correctIndex: 1,
        explanation:
          "المنشأة مصممة لضغط غاز الخزانات منخفض الضغط، تكثيفه، وإرجاعه كـ Condensate لزيادة الاستفادة وتقليل حرق الغاز في المشاعل."
      },
      hint:
        "راجع مقدمة TV Compression Facility وشرح CRU/TV Gas الموجود في بداية الملف.  [oai_citation:2‡TV Compression Facility Draft 7-1-18 1.pdf](sediment://file_000000003d0871fdab513bd86d548a6f)"
    },
    {
      id: "transit",
      name: "Crude Oil Transit Facility",
      type: "منشأة تصدير الخام من الـ GC إلى CMM ثم الخزانات",
      description:
        "آخر مرحلة في الرحلة: ضخ الخام الجاف من الخزانات عبر مضخات الترانزيت (Gas Turbine, VSD, أو Electric) إلى Central Mixing Manifold.",
      topics: [
        "Dry/Dual Tanks مزودة بمستوى تشغيلي ثابت وسويتشات حماية Low Level.",
        "Booster Pumps + Main Transit Pumps لرفع الضغط حتى خط التصدير.",
        "وصلات من كل GC إلى CMM ثم إلى South/ North Tank Farms."
      ],
      quiz: {
        question:
          "ليش نحتاج مضخات Transit بضغط عالي بين الـ GC و CMM؟",
        options: [
          "عشان نخفض الضغط في الخزانات",
          "لتجاوز الفواقد في الخطوط والمسافة ورفع الضغط حتى يوصل الخام للـ CMM والخزانات",
          "فقط لتبريد الخام قبل التصدير",
          "لزيادة نسبة الماء في الخام"
        ],
        correctIndex: 1,
        explanation:
          "خطوط الترانزيت طويلة وفيها فرق ضغط وارتفاع، فلازم مضخات عالية الضغط عشان توصل التدفق المطلوب من الـ GC إلى CMM والخزانات."
      },
      hint:
        "شوف مقدمة Crude Oil Transit Facility وجدول وحدات التصدير في كل GC وشرح Turbine/VSD/Electric Pumps.  [oai_citation:3‡Crude Oil Transit Facility 1.pdf](sediment://file_00000000ecd071fd82999afd2b24ed42)"
    }
  ];

  const cardsGrid = document.getElementById("cardsGrid");
  const detailTitle = document.getElementById("detailTitle");
  const detailType = document.getElementById("detailType");
  const detailDescription = document.getElementById("detailDescription");
  const topicsBlock = document.getElementById("topicsBlock");
  const topicList = document.getElementById("topicList");
  const quizArea = document.getElementById("quizArea");
  const quizQuestion = document.getElementById("quizQuestion");
  const quizOptions = document.getElementById("quizOptions");
  const quizStatus = document.getElementById("quizStatus");
  const checkBtn = document.getElementById("checkBtn");
  const resetBtn = document.getElementById("resetBtn");
  const hintBox = document.getElementById("hintBox");
  const progressBarInner = document.getElementById("progressBarInner");
  const globalStatus = document.getElementById("globalStatus");

  let activeFacilityId = null;
  const completed = {};

  function renderCards() {
    cardsGrid.innerHTML = "";
    facilities.forEach(fac => {
      const card = document.createElement("article");
      card.className = "facilityCard";
      card.dataset.id = fac.id;

      const nameEl = document.createElement("div");
      nameEl.className = "facilityName";
      nameEl.textContent = fac.name;
      card.appendChild(nameEl);

      const tagEl = document.createElement("div");
      tagEl.className = "facilityTag";
      tagEl.textContent = fac.type;
      card.appendChild(tagEl);

      const meta = document.createElement("div");
      meta.className = "facilityMeta";

      const chip1 = document.createElement("span");
      chip1.className = "chip";
      chip1.textContent = "مهمة تدريبية";

      const chip2 = document.createElement("span");
      chip2.className = "chip";
      chip2.textContent = "سؤال واحد + شرح";

      meta.appendChild(chip1);
      meta.appendChild(chip2);
      card.appendChild(meta);

      card.addEventListener("click", () => selectFacility(fac.id));

      if (completed[fac.id]) {
        card.classList.add("completed");
      }
      if (activeFacilityId === fac.id) {
        card.classList.add("active");
      }

      cardsGrid.appendChild(card);
    });
  }

  function selectFacility(id) {
    activeFacilityId = id;
    const fac = facilities.find(f => f.id === id);
    if (!fac) return;

    document
      .querySelectorAll(".facilityCard")
      .forEach(c => c.classList.remove("active"));
    const activeCard = document.querySelector('.facilityCard[data-id="' + id + '"]');
    if (activeCard) activeCard.classList.add("active");

    detailTitle.textContent = fac.name;
    detailType.textContent = fac.type;
    detailDescription.textContent = fac.description;

    topicList.innerHTML = "";
    fac.topics.forEach(t => {
      const li = document.createElement("li");
      li.textContent = t;
      topicList.appendChild(li);
    });
    topicsBlock.style.display = "block";

    // render quiz
    quizArea.style.display = "block";
    quizQuestion.textContent = fac.quiz.question;
    quizOptions.innerHTML = "";
    fac.quiz.options.forEach((opt, idx) => {
      const idStr = `opt_${fac.id}_${idx}`;

      const wrapper = document.createElement("div");
      wrapper.className = "quizOption";

      const input = document.createElement("input");
      input.type = "radio";
      input.name = "quiz_" + fac.id;
      input.id = idStr;
      input.value = idx;

      const label = document.createElement("label");
      label.htmlFor = idStr;
      label.textContent = opt;

      wrapper.appendChild(input);
      wrapper.appendChild(label);
      quizOptions.appendChild(wrapper);
    });

    quizStatus.textContent = "";
    hintBox.style.display = "none";
    hintBox.textContent = "";

    checkBtn.disabled = false;
  }

  function updateProgress() {
    const total = facilities.length;
    const done = Object.keys(completed).length;
    const ratio = (done / total) * 100;
    progressBarInner.style.width = ratio + "%";

    if (done === 0) {
      globalStatus.textContent = "ما بديت لسه، اختر منشأة من القائمة وابدأ أول مهمة.";
    } else if (done < total) {
      globalStatus.textContent = `أنجزت ${done} من ${total} منشآت. كمل الباقي عشان تخلص اللعبة.`;
    } else {
      globalStatus.textContent =
        "مبروك! أنجزت جميع المنشآت الأربع. تقدر تعيد الأسئلة أو تطور اللعبة بنفسك (HTML/JS فقط).";
    }
  }

  checkBtn.addEventListener("click", () => {
    if (!activeFacilityId) return;
    const fac = facilities.find(f => f.id === activeFacilityId);
    if (!fac) return;

    const selected = document.querySelector(
      'input[name="quiz_' + fac.id + '"]:checked'
    );
    if (!selected) {
      quizStatus.style.color = "#f97316";
      quizStatus.textContent = "اختر إجابة أولاً.";
      return;
    }

    const index = Number(selected.value);
    if (index === fac.quiz.correctIndex) {
      quizStatus.style.color = "#22c55e";
      quizStatus.textContent = "إجابة صحيحة ✔";
      hintBox.style.display = "block";
      hintBox.textContent = fac.quiz.explanation;
      completed[fac.id] = true;
      renderCards();
      updateProgress();
      checkBtn.disabled = true;
    } else {
      quizStatus.style.color = "#f97316";
      quizStatus.textContent = "الإجابة غير صحيحة، جرّب مرة ثانية أو اضغط إعادة المحاولة.";
      hintBox.style.display = "block";
      hintBox.textContent =
        "فكر في الهدف الرئيسي من هذه المنشأة في الواقع، مو في خيار واحد من الجمل.";
    }
  });

  resetBtn.addEventListener("click", () => {
    if (!activeFacilityId) return;
    const fac = facilities.find(f => f.id === activeFacilityId);
    if (!fac) return;

    document
      .querySelectorAll('input[name="quiz_' + fac.id + '"]')
      .forEach(el => (el.checked = false));

    quizStatus.textContent = "";
    hintBox.style.display = "none";
    hintBox.textContent = "";
    checkBtn.disabled = false;
  });

  // initial
  renderCards();
  updateProgress();
</script>

</body>
</html>
