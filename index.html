<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KOC Facility 3D Training</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      width:100%;
      height:100%;
      overflow:hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#020617;
      color:#e5e7eb;
    }

    #canvas-container {
      position:fixed;
      inset:0;
      z-index:0;
    }

    #ui-root {
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:1;
    }

    .panel {
      pointer-events:auto;
      background:rgba(15,23,42,0.94);
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.45);
      box-shadow:0 18px 50px rgba(0,0,0,0.7);
      backdrop-filter:blur(14px);
      -webkit-backdrop-filter:blur(14px);
    }

    #hud {
      position:absolute;
      top:10px;
      left:10px;
      padding:8px 11px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
    }
    #hud-dot {
      width:8px;
      height:8px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 10px #22c55e;
    }
    #hud-title {
      font-weight:600;
    }
    #hud-sub {
      font-size:10px;
      color:#9ca3af;
    }

    #info-panel {
      position:absolute;
      top:10px;
      right:10px;
      width:320px;
      max-width:92vw;
      padding:12px 14px;
      font-size:12px;
    }
    #info-title {
      font-size:14px;
      font-weight:600;
      margin-bottom:4px;
    }
    #info-tag {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      background:rgba(56,189,248,0.15);
      border:1px solid rgba(56,189,248,0.6);
      color:#e0f2fe;
      margin-bottom:6px;
    }
    #info-description {
      line-height:1.5;
      margin-bottom:6px;
    }
    #info-points {
      font-size:11px;
      line-height:1.5;
      color:#d1d5db;
    }
    #info-footer {
      margin-top:6px;
      font-size:10px;
      color:#9ca3af;
    }

    #hint {
      position:absolute;
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      padding:6px 12px;
      border-radius:999px;
      background:rgba(0,0,0,0.65);
      border:1px solid rgba(148,163,184,0.5);
      font-size:11px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:center;
    }
    #hint span { opacity:0.9; }

    #legend {
      position:absolute;
      bottom:10px;
      left:10px;
      padding:8px 10px;
      font-size:11px;
    }
    #legend-title {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:#bfdbfe;
      margin-bottom:4px;
    }
    .legend-row {
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:3px;
    }
    .legend-color {
      width:10px;
      height:10px;
      border-radius:3px;
    }

    @media (max-width:640px) {
      #info-panel {
        width:94vw;
        right:3vw;
        top:auto;
        bottom:85px;
      }
      #legend {
        bottom:85px;
      }
    }
  </style>
</head>
<body>
  <div id="canvas-container"></div>

  <div id="ui-root">
    <div id="hud" class="panel">
      <div id="hud-dot"></div>
      <div>
        <div id="hud-title">Facility: Overview</div>
        <div id="hud-sub">Training Mode · Tap any colored block to view its details</div>
      </div>
    </div>

    <div id="info-panel" class="panel">
      <div id="info-title">Tap any unit in the facility</div>
      <div id="info-tag">NO EQUIPMENT SELECTED</div>
      <div id="info-description">
        Use one finger to rotate, two fingers to zoom / move.<br>
        اضغط على أي بلوك ملوّن في المنشأة لعرض اسم المعدة ووظيفتها ومسار الفلو.
      </div>
      <div id="info-points">
        • TV Compression, Wet Oil Treatment, Main Plant, and Transit are shown as 3D pads.<br>
        • Each colored block represents a real equipment group in KOC facilities.<br>
        • Rotate the camera to explore the whole plant layout.
      </div>
      <div id="info-footer">No unit selected.</div>
    </div>

    <div id="legend" class="panel">
      <div id="legend-title">Facility Zones</div>
      <div class="legend-row">
        <div class="legend-color" style="background:#22d3ee;"></div><span>TV Compression / CRU</span>
      </div>
      <div class="legend-row">
        <div class="legend-color" style="background:#22c55e;"></div><span>Wet Oil Treatment (DDP)</span>
      </div>
      <div class="legend-row">
        <div class="legend-color" style="background:#f97316;"></div><span>Main Plant</span>
      </div>
      <div class="legend-row">
        <div class="legend-color" style="background:#6366f1;"></div><span>Crude Transit</span>
      </div>
    </div>

    <div id="hint" class="panel">
      <span>Rotate: drag</span>
      <span>Zoom: pinch / scroll</span>
      <span>Move: two-finger drag</span>
      <span>Select: tap equipment block</span>
    </div>
  </div>

  <!-- THREE.JS + ORBITCONTROLS من CDN كلاسيكي (بدون module) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/controls/OrbitControls.min.js"></script>

  <script>
    // تأكد أن المكتبات تحمّلت
    if (!window.THREE || !THREE.OrbitControls) {
      document.getElementById('info-description').innerHTML =
        'Three.js أو OrbitControls لم يتم تحميلها من CDN.<br>' +
        'تأكد من أن الموقع <b>cdnjs.cloudflare.com</b> غير محجوب في الشبكة.';
      throw new Error('Three.js / OrbitControls not loaded');
    }

    // عنصر الـ canvas
    var container = document.getElementById('canvas-container');

    // مشهد
    var scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020617);

    // كاميرا
    var camera = new THREE.PerspectiveCamera(
      60,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 70, 140);

    // Renderer
    var renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);

    // تحكم الكاميرا
    var controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.target.set(0, 10, 0);
    controls.update();

    // إضاءة
    var hemiLight = new THREE.HemisphereLight(0x93c5fd, 0x020617, 0.9);
    scene.add(hemiLight);

    var dirLight = new THREE.DirectionalLight(0xffffff, 1.6);
    dirLight.position.set(60, 100, 40);
    scene.add(dirLight);

    // أرضية + Grid
    var groundGeo = new THREE.PlaneGeometry(260, 260);
    var groundMat = new THREE.MeshStandardMaterial({
      color: 0x020617,
      roughness: 1,
      metalness: 0
    });
    var ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    var grid = new THREE.GridHelper(260, 26, 0x4b5563, 0x1f2937);
    scene.add(grid);

    // بيانات المنشآت
    var facilities = {
      tv:   { id:'tv',   name:'TV Compression / CRU',                 color:0x22d3ee, x:-60, z:-60 },
      ddp:  { id:'ddp',  name:'Wet Oil Treatment (DDP / Desalter)',  color:0x22c55e, x: 60, z:-60 },
      main: { id:'main', name:'Main Plant (Separators / Tanks)',     color:0xf97316, x:-60, z: 60 },
      tr:   { id:'tr',   name:'Crude Transit Pumps & Export Header', color:0x6366f1, x: 60, z: 60 }
    };

    // بلوكات المعدات
    var equipmentData = [
      // TV / CRU
      {
        id:'tv_tanks',
        fac:'tv',
        name:'Wet / Dual / Dry Tanks (TV Source)',
        arabic:'خزانات Wet / Dual / Dry – مصدر غاز TV',
        type:'Storage Tanks',
        pos:{x:-80,y:5,z:-80},
        size:{x:16,y:8,z:16},
        color:0x38bdf8,
        desc:
          'Tank vapor (TV gas) is generated in wet/dual/dry tanks at very low pressure. ' +
          'The gas collects at the tank dome and flows to the TV gas main header.',
        notes:[
          'Source of heavy C3–C5 tank vapor gas.',
          'Connected to a large TV gas header feeding CRU / TV compressors.',
          'Tank pressure kept slightly positive by pressurizing gas.'
        ]
      },
      {
        id:'tv_cru',
        fac:'tv',
        name:'CRU Reciprocating Compressors',
        arabic:'ضواغط CRU الترددية',
        type:'Reciprocating Compressors',
        pos:{x:-60,y:5,z:-50},
        size:{x:18,y:7,z:14},
        color:0x0284c7,
        desc:
          'CRU raises TV gas pressure in several stages. ' +
          'Liquids are condensed and lean gas is routed to HP gas system.',
        notes:[
          'Suction from TV gas header via scrubber.',
          'Three-stage compression with intercoolers and scrubbers.',
          'Condensate routed back to crude system, lean gas to HP header.'
        ]
      },
      {
        id:'tv_new',
        fac:'tv',
        name:'New TV Compressor (Centrifugal)',
        arabic:'ضاغط TV الجديد (طارد مركزي)',
        type:'Centrifugal Compressor',
        pos:{x:-40,y:5,z:-80},
        size:{x:16,y:7,z:12},
        color:0x22d3ee,
        desc:
          'New TV compressor handles most TV gas load and reduces flaring. ' +
          'CRU remains as backup in modern gathering centers.',
        notes:[
          'Takes TV gas from main header through ESDV.',
          'Multi-stage centrifugal compression.',
          'Discharge routed to HP gas / fuel gas systems.'
        ]
      },

      // WET OIL / DDP
      {
        id:'ddp_inlet',
        fac:'ddp',
        name:'Wet Oil Inlet / Emulsion Header',
        arabic:'هيدر دخول النفط الرطب (Emulsion)',
        type:'Production Emulsion',
        pos:{x:40,y:5,z:-80},
        size:{x:16,y:7,z:14},
        color:0x16a34a,
        desc:
          'Wet crude with water and salts enters the DDP area through an emulsion header.',
        notes:[
          'Free water removed earlier in separators and wet tanks.',
          'Emulsified water droplets still trapped in crude.',
          'This header feeds heaters and desalter vessels.'
        ]
      },
      {
        id:'ddp_heaters',
        fac:'ddp',
        name:'Crude Heaters',
        arabic:'سخانات النفط',
        type:'Heating Section',
        pos:{x:60,y:5,z:-50},
        size:{x:18,y:7,z:14},
        color:0x4ade80,
        desc:
          'Heaters raise crude temperature (around 140–160°F) to help chemical and wash water break the emulsion.',
        notes:[
          'Lower viscosity and better mixing.',
          'Too much heat increases scaling and cost.',
          'Feed outlet goes to desalter feed pumps.'
        ]
      },
      {
        id:'ddp_desalters',
        fac:'ddp',
        name:'Desalter Vessels',
        arabic:'أوعية Desalter',
        type:'Desalting / Dehydration',
        pos:{x:80,y:6,z:-70},
        size:{x:18,y:8,z:16},
        color:0x22c55e,
        desc:
          'Electrostatic desalter vessels remove salty formation water from crude using wash water and electric grids.',
        notes:[
          'Wash water (3–8%) with low salinity is injected.',
          'Mixing valve creates pressure drop for good distribution.',
          'Separated water leaves from bottom to water treatment.'
        ]
      },

      // MAIN PLANT
      {
        id:'main_seps',
        fac:'main',
        name:'HP / LP Separators',
        arabic:'فواصل HP / LP',
        type:'Three-phase Separators',
        pos:{x:-80,y:5,z:40},
        size:{x:18,y:7,z:16},
        color:0xf97316,
        desc:
          'Separators split production into gas, oil and water phases at controlled pressures.',
        notes:[
          'HP and LP gas outlets to gas headers.',
          'Oil leaves towards wet oil treatment and tanks.',
          'Water goes to produced water handling.'
        ]
      },
      {
        id:'main_tanks',
        fac:'main',
        name:'Wet / Dual / Dry Tanks (Main Plant)',
        arabic:'خزانات Wet / Dual / Dry بالمحطة الرئيسية',
        type:'Storage / Surge',
        pos:{x:-60,y:6,z:80},
        size:{x:20,y:8,z:16},
        color:0xfbbf24,
        desc:
          'Tanks provide surge capacity and separation. Dry tanks store treated crude ready for export.',
        notes:[
          'Tank vapor routed to TV compression facility.',
          'Dry tank level interlocks protect transit pumps.',
          'Equalizing lines keep levels balanced.'
        ]
      },
      {
        id:'main_pressGas',
        fac:'main',
        name:'Pressurizing Gas System',
        arabic:'نظام غاز الضغط',
        type:'Lean Gas Pressurizing',
        pos:{x:-40,y:5,z:50},
        size:{x:16,y:6,z:12},
        color:0xf97316,
        desc:
          'Lean gas is reduced and sent to tanks and fuel systems to keep them at positive pressure.',
        notes:[
          'Manual pressurizing valves to tanks normally kept open.',
          'Pressure control valves protect header from high pressure.',
          'Supports stable tank operation and reduces air ingress.'
        ]
      },

      // TRANSIT
      {
        id:'tr_dry',
        fac:'tr',
        name:'Dry Tank Outlet / Suction Header',
        arabic:'مخرج خزان Dry وهيدر السحب',
        type:'Suction Header',
        pos:{x:40,y:5,z:80},
        size:{x:16,y:8,z:16},
        color:0x38bdf8,
        desc:
          'Dry tank outlet and common suction header feeding booster and main oil line pumps.',
        notes:[
          'Minimum level required before starting pumps.',
          'Suction MOV and manual valves must be open.',
          'Strainers installed to protect pumps.'
        ]
      },
      {
        id:'tr_booster',
        fac:'tr',
        name:'Booster Pump',
        arabic:'مضخة بوستر',
        type:'Vertical Booster Pump',
        pos:{x:60,y:5,z:60},
        size:{x:14,y:7,z:12},
        color:0x4f46e5,
        desc:
          'Booster pump increases crude pressure from tank level to a suitable suction pressure for the main oil line pump.',
        notes:[
          'Equipped with minimum-flow recycle line.',
          'Priming and vent connections at suction.',
          'Discharge tied directly to MOL pump suction.'
        ]
      },
      {
        id:'tr_mol',
        fac:'tr',
        name:'Main Oil Line Pump (Transit)',
        arabic:'مضخة Main Oil Line',
        type:'Transit Main Pump',
        pos:{x:80,y:5,z:50},
        size:{x:16,y:7,z:12},
        color:0x818cf8,
        desc:
          'Main oil line pump sends treated crude to the crude export / transit line towards CMM or tank farms.',
        notes:[
          'High-capacity centrifugal pump (motor or turbine driven).',
          'Discharge pressure controlled by PCV / MOV to transit header.',
          'Critical equipment for crude export availability.'
        ]
      }
    ];

    // رسم Pads المنشآت
    function createFacilityPad(f) {
      var padGeo = new THREE.BoxGeometry(70, 3, 70);
      var padMat = new THREE.MeshStandardMaterial({
        color:f.color,
        metalness:0.3,
        roughness:0.5,
        emissive:new THREE.Color(f.color).multiplyScalar(0.18)
      });
      var pad = new THREE.Mesh(padGeo, padMat);
      pad.position.set(f.x, 1.5, f.z);
      pad.receiveShadow = true;
      pad.castShadow = true;
      scene.add(pad);

      // خط خفيف حول الباد
      var borderGeo = new THREE.EdgesGeometry(padGeo);
      var borderMat = new THREE.LineBasicMaterial({ color:0x0f172a });
      var border = new THREE.LineSegments(borderGeo, borderMat);
      border.position.copy(pad.position);
      scene.add(border);
    }

    for (var key in facilities) {
      createFacilityPad(facilities[key]);
    }

    // إنشاء مجسمات المعدات
    var selectable = [];
    var equipmentMeshMap = {};

    function createEquipmentBox(eq) {
      var geo = new THREE.BoxGeometry(eq.size.x, eq.size.y, eq.size.z);
      var mat = new THREE.MeshStandardMaterial({
        color:eq.color,
        metalness:0.4,
        roughness:0.35,
        emissive:new THREE.Color(eq.color).multiplyScalar(0.25)
      });
      var mesh = new THREE.Mesh(geo, mat);
      mesh.position.set(eq.pos.x, eq.pos.y, eq.pos.z);
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      mesh.userData.equipmentId = eq.id;
      mesh.userData.baseColor = new THREE.Color(eq.color);
      scene.add(mesh);

      // حلقة مضيئة فوق المعدة
      var ringGeo = new THREE.RingGeometry(eq.size.x*0.35, eq.size.x*0.5, 32);
      var ringMat = new THREE.MeshBasicMaterial({
        color:0xffffff,
        opacity:0.25,
        transparent:true,
        side:THREE.DoubleSide
      });
      var ring = new THREE.Mesh(ringGeo, ringMat);
      ring.rotation.x = -Math.PI/2;
      ring.position.set(eq.pos.x, eq.pos.y + eq.size.y*0.55, eq.pos.z);
      scene.add(ring);

      selectable.push(mesh);
      equipmentMeshMap[eq.id] = { mesh:mesh, ring:ring };
    }

    for (var i=0;i<equipmentData.length;i++){
      createEquipmentBox(equipmentData[i]);
    }

    // Raycaster للاختيار
    var raycaster = new THREE.Raycaster();
    var mouse = new THREE.Vector2();
    var lastSelectedId = null;
    var pulseTime = 0;

    function onClick(event) {
      var rect = renderer.domElement.getBoundingClientRect();
      var x = (event.clientX - rect.left) / rect.width;
      var y = (event.clientY - rect.top) / rect.height;
      mouse.x = x*2 - 1;
      mouse.y = -y*2 + 1;

      raycaster.setFromCamera(mouse, camera);
      var hits = raycaster.intersectObjects(selectable, false);
      if (hits.length > 0) {
        var eqId = hits[0].object.userData.equipmentId;
        selectEquipment(eqId);
      }
    }
    renderer.domElement.addEventListener('click', onClick);

    // تحديث شكل المعدة المختارة
    function updateSelectionVisuals(delta) {
      pulseTime += delta;
      var t = 0.6 + 0.3 * Math.sin(pulseTime * 3.0);

      for (var id in equipmentMeshMap) {
        var entry = equipmentMeshMap[id];
        if (id === lastSelectedId) {
          entry.mesh.material.emissiveIntensity = 0.9;
          entry.ring.material.opacity = 0.4 + 0.3*Math.sin(pulseTime*3.0);
          entry.ring.scale.set(1.05,1.05,1.05);
        } else {
          entry.mesh.material.emissiveIntensity = 0.3;
          entry.ring.material.opacity = 0.2;
          entry.ring.scale.set(1,1,1);
        }
      }
    }

    // تحديث لوحة المعلومات عند اختيار معدة
    var infoTitle       = document.getElementById('info-title');
    var infoTag         = document.getElementById('info-tag');
    var infoDesc        = document.getElementById('info-description');
    var infoPoints      = document.getElementById('info-points');
    var infoFooter      = document.getElementById('info-footer');
    var hudTitle        = document.getElementById('hud-title');

    function selectEquipment(id) {
      lastSelectedId = id;
      var eq = null;
      for (var i=0;i<equipmentData.length;i++){
        if (equipmentData[i].id === id) { eq = equipmentData[i]; break; }
      }
      if (!eq) return;

      var fac = facilities[eq.fac];

      infoTitle.textContent = eq.name + ' / ' + eq.arabic;
      infoTag.textContent = fac.name;
      infoDesc.textContent = eq.desc;
      infoPoints.innerHTML =
        '• ' + eq.notes.join('<br>• ');
      infoFooter.textContent = 'Selected unit: ' + eq.name + ' (tap another block to change).';

      hudTitle.textContent = 'Facility: ' + fac.name;

      // حرّك الكاميرا نحو المعدة (ببساطة)
      controls.target.set(eq.pos.x, eq.pos.y + 3, eq.pos.z);
      camera.position.set(eq.pos.x + 35, eq.pos.y + 30, eq.pos.z + 40);
      controls.update();
    }

    // ريسايز
    window.addEventListener('resize', function(){
      var w = window.innerWidth;
      var h = window.innerHeight;
      camera.aspect = w/h;
      camera.updateProjectionMatrix();
      renderer.setSize(w,h);
    });

    // حلقة الرسم
    var lastTime = performance.now();
    function animate(){
      requestAnimationFrame(animate);
      var now = performance.now();
      var delta = (now - lastTime) / 1000;
      lastTime = now;

      controls.update();
      updateSelectionVisuals(delta);

      renderer.render(scene, camera);
    }

    // تأكد أن المنشأة في النص من أول فتح
    camera.position.set(0, 80, 150);
    controls.target.set(0, 10, 0);
    controls.update();

    animate();
  </script>
</body>
</html>
