<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Oilfield Operator Training – Top-Down</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#020617;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:#f9fafb;
      overflow:hidden;
      direction:rtl;
    }

    #layout {
      display:flex;
      width:100vw;
      height:100vh;
    }

    #game-wrapper {
      flex:1 1 auto;
      position:relative;
      background:#020617;
    }

    #game {
      width:100%;
      height:100%;
      display:block;
    }

    /* لوحة البيانات على اليسار (أو يمين في RTL) */
    #ui-panel {
      width:320px;
      max-width:40vw;
      background:radial-gradient(circle at top,#020617,#020617 60%,#040b1a 100%);
      border-left:2px solid #1d4ed8;
      display:flex;
      flex-direction:column;
      padding:14px 12px;
      gap:10px;
    }

    .card {
      background:rgba(15,23,42,0.95);
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.4);
      padding:8px 10px;
      font-size:12px;
    }

    .card h3 {
      font-size:13px;
      margin-bottom:6px;
    }

    .grid2 {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:6px;
    }

    .stat-box {
      background:#020617;
      border-radius:10px;
      border:1px solid #1f2937;
      padding:6px;
    }

    .stat-label {
      font-size:11px;
      opacity:0.8;
    }

    .stat-value {
      font-size:16px;
      font-weight:700;
      margin-top:2px;
      text-shadow:0 0 6px rgba(59,130,246,0.9);
    }

    .tag {
      display:inline-block;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      margin-top:4px;
    }
    .tag-ok { background:rgba(22,163,74,0.18); color:#bbf7d0; border:1px solid #22c55e; }
    .tag-bad{ background:rgba(248,113,113,0.18); color:#fecaca; border:1px solid #f87171; }

    #well-name {
      font-weight:600;
      font-size:14px;
      margin-bottom:4px;
    }

    .btn {
      border-radius:999px;
      border:none;
      padding:7px 10px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      margin-top:4px;
      width:100%;
    }
    #btn-open {
      background:linear-gradient(90deg,#38bdf8,#6366f1);
      color:#fff;
    }
    #btn-clean {
      background:linear-gradient(90deg,#22c55e,#a3e635);
      color:#052e16;
    }
    #btn-clean.disabled {
      filter:grayscale(0.9);
      opacity:0.6;
      cursor:default;
    }

    #log {
      font-size:11px;
      max-height:160px;
      overflow-y:auto;
    }
    #log p { margin-bottom:3px; }

    #hud {
      position:absolute;
      top:8px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(15,23,42,0.92);
      border-radius:999px;
      padding:6px 14px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.5);
      white-space:nowrap;
      z-index:5;
    }

    #hint {
      position:absolute;
      bottom:8px;
      right:8px;
      background:rgba(15,23,42,0.92);
      border-radius:12px;
      padding:6px 10px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.5);
      max-width:260px;
      z-index:5;
    }

    /* أزرار لمس للموبايل */
    #touch-controls {
      position:absolute;
      bottom:12px;
      left:12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      z-index:6;
    }
    .tc-row { display:flex; gap:6px; }

    .tc-btn {
      width:48px;
      height:48px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background:rgba(15,23,42,0.95);
      color:#e5e7eb;
      font-size:20px;
      box-shadow:0 4px 10px rgba(0,0,0,0.7);
      touch-action:none;
      cursor:pointer;
    }
    .tc-btn:active { background:rgba(37,99,235,0.95); }

    .tc-btn-small {
      width:82px;
      font-size:12px;
    }

    @media (max-width:900px) {
      #ui-panel {
        width:260px;
        padding:10px 8px;
      }
      #hud { font-size:9px; padding:5px 10px; }
    }
  </style>
</head>
<body>
  <div id="layout">
    <div id="game-wrapper">
      <canvas id="game"></canvas>

      <div id="hud">
        تحكم الكمبيوتر: الأسهم / WASD للحركة – E فحص البئر – C تنظيف. موبايل: استخدم الأسهم وأزرار الفحص والتنظيف.
      </div>
      <div id="hint">
        أنت عامل في حقل نفطي (منظر علوي). تحرك في الخريطة، اقترب من أي بئر حتى يظهر تلميح الفحص،
        ثم اضغط <b>E</b> أو زر <b>فحص</b> لقراءة WHP / FLP وفتح ADJ BEAN وتنظيف الـ blockage.
      </div>

      <div id="touch-controls">
        <div class="tc-row">
          <button id="tc-up" class="tc-btn">↑</button>
        </div>
        <div class="tc-row">
          <button id="tc-left" class="tc-btn">←</button>
          <button id="tc-down" class="tc-btn">↓</button>
          <button id="tc-right" class="tc-btn">→</button>
        </div>
        <div class="tc-row">
          <button id="tc-inspect" class="tc-btn tc-btn-small">E فحص</button>
          <button id="tc-clean" class="tc-btn tc-btn-small">C تنظيف</button>
        </div>
      </div>
    </div>

    <aside id="ui-panel">
      <div class="card">
        <div id="well-name">لم يتم اختيار بئر</div>
        <div class="grid2">
          <div class="stat-box">
            <div class="stat-label">WHP (psi)</div>
            <div id="whp-val" class="stat-value">---</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">FLP (psi)</div>
            <div id="flp-val" class="stat-value">---</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">CASING</div>
            <div id="casing-val" class="stat-value">Closed</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">حالة البئر</div>
            <div id="state-val" class="stat-value">غير مفحوص</div>
            <div id="state-tag" class="tag tag-ok">Normal</div>
          </div>
        </div>
        <button id="btn-open" class="btn">فتح ADJ BEAN وقراءة الحالة</button>
        <button id="btn-clean" class="btn disabled">تنظيف الـ blockage من ADJ BEAN</button>
      </div>

      <div class="card">
        <h3>Training Objectives</h3>
        <ul style="padding-right:18px; line-height:1.4;">
          <li>التحرك في الحقل والوصول إلى عدة آبار.</li>
          <li>قراءة WHP / FLP لكل بئر وتحديد وجود Blockage.</li>
          <li>فتح ADJ BEAN للبئر الذي فيه Blockage.</li>
          <li>تنظيف الـ blockage وملاحظة تغيّر القراءات إلى حالة طبيعية.</li>
        </ul>
      </div>

      <div class="card">
        <h3>Log</h3>
        <div id="log"></div>
      </div>
    </aside>
  </div>

  <script>
    // إعداد الكانفس
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    function resize() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
    }
    window.addEventListener("resize", resize);
    resize();

    // عالم الحقل
    const world = {
      width: 2200,
      height: 1400
    };

    // العامل (Top-Down)
    const player = {
      x: 1100,
      y: 700,
      radius: 16,
      speed: 2.6
    };

    // آبار
    const wells = [
      { id:"AH-0117", x:900,  y:620, blockage:true,  cleaned:false },
      { id:"AH-0216", x:1300, y:540, blockage:false, cleaned:false },
      { id:"AH-0274", x:700,  y:900, blockage:true,  cleaned:false },
      { id:"AH-0287", x:1500, y:880, blockage:true,  cleaned:false },
      { id:"MG-0345", x:1150, y:1050, blockage:false, cleaned:false }
    ];

    let cameraX = 0;
    let cameraY = 0;

    const keys = { up:false, down:false, left:false, right:false };

    window.addEventListener("keydown", e => {
      if (e.key === "ArrowUp"   || e.key === "w" || e.key === "W") keys.up = true;
      if (e.key === "ArrowDown" || e.key === "s" || e.key === "S") keys.down = true;
      if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") keys.left = true;
      if (e.key === "ArrowRight"|| e.key === "d" || e.key === "D") keys.right = true;
      if (e.key === "e" || e.key === "E") inspectNearest();
      if (e.key === "c" || e.key === "C") cleanCurrent();
    });

    window.addEventListener("keyup", e => {
      if (e.key === "ArrowUp"   || e.key === "w" || e.key === "W") keys.up = false;
      if (e.key === "ArrowDown" || e.key === "s" || e.key === "S") keys.down = false;
      if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") keys.left = false;
      if (e.key === "ArrowRight"|| e.key === "d" || e.key === "D") keys.right = false;
    });

    // ربط أزرار لمس مع نفس المفاتيح
    function bindTouch(btnId, keyName) {
      const btn = document.getElementById(btnId);
      if (!btn) return;
      const start = e => { e.preventDefault(); keys[keyName] = true; };
      const end   = e => { e.preventDefault(); keys[keyName] = false; };
      btn.addEventListener("touchstart", start, {passive:false});
      btn.addEventListener("touchend",   end,   {passive:false});
      btn.addEventListener("touchcancel",end,   {passive:false});
      btn.addEventListener("mousedown",  start);
      window.addEventListener("mouseup", end);
    }

    bindTouch("tc-up","up");
    bindTouch("tc-down","down");
    bindTouch("tc-left","left");
    bindTouch("tc-right","right");

    document.getElementById("tc-inspect")
      .addEventListener("click", inspectNearest);
    document.getElementById("tc-inspect")
      .addEventListener("touchstart", e => { e.preventDefault(); inspectNearest(); });
    document.getElementById("tc-clean")
      .addEventListener("click", cleanCurrent);
    document.getElementById("tc-clean")
      .addEventListener("touchstart", e => { e.preventDefault(); cleanCurrent(); });

    const wellNameEl = document.getElementById("well-name");
    const whpEl      = document.getElementById("whp-val");
    const flpEl      = document.getElementById("flp-val");
    const casingEl   = document.getElementById("casing-val");
    const stateEl    = document.getElementById("state-val");
    const stateTag   = document.getElementById("state-tag");
    const btnOpen    = document.getElementById("btn-open");
    const btnClean   = document.getElementById("btn-clean");
    const logEl      = document.getElementById("log");

    let currentWell = null;

    function log(msg) {
      const p = document.createElement("p");
      p.textContent = msg;
      logEl.prepend(p);
    }

    function calcPressures(well) {
      if (well.blockage && !well.cleaned) {
        return {
          whp: 420 + Math.floor(Math.random()*20),
          flp: 120 + Math.floor(Math.random()*15),
          bad: true,
          text: "Blockage محتمل / مؤكد"
        };
      } else {
        return {
          whp: 260 + Math.floor(Math.random()*15),
          flp: 240 + Math.floor(Math.random()*15),
          bad: false,
          text: "تدفق طبيعي"
        };
      }
    }

    function updateUIForWell(well) {
      if (!well) {
        wellNameEl.textContent = "لم يتم اختيار بئر";
        whpEl.textContent = "---";
        flpEl.textContent = "---";
        casingEl.textContent = "Closed";
        stateEl.textContent = "غير مفحوص";
        stateTag.textContent = "Normal";
        stateTag.className = "tag tag-ok";
        btnClean.classList.add("disabled");
        return;
      }

      const p = calcPressures(well);
      wellNameEl.textContent = "بئر " + well.id;
      whpEl.textContent = p.whp + " psi";
      flpEl.textContent = p.flp + " psi";
      casingEl.textContent = "Closed";
      stateEl.textContent = p.text;
      if (p.bad) {
        stateTag.textContent = "Blockage";
        stateTag.className = "tag tag-bad";
        btnClean.classList.remove("disabled");
      } else {
        stateTag.textContent = "Normal";
        stateTag.className = "tag tag-ok";
        btnClean.classList.add("disabled");
      }
    }

    function getNearestWell() {
      const maxDist = 80;
      let best = null;
      let bestDist = maxDist;
      for (const w of wells) {
        const dx = player.x - w.x;
        const dy = player.y - w.y;
        const d = Math.hypot(dx, dy);
        if (d < bestDist) {
          bestDist = d;
          best = w;
        }
      }
      return best;
    }

    function inspectNearest() {
      const w = getNearestWell();
      if (!w) {
        log("لا يوجد بئر قريب للفحص. اقترب أكثر من أحد الآبار.");
        return;
      }
      currentWell = w;
      log("فحص البئر " + w.id + " ...");
      updateUIForWell(w);
    }

    function cleanCurrent() {
      if (!currentWell) return;
      if (!currentWell.blockage || currentWell.cleaned) return;
      currentWell.cleaned = true;
      log("تم تنظيف الـ blockage من ADJ BEAN للبئر " + currentWell.id + ".");
      updateUIForWell(currentWell);
    }

    btnOpen.addEventListener("click", () => {
      if (!currentWell) {
        inspectNearest();
        return;
      }
      const p = calcPressures(currentWell);
      whpEl.textContent = p.whp + " psi";
      flpEl.textContent = p.flp + " psi";
      stateEl.textContent = p.text;
      if (p.bad) {
        stateTag.textContent = "Blockage";
        stateTag.className = "tag tag-bad";
        btnClean.classList.remove("disabled");
        log("قراءة WHP/FLP للبئر " + currentWell.id + " تشير إلى Blockage محتمل.");
      } else {
        stateTag.textContent = "Normal";
        stateTag.className = "tag tag-ok";
        btnClean.classList.add("disabled");
        log("قراءة WHP/FLP للبئر " + currentWell.id + " طبيعية.");
      }
    });

    btnClean.addEventListener("click", cleanCurrent);

    log("تحرك في الخريطة، اقترب من بئر حتى ترى التلميح، ثم افحص ونظف.");

    // تحديث الحركة والكاميرا
    function update() {
      let dx = 0, dy = 0;
      if (keys.up) dy -= 1;
      if (keys.down) dy += 1;
      if (keys.left) dx -= 1;
      if (keys.right) dx += 1;

      if (dx !== 0 || dy !== 0) {
        const len = Math.hypot(dx, dy);
        dx /= len;
        dy /= len;
        player.x += dx * player.speed;
        player.y += dy * player.speed;
      }

      // حدود العالم
      player.x = Math.max(player.radius, Math.min(world.width - player.radius, player.x));
      player.y = Math.max(player.radius, Math.min(world.height - player.radius, player.y));

      // الكاميرا تتبع اللاعب
      cameraX = player.x - canvas.width/2;
      cameraY = player.y - canvas.height/2;
      cameraX = Math.max(0, Math.min(world.width - canvas.width, cameraX));
      cameraY = Math.max(0, Math.min(world.height - canvas.height, cameraY));
    }

    // رسم الخلفية (صحراوية مع بعض التفاصيل)
    function drawBackground() {
      const g = ctx.createLinearGradient(0,0,0,canvas.height);
      g.addColorStop(0,   "#7cc3ff");
      g.addColorStop(0.35,"#cde9ff");
      g.addColorStop(0.36,"#f7d9a0");
      g.addColorStop(1,   "#f0c27b");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // أسلاك سياج بسيطة
      ctx.strokeStyle = "rgba(15,23,42,0.3)";
      ctx.lineWidth = 1;
      for (let x=-cameraX % 120; x<canvas.width; x+=120) {
        const worldX = x + cameraX;
        const y1 = world.height*0.3 - cameraY;
        const y2 = y1 + 16;
        ctx.beginPath();
        ctx.moveTo(x,y1);
        ctx.lineTo(x,y2);
        ctx.stroke();
      }

      // رولات خطوط Flowline (زخرفة بسيطة)
      ctx.strokeStyle = "rgba(30,64,175,0.35)";
      ctx.lineWidth = 3;
      wells.forEach(w => {
        const sx = w.x - cameraX;
        const sy = w.y - cameraY;
        ctx.beginPath();
        ctx.moveTo(sx, sy);
        ctx.lineTo(sx + 80, sy + 6);
        ctx.stroke();
      });
    }

    function drawPlayer() {
      const sx = player.x - cameraX;
      const sy = player.y - cameraY;

      // ظل
      ctx.fillStyle = "rgba(0,0,0,0.28)";
      ctx.beginPath();
      ctx.ellipse(sx, sy+10, player.radius*0.9, player.radius*0.5, 0, 0, Math.PI*2);
      ctx.fill();

      // جسم
      ctx.fillStyle = "#facc15";
      ctx.beginPath();
      ctx.arc(sx, sy, player.radius, 0, Math.PI*2);
      ctx.fill();
      ctx.strokeStyle = "#92400e";
      ctx.lineWidth = 2;
      ctx.stroke();

      // خوذة
      ctx.fillStyle = "#fb923c";
      ctx.beginPath();
      ctx.arc(sx, sy-4, player.radius*0.8, Math.PI, 0);
      ctx.fill();
      ctx.strokeStyle = "#9a3412";
      ctx.lineWidth = 1.5;
      ctx.stroke();
    }

    function drawWells() {
      wells.forEach(w => {
        const sx = w.x - cameraX;
        const sy = w.y - cameraY;
        if (sx < -60 || sx > canvas.width+60 ||
            sy < -60 || sy > canvas.height+60) return;

        // قاعدة
        ctx.fillStyle = "#374151";
        ctx.beginPath();
        ctx.arc(sx, sy, 18, 0, Math.PI*2);
        ctx.fill();

        // X-Tree مبسط
        ctx.fillStyle = "#1d4ed8";
        ctx.fillRect(sx-5, sy-32, 10, 26); // vertical
        ctx.fillRect(sx-18, sy-20, 36, 8); // horizontal

        // ADJ BEAN / choke
        ctx.fillStyle = (w.blockage && !w.cleaned) ? "#f97373" : "#4ade80";
        ctx.fillRect(sx+20, sy-24, 16, 16);

        // إطار
        ctx.strokeStyle = "#eff6ff";
        ctx.lineWidth = 1.3;
        ctx.beginPath();
        ctx.arc(sx, sy, 22, 0, Math.PI*2);
        ctx.stroke();

        // اسم البئر فوقه
        ctx.fillStyle = "rgba(15,23,42,0.9)";
        ctx.beginPath();
        ctx.roundRect(sx-34, sy-52, 68, 18, 9);
        ctx.fill();
        ctx.fillStyle = "#e5e7eb";
        ctx.font = "10px system-ui";
        ctx.textAlign = "center";
        ctx.fillText(w.id, sx, sy-39);
        ctx.textAlign = "start";
      });
    }

    function drawNearHint() {
      const w = getNearestWell();
      if (!w) return;
      const sx = w.x - cameraX;
      const sy = w.y - cameraY - 60;
      ctx.fillStyle = "rgba(15,23,42,0.95)";
      ctx.beginPath();
      ctx.roundRect(sx-70, sy-16, 140, 22, 10);
      ctx.fill();
      ctx.fillStyle = "#e5e7eb";
      ctx.font = "11px system-ui";
      ctx.textAlign = "center";
      ctx.fillText("اضغط E لفحص البئر", sx, sy+1);
      ctx.textAlign = "start";
    }

    function loop() {
      update();
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawBackground();
      drawWells();
      drawPlayer();
      drawNearHint();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
